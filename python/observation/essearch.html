<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.0.0"/>
    <title>python.observation.essearch API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../observation.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;python.observation</a>

            <img src="https://loco-philippe.github.io/ES/logo_loco.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

        <h2>Contents</h2>
        <ul>
  <li><a href="#how-to-use-observationessearch">How to use observation.essearch ?</a></li>
</ul>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#insert_from_doc">insert_from_doc</a>
            </li>
            <li>
                    <a class="function" href="#insert_to_mongo">insert_to_mongo</a>
            </li>
            <li>
                    <a class="function" href="#empty_request">empty_request</a>
            </li>
            <li>
                    <a class="class" href="#ESSearch">ESSearch</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ESSearch.__init__">ESSearch</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.addInput">addInput</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.removeInputs">removeInputs</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.setHide">setHide</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.setHeavy">setHeavy</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.setSources">setSources</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.addConditions">addConditions</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.addCondition">addCondition</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.orCondition">orCondition</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.removeCondition">removeCondition</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.clearConditions">clearConditions</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.clear">clear</a>
                        </li>
                        <li>
                                <a class="variable" href="#ESSearch.request">request</a>
                        </li>
                        <li>
                                <a class="variable" href="#ESSearch.cursor">cursor</a>
                        </li>
                        <li>
                                <a class="function" href="#ESSearch.execute">execute</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
python<wbr>.<a href="./../observation.html">observation</a><wbr>.essearch    </h1>

                        <div class="docstring"><h1 id="how-to-use-observationessearch">How to use observation.essearch ?</h1>

<ol>
<li><p><strong>Create the MongoDB database:</strong>
You can easily create an account on MongoDB. Once you have a database, follow the guidelines <a href="https://www.mongodb.com/docs/atlas/tutorial/connect-to-your-cluster/#connect-to-your-atlas-cluster">here</a> to connect to it using pymongo.
All you need in order to be able to use this module is to be able to connect to the Collection with pymongo.</p></li>
<li><p><strong>Fill the database with your data:</strong>
Construct an observation or a list of observations containing your data using dedicated functions from <code>python.observation.Observation</code>. 
You can then use <code>insert_mongo(collection, observation)</code> to insert it in the database.</p></li>
<li><p><strong>Write a request using observation.ESSearch:</strong>
An <code><a href="#ESSearch">ESSearch</a></code> instance must be created with either a MongoDB Collection (passed as argument <strong>collection</strong>) or a list of observations (passed as argument <strong>data</strong>).
Criteria for the query are then added one by one using <code><a href="#ESSearch.addCondition">ESSearch.addCondition</a></code> or <code><a href="#ESSearch.orCondition">ESSearch.orCondition</a></code>, or all together with <code><a href="#ESSearch.addConditions">ESSearch.addConditions</a></code> or passed as argument <strong>parameters</strong> of ESSearch.</p></li>
</ol>

<p>A condition is composed of:</p>

<ul>
<li>a <strong>path</strong> giving which element is concerned by the condition;</li>
<li>an <strong>operand</strong> which is the item of the comparison (if omitted, the existence of the path is tested);</li>
<li>a <strong>comparator</strong> which can be applied on the operand, for example '>=' or 'within' (defaults to equality in most cases);</li>
<li>optional parameters detailed in <code><a href="#ESSearch.addCondition">ESSearch.addCondition</a></code> documentation, like <strong>inverted</strong> to add a <em>not</em>.</li>
</ul>

<p>Execute the research with <code><a href="#ESSearch.execute">ESSearch.execute()</a></code>. Put the parameter <strong>single</strong> to True if you want the return to be a single observation
instead of a list of observations.</p>

<p>Example of python code using observation.essearch module:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">observation.essearch</span> <span class="kn">import</span> <span class="n">ESSearch</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Mongoclient</span><span class="p">(</span><span class="o">&lt;</span><span class="n">Mongo</span><span class="o">-</span><span class="n">auth</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="o">&lt;</span><span class="n">base</span><span class="o">&gt;</span><span class="p">][</span><span class="o">&lt;</span><span class="n">collection</span><span class="o">&gt;</span><span class="p">]</span>

<span class="c1"># In this example, we search for measures of property PM25 taken between 2022/01/01 </span>
<span class="c1"># and 2022/31/12 and we ensure the measure is an Observation.</span>
<span class="c1"># We execute with argument single = True to merge the result in one single</span>
<span class="c1"># Observation.</span>

<span class="c1"># Option 1</span>
<span class="n">srch</span> <span class="o">=</span> <span class="n">ESSearch</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
<span class="n">srch</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="s1">&#39;datation&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">)</span>
<span class="n">srch</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="s1">&#39;datation&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">)</span>
<span class="n">srch</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="s1">&#39;PM25&#39;</span><span class="p">)</span>
<span class="n">srch</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">comparator</span> <span class="o">=</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="n">operand</span> <span class="o">=</span> <span class="s1">&#39;observation&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">srch</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">single</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Option 2 (equivalent to option 1 but on one line)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ESSearch</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span>
                <span class="p">[[</span><span class="s1">&#39;datation&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="s1">&#39;datation&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="s1">&#39;PM25&#39;</span><span class="p">],</span> 
                <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;comparator&#39;</span><span class="p">:</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;operand&#39;</span><span class="p">:</span> <span class="s1">&#39;observation&#39;</span><span class="p">}]</span> 
                <span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">single</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre>
</div>
</div>

                        <input id="mod-essearch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-essearch-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd"># How to use observation.essearch ?</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">1. **Create the MongoDB database:**</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">You can easily create an account on MongoDB. Once you have a database, follow the guidelines [here](https://www.mongodb.com/docs/atlas/tutorial/connect-to-your-cluster/#connect-to-your-atlas-cluster) to connect to it using pymongo.</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">All you need in order to be able to use this module is to be able to connect to the Collection with pymongo.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">2. **Fill the database with your data:**</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">Construct an observation or a list of observations containing your data using dedicated functions from `python.observation.Observation`. </span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">You can then use `insert_mongo(collection, observation)` to insert it in the database.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">3. **Write a request using observation.ESSearch:**</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">An `ESSearch` instance must be created with either a MongoDB Collection (passed as argument **collection**) or a list of observations (passed as argument **data**).</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">Criteria for the query are then added one by one using `ESSearch.addCondition` or `ESSearch.orCondition`, or all together with `ESSearch.addConditions` or passed as argument **parameters** of ESSearch.</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">A condition is composed of:</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">- a **path** giving which element is concerned by the condition;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">- an **operand** which is the item of the comparison (if omitted, the existence of the path is tested);</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">- a **comparator** which can be applied on the operand, for example &#39;&gt;=&#39; or &#39;within&#39; (defaults to equality in most cases);</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">- optional parameters detailed in `ESSearch.addCondition` documentation, like **inverted** to add a *not*.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">Execute the research with `ESSearch.execute()`. Put the parameter **single** to True if you want the return to be a single observation</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">instead of a list of observations.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">Example of python code using observation.essearch module:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">```python</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">from pymongo import MongoClient</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">from observation.essearch import ESSearch</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">import datetime</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">client = Mongoclient(&lt;Mongo-auth&gt;)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">collection = client[&lt;base&gt;][&lt;collection&gt;]</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd"># In this example, we search for measures of property PM25 taken between 2022/01/01 </span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd"># and 2022/31/12 and we ensure the measure is an Observation.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd"># We execute with argument single = True to merge the result in one single</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd"># Observation.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd"># Option 1</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">srch = ESSearch(collection)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">srch.addCondition(&#39;datation&#39;, datetime.datetime(2022, 1, 1), &#39;&gt;=&#39;)</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">srch.addCondition(&#39;datation&#39;, datetime.datetime(2022, 12, 31), &#39;&lt;=&#39;)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">srch.addCondition(&#39;property&#39;, &#39;PM25&#39;)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">srch.addCondition(path = &#39;type&#39;, comparator = &#39;==&#39;, operand = &#39;observation&#39;)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">result = srch.execute(single = True)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd"># Option 2 (equivalent to option 1 but on one line)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">result = ESSearch(collection,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">                [[&#39;datation&#39;, datetime.datetime(2022, 1, 1), &#39;&gt;=&#39;], </span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">                [&#39;datation&#39;, datetime.datetime(2022, 12, 31), &#39;&lt;=&#39;], </span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">                [&#39;property&#39;, &#39;PM25&#39;], </span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">                {&#39;path&#39;: &#39;type&#39;, &#39;comparator&#39;: &#39;==&#39;, &#39;operand&#39;: &#39;observation&#39;}] </span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">                ).execute(single = True)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">```</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="kn">import</span> <span class="nn">datetime</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="kn">import</span> <span class="nn">shapely.geometry</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="kn">from</span> <span class="nn">pymongo.collection</span> <span class="kn">import</span> <span class="n">Collection</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="kn">from</span> <span class="nn">pymongo.cursor</span> <span class="kn">import</span> <span class="n">Cursor</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="kn">from</span> <span class="nn">pymongo.command_cursor</span> <span class="kn">import</span> <span class="n">CommandCursor</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="kn">import</span> <span class="nn">bson</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="kn">from</span> <span class="nn">observation.esobservation</span> <span class="kn">import</span> <span class="n">Observation</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="kn">from</span> <span class="nn">observation.iindex</span> <span class="kn">import</span> <span class="n">Iindex</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="kn">from</span> <span class="nn">observation.util</span> <span class="kn">import</span> <span class="n">util</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="kn">from</span> <span class="nn">observation.timeslot</span> <span class="kn">import</span> <span class="n">TimeSlot</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="n">dico_alias_mongo</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># dictionnary of the different names accepted for each comparator and each given type. &lt;key&gt;:&lt;value&gt; -&gt; &lt;accepted name&gt;:&lt;name in MongoDB&gt;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="c1"># any type other than those used as keys is considered non valid</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="nb">str</span> <span class="p">:</span> <span class="p">{</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="s2">&quot;regex&quot;</span><span class="p">:</span><span class="s2">&quot;$regex&quot;</span><span class="p">,</span> <span class="s2">&quot;$regex&quot;</span><span class="p">:</span><span class="s2">&quot;$regex&quot;</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="s2">&quot;oid&quot;</span><span class="p">:</span><span class="s2">&quot;$oid&quot;</span><span class="p">,</span><span class="s2">&quot;$oid&quot;</span><span class="p">:</span><span class="s2">&quot;$oid&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>    <span class="p">},</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="nb">int</span> <span class="p">:</span> <span class="p">{</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="s2">&quot;gte&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="s2">&quot;gt&quot;</span><span class="p">:</span><span class="s2">&quot;$gt&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span><span class="s2">&quot;$gt&quot;</span><span class="p">,</span> <span class="s2">&quot;$gt&quot;</span><span class="p">:</span><span class="s2">&quot;$gt&quot;</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="s2">&quot;lte&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;=&lt;&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;$lte&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="s2">&quot;lt&quot;</span><span class="p">:</span><span class="s2">&quot;$lt&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span><span class="s2">&quot;$lt&quot;</span><span class="p">,</span> <span class="s2">&quot;$lt&quot;</span><span class="p">:</span><span class="s2">&quot;$lt&quot;</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>    <span class="p">},</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="p">:</span> <span class="p">{</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="s2">&quot;gte&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">:</span><span class="s2">&quot;$gte&quot;</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="s2">&quot;gt&quot;</span><span class="p">:</span><span class="s2">&quot;$gt&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span><span class="s2">&quot;$gt&quot;</span><span class="p">,</span> <span class="s2">&quot;$gt&quot;</span><span class="p">:</span><span class="s2">&quot;$gt&quot;</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="s2">&quot;lte&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;=&lt;&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;$lte&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="s2">&quot;lt&quot;</span><span class="p">:</span><span class="s2">&quot;$lt&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span><span class="s2">&quot;$lt&quot;</span><span class="p">,</span> <span class="s2">&quot;$lt&quot;</span><span class="p">:</span><span class="s2">&quot;$lt&quot;</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="p">},</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>    <span class="n">TimeSlot</span> <span class="p">:</span> <span class="p">{</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="s2">&quot;contains&quot;</span><span class="p">:</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$contains&quot;</span><span class="p">:</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;$within&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="s2">&quot;disjoint&quot;</span><span class="p">:</span><span class="s2">&quot;disjoint&quot;</span><span class="p">,</span> <span class="s2">&quot;$disjoint&quot;</span><span class="p">:</span><span class="s2">&quot;disjoint&quot;</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="s2">&quot;intersects&quot;</span><span class="p">:</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$intersects&quot;</span><span class="p">:</span><span class="s2">&quot;intersects&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="p">},</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="nb">list</span> <span class="p">:</span> <span class="p">{</span> <span class="c1"># lists are interpreted as geometries</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;$equals&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="s2">&quot;$geowithin&quot;</span><span class="p">:</span><span class="s2">&quot;$geoWithin&quot;</span><span class="p">,</span> <span class="s2">&quot;geowithin&quot;</span><span class="p">:</span><span class="s2">&quot;$geoWithin&quot;</span><span class="p">,</span> <span class="s2">&quot;$geoWithin&quot;</span><span class="p">:</span><span class="s2">&quot;$geoWithin&quot;</span><span class="p">,</span> <span class="s2">&quot;geoWithin&quot;</span><span class="p">:</span><span class="s2">&quot;$geoWithin&quot;</span><span class="p">,</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span><span class="s2">&quot;$geoWithin&quot;</span><span class="p">,</span> <span class="s2">&quot;$within&quot;</span><span class="p">:</span><span class="s2">&quot;$geoWithin&quot;</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="s2">&quot;disjoint&quot;</span><span class="p">:</span><span class="s2">&quot;disjoint&quot;</span><span class="p">,</span> <span class="s2">&quot;$disjoint&quot;</span><span class="p">:</span><span class="s2">&quot;disjoint&quot;</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="s2">&quot;intersects&quot;</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$intersects&quot;</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;geoIntersects&quot;</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$geointersects&quot;</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;geoIntersects&quot;</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$geoIntersects&quot;</span><span class="p">:</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="s2">&quot;touches&quot;</span><span class="p">:</span><span class="s2">&quot;touches&quot;</span><span class="p">,</span> <span class="s2">&quot;$touches&quot;</span><span class="p">:</span><span class="s2">&quot;touches&quot;</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="s2">&quot;overlaps&quot;</span><span class="p">:</span><span class="s2">&quot;overlaps&quot;</span><span class="p">,</span> <span class="s2">&quot;$overlaps&quot;</span><span class="p">:</span><span class="s2">&quot;overlaps&quot;</span><span class="p">,</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="s2">&quot;contains&quot;</span><span class="p">:</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span> <span class="s2">&quot;$contains&quot;</span><span class="p">:</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="s2">&quot;$geoNear&quot;</span><span class="p">:</span><span class="s2">&quot;$geoNear&quot;</span><span class="p">,</span> <span class="s2">&quot;$geonear&quot;</span><span class="p">:</span><span class="s2">&quot;$geoNear&quot;</span><span class="p">,</span> <span class="s2">&quot;geonear&quot;</span><span class="p">:</span><span class="s2">&quot;$geoNear&quot;</span><span class="p">,</span> <span class="s2">&quot;geoNear&quot;</span><span class="p">:</span><span class="s2">&quot;$geoNear&quot;</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span> <span class="c1"># only in case where a list is not a geometry</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="p">},</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="c1">#bson.objectid.ObjectId : {</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>    <span class="n">bson</span><span class="o">.</span><span class="n">ObjectId</span> <span class="p">:</span> <span class="p">{</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;$in&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="p">}</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="p">}</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="n">_geoeq</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="n">_geowith</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="n">_geodis</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">disjoint</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="n">_geointer</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="n">_geotou</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">touches</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="n">_geoover</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="n">_geocont</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="n">_geonear</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="n">_defeq</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="n">_defsupeq</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="n">_defsup</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="n">_definfeq</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="n">_definf</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="n">_defin</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="n">_timinfeq</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="c1"># at least one element of the TimeSlot is lte y</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="n">_timinf</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y</span>  <span class="c1"># at least one element of the TimeSlot is lt y</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="n">_timsupeq</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y</span> <span class="c1"># at least one element of the TimeSlot is gte y</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="n">_timsup</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y</span>  <span class="c1"># at least one element of the TimeSlot is gt y</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="n">_timeq</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">TimeSlot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="c1"># To have all elements verify a comparison instead of just one, combine with parameter inverted.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="c1"># For example : not (at least one element of the TimeSlot is lte y) &lt;=&gt; all elements of the TimeSlot are gt y</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="n">dico_alias_python</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>    <span class="n">TimeSlot</span> <span class="p">:</span> <span class="p">{</span> <span class="c1"># only used in python filtering part</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="n">TimeSlot</span> <span class="p">:</span> <span class="p">{</span> <span class="c1"># comparison of a TimeSlot with a timeSlot</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="kc">None</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="s2">&quot;$equals&quot;</span><span class="p">:</span><span class="s2">&quot;equals&quot;</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="s2">&quot;contains&quot;</span><span class="p">:</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span> <span class="s2">&quot;$contains&quot;</span><span class="p">:</span><span class="s2">&quot;contains&quot;</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span> <span class="s2">&quot;$within&quot;</span><span class="p">:</span><span class="s2">&quot;within&quot;</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="s2">&quot;disjoint&quot;</span><span class="p">:</span><span class="s2">&quot;disjoint&quot;</span><span class="p">,</span> <span class="s2">&quot;$disjoint&quot;</span><span class="p">:</span><span class="s2">&quot;disjoint&quot;</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="s2">&quot;intersects&quot;</span><span class="p">:</span><span class="s2">&quot;intersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$intersects&quot;</span><span class="p">:</span><span class="s2">&quot;intersects&quot;</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="p">},</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>            
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="p">:</span> <span class="p">{</span> <span class="c1"># comparison of a datetime and a TimeSlot</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>            <span class="kc">None</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span> <span class="s2">&quot;$equals&quot;</span><span class="p">:</span><span class="n">_timeq</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="s2">&quot;$gte&quot;</span><span class="p">:</span><span class="n">_timsupeq</span><span class="p">,</span> <span class="s2">&quot;gte&quot;</span><span class="p">:</span><span class="n">_timsupeq</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span><span class="n">_timsupeq</span><span class="p">,</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">:</span><span class="n">_timsupeq</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="s2">&quot;$gt&quot;</span><span class="p">:</span><span class="n">_timsup</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">:</span><span class="n">_timsup</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span><span class="n">_timsup</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="s2">&quot;$lte&quot;</span><span class="p">:</span><span class="n">_timinfeq</span><span class="p">,</span> <span class="s2">&quot;lte&quot;</span><span class="p">:</span><span class="n">_timinfeq</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span><span class="n">_timinfeq</span><span class="p">,</span> <span class="s2">&quot;=&lt;&quot;</span><span class="p">:</span><span class="n">_timinfeq</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="s2">&quot;$lt&quot;</span><span class="p">:</span><span class="n">_timinf</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">:</span><span class="n">_timinf</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span><span class="n">_timinf</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="p">}</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="p">},</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>    <span class="s1">&#39;geometry&#39;</span> <span class="p">:</span> <span class="p">{</span> <span class="c1"># lists are interpreted as geometries</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="kc">None</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="n">_geoeq</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="n">_geoeq</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="n">_geoeq</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">_geoeq</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">:</span><span class="n">_geoeq</span><span class="p">,</span> <span class="s2">&quot;$equals&quot;</span><span class="p">:</span><span class="n">_geoeq</span><span class="p">,</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="s2">&quot;$geowithin&quot;</span><span class="p">:</span><span class="n">_geowith</span><span class="p">,</span> <span class="s2">&quot;geowithin&quot;</span><span class="p">:</span><span class="n">_geowith</span><span class="p">,</span> <span class="s2">&quot;$geoWithin&quot;</span><span class="p">:</span><span class="n">_geowith</span><span class="p">,</span> <span class="s2">&quot;geoWithin&quot;</span><span class="p">:</span><span class="n">_geowith</span><span class="p">,</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span><span class="n">_geowith</span><span class="p">,</span> <span class="s2">&quot;$within&quot;</span><span class="p">:</span><span class="n">_geowith</span><span class="p">,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="s2">&quot;disjoint&quot;</span><span class="p">:</span><span class="n">_geodis</span><span class="p">,</span> <span class="s2">&quot;$disjoint&quot;</span><span class="p">:</span><span class="n">_geodis</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="s2">&quot;intersects&quot;</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span> <span class="s2">&quot;$intersects&quot;</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span> <span class="s2">&quot;geoIntersects&quot;</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span> <span class="s2">&quot;$geointersects&quot;</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span> <span class="s2">&quot;geoIntersects&quot;</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span> <span class="s2">&quot;$geoIntersects&quot;</span><span class="p">:</span><span class="n">_geointer</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="s2">&quot;touches&quot;</span><span class="p">:</span><span class="n">_geotou</span><span class="p">,</span> <span class="s2">&quot;$touches&quot;</span><span class="p">:</span><span class="n">_geotou</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="s2">&quot;overlaps&quot;</span><span class="p">:</span><span class="n">_geoover</span><span class="p">,</span> <span class="s2">&quot;$overlaps&quot;</span><span class="p">:</span><span class="n">_geoover</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="s2">&quot;contains&quot;</span><span class="p">:</span><span class="n">_geocont</span><span class="p">,</span> <span class="s2">&quot;$contains&quot;</span><span class="p">:</span><span class="n">_geocont</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="s2">&quot;$geoNear&quot;</span><span class="p">:</span><span class="n">_geonear</span><span class="p">,</span> <span class="s2">&quot;$geonear&quot;</span><span class="p">:</span><span class="n">_geonear</span><span class="p">,</span> <span class="s2">&quot;geonear&quot;</span><span class="p">:</span><span class="n">_geonear</span><span class="p">,</span> <span class="s2">&quot;geoNear&quot;</span><span class="p">:</span><span class="n">_geonear</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>    <span class="p">},</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>    <span class="s1">&#39;default&#39;</span> <span class="p">:</span> <span class="p">{</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="kc">None</span><span class="p">:</span><span class="n">_defeq</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="s2">&quot;eq&quot;</span><span class="p">:</span><span class="n">_defeq</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span><span class="n">_defeq</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span><span class="n">_defeq</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span><span class="n">_defeq</span><span class="p">,</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="s2">&quot;gte&quot;</span><span class="p">:</span><span class="n">_defsupeq</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span><span class="n">_defsupeq</span><span class="p">,</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">:</span><span class="n">_defsupeq</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">:</span><span class="n">_defsupeq</span><span class="p">,</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>        <span class="s2">&quot;gt&quot;</span><span class="p">:</span><span class="n">_defsup</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span><span class="n">_defsup</span><span class="p">,</span> <span class="s2">&quot;$gt&quot;</span><span class="p">:</span><span class="n">_defsup</span><span class="p">,</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="s2">&quot;lte&quot;</span><span class="p">:</span><span class="n">_definfeq</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span><span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="s2">&quot;=&lt;&quot;</span><span class="p">:</span><span class="n">_definfeq</span><span class="p">,</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="s2">&quot;lt&quot;</span><span class="p">:</span><span class="n">_definf</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span><span class="n">_definf</span><span class="p">,</span> <span class="s2">&quot;$lt&quot;</span><span class="p">:</span><span class="n">_definf</span><span class="p">,</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="s2">&quot;in&quot;</span><span class="p">:</span><span class="n">_defin</span><span class="p">,</span> <span class="s2">&quot;$in&quot;</span><span class="p">:</span><span class="n">_defin</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>    <span class="p">}</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="p">}</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="k">def</span> <span class="nf">insert_from_doc</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">document</span> <span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Inserts all observations from a document into a collection, where each line of the document corresponds to an observation.&#39;&#39;&#39;</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">doc</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">insert_to_mongo</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="k">def</span> <span class="nf">insert_to_mongo</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># Mieux avec panda ?</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Takes an observation or a list of observations and inserts them into a MongoDB collection, with info by default.&#39;&#39;&#39;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>    <span class="c1"># Faire une fonction pour permettre l&#39;ajout direct de fichiers csv.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="n">inserted_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="n">pile</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Observation</span><span class="p">):</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>    <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">pile</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">obs_hash</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">id</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">obs_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">obs_hash</span><span class="p">}</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">param</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">param</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;information&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Observation</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># a special case is needed because lists with one element are replaced by the element itself so iteration doesn&#39;t work</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>                <span class="n">inserted_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">util</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">encoded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typevalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simpleval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geojson</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>                                        <span class="s1">&#39;_metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">})</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>                <span class="n">inserted_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">util</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">encoded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typevalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simpleval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geojson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                                                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))}</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;_metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">})</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>    <span class="k">if</span> <span class="n">inserted_list</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">inserted_list</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="k">def</span> <span class="nf">empty_request</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">    Empty request to get an idea of what the database contains.</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">    Currently returns the count of elements in the collection and the name of each column.</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;column_names&#39;</span><span class="p">:</span> <span class="n">column_names</span><span class="p">}</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="k">class</span> <span class="nc">ESSearch</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">    An `ESSearch` is defined as an ensemble of conditions to be used to execute a MongoDB request or any iterable containing only observations.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">    *Attributes (for @property, see methods)* :</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">    - **input** : input on which the query is done. One of or a list of these : </span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">        - pymongo.collection.Collection</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a><span class="sd">        - pymongo.cursor.Cursor</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="sd">        - pymongo.command_cursor.CommandCursor</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="sd">        - Observation (can be defined from a str or a dict)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">    - **parameters** : list of list of conditions for queries, to be interpreted as : parameters = [[cond_1 AND cond_2 AND cond_3] OR [cond_4 AND cond_5 AND cond_6]] where conds are criteria for queries</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">    - **hide** : list of paths to hide from the output</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="sd">    - **heavy** : boolean indicating whether the request should search for nested values or not. Does not work with geoJSON.</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="sd">    - **sources** : attribute used to indicate the sources of the data in param</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="sd">    The methods defined in this class are (documentations in methods definitions):</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="sd">    </span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">    *setter*</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="sd">    - `ESSearch.addInput`</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">    - `ESSearch.removeInputs`</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">    - `ESSearch.setHide`</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">    - `ESSearch.setHeavy`</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">    - `ESSearch.clear`</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">    </span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">    *dynamic value (getter @property)*</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">    - `ESSearch.request`</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">    - `ESSearch.cursor`</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">    </span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">    *parameters for query - update methods*</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">    - `ESSearch.addConditions`</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">    - `ESSearch.addCondition`</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">    - `ESSearch.orCondition`</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">    - `ESSearch.removeCondition`</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">    - `ESSearch.clearConditions`</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">    *query method*</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">    - `ESSearch.execute`</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>                    <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>                    <span class="n">parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>                    <span class="n">hide</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>                    <span class="n">heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                    <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>                    <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                    <span class="p">):</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">        ESSearch constructor. Parameters can also be defined and updated using class methods.</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">        *Arguments*</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">        - **input** : input on which the query is done. Must be one of or a list of these (can be nested):</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">            - pymongo.collection.Collection</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">            - pymongo.cursor.Cursor</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">            - pymongo.command_cursor.CommandCursor</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">            - Observation</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">            - str corresponding to a json Observation</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">            - dict corresponding to a json Observation</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">        - **parameters** :  dict, list (default None) - list of list or list of dictionnaries whose keys are arguments of ESSearch.addCondition method</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">        ex: parameters = [</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">            {&#39;name&#39; : &#39;datation&#39;, &#39;operand&#39; : datetime.datetime(2022, 9, 19, 1), &#39;comparator&#39; : &#39;&gt;=&#39;},</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">            {&#39;name&#39; : &#39;property&#39;, &#39;operand&#39; : &#39;PM2&#39;}</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">        ]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">        - **hide** : list (default []) - List of strings where strings correspond to paths to remove from the output</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">        - **heavy** :  bool (default False) - Must be True when values are defined directly and inside dictionnaries simultaneously.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">        - **sources** : (default None) - Optional parameter indicating the sources of the data in case when a query is executed with parameter single = True.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">        - **kwargs** :  other parameters are used as arguments for ESSearch.addCondition method.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>                                          <span class="c1"># self.parameters</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span>                     <span class="c1"># self.hide</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;hide must be a list.&quot;</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heavy</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="o">=</span> <span class="n">heavy</span>                  <span class="c1"># self.heavy</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;heavy must be a bool.&quot;</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>                                          <span class="c1"># self.sources</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>                                           <span class="c1"># self.input : formatted as [[Mongo Objects], [Observations]] (list of two lists)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">pile</span> <span class="o">=</span> <span class="nb">input</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                <span class="n">pile</span> <span class="o">+=</span> <span class="n">obj</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="n">Observation</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to an Observation.&quot;</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for input &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="k">if</span> <span class="n">parameters</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addConditions</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="k">return</span> <span class="s2">&quot;ESSearch(input = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, parameters = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>    <span class="k">def</span> <span class="nf">addInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">        Adds one or many inputs on which the query is to be executed given by argument input.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="sd">        Inputs can be:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">            - pymongo.collection.Collection</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">            - pymongo.cursor.Cursor</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">            - pymongo.command_cursor.CommandCursor</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">            - Observation</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">            - str corresponding to a json Observation</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">            - dict corresponding to a json Observation</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        or a list of any of these.</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="n">added_input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">pile</span> <span class="o">=</span> <span class="nb">input</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># using a stack (LIFO) to allow easy treatment of nested data.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                <span class="n">pile</span> <span class="o">+=</span> <span class="n">obj</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                <span class="n">added_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="n">Observation</span><span class="p">):</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                    <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to an Observation.&quot;</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for input &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">added_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># self.input is updated with the new inputs</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>    <span class="k">def</span> <span class="nf">removeInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        Removes all inputs from self.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>    <span class="k">def</span> <span class="nf">setHide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hide</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">        Sets self.hide to a value given by argument hide.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;hide must be a list.&quot;</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    <span class="k">def</span> <span class="nf">setHeavy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heavy</span><span class="p">):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        Sets self.heavy to a value given by argument heavy.</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heavy</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="o">=</span> <span class="n">heavy</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;heavy must be a bool.&quot;</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>    <span class="k">def</span> <span class="nf">setSources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">        Sets self.sources to a value given by argument sources.</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>    <span class="k">def</span> <span class="nf">addConditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">        Takes multiple parameters and applies self.addCondition() on each of them.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># case when one single condition is added</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="c1"># case when several conditions are added</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">*</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;parameters must be either a dict or a list of dict.&quot;</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>    <span class="k">def</span> <span class="nf">addCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">operand</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comparator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">or_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">        Takes parameters and inserts corresponding query condition in self.parameters.</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">        *Parameters*</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">        - **path** :  str (required argument) - name of an IIndex, which corresponds to an Ilist column name, or name of a metadata element.</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">                    (ex: &#39;datation&#39;, &#39;location&#39;, &#39;property&#39;)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">        - **operand** :  - (default None) - Object used for the comparison.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">                    (ex: if we search for observations made in Paris, operand is &#39;Paris&#39;)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a><span class="sd">        - **comparator**:  str (default None) - str giving the comparator to use. (ex: &#39;&gt;=&#39;, &#39;in&#39;)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        </span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">        - **or_position** :  int (default -1) - position in self.parameters in which the condition is to be inserted.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="sd">        - **formatstring** :  str (default None) - str to use to automatically change str to datetime before applying condition.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a><span class="sd">                    Does not update the data base. If value is set to &#39;default&#39;, format is assumed to be Isoformat.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a><span class="sd">        </span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="sd">        - **inverted** :  bool (default None) - to add a &quot;not&quot; in the condition.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="sd">                    To use in case where every element of a MongoDB array (equivalent to python list) must verify the condition (by default, condition is verified when at least one element of the array verifies it).</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="sd">        </span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">        - **unwind** :  int (default None) - int corresponding to the number of additional {&quot;$unwind&quot; : &quot;$&quot; + path} to be added in the beginning of the query.</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">        </span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        - **regex_options** :  str (default None) - str associated to regex options (i, m, x and s). See [this link](https://www.mongodb.com/docs/manual/reference/operator/query/regex/) for more details.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">        no comparator =&gt; default comparator associated with operand type in dico_alias_mongo is used (mainly equality)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">        no operand =&gt; only the existence of something located at path is tested</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="c1">## 1. Check if arguments given are valid.</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name must be a str.&quot;</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;comparator must be a str.&quot;</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">or_position</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;or_position must be an int.&quot;</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="c1"># checking if parameters in kwarg do exist</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;formatstring&#39;</span><span class="p">,</span> <span class="s1">&#39;inverted&#39;</span><span class="p">,</span> <span class="s1">&#39;unwind&#39;</span><span class="p">,</span> <span class="s1">&#39;regex_options&#39;</span><span class="p">,</span> <span class="s1">&#39;distanceField&#39;</span><span class="p">,</span> <span class="s1">&#39;distanceMultiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;includeLocs&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;maxDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;minDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;near&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">}:</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown parameter : &quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">operand</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="k">if</span> <span class="n">operand</span><span class="p">:</span> <span class="c1"># checking if comparator can be applied on the operand</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">operand</span><span class="p">)][</span><span class="n">comparator</span><span class="p">]</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible values for comparator and operand. Ensure parameters are in the correct order.&quot;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>        <span class="k">elif</span> <span class="n">comparator</span><span class="p">:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;operand must be defined when comparator is used.&quot;</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="c1">## 2. Add the condition to self.parameters</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;comparator&quot;</span> <span class="p">:</span> <span class="n">comparator</span><span class="p">,</span> <span class="s2">&quot;operand&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span> <span class="p">:</span> <span class="n">path</span><span class="p">}</span> <span class="o">|</span> <span class="n">kwargs</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">condition</span><span class="p">])</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>    <span class="k">def</span> <span class="nf">orCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">        Adds a condition in a new sublist in self.parameters. Separations in sublists correspond to &quot;or&quot; in the query.</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">or_position</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="k">def</span> <span class="nf">removeCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">or_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">condnum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        Removes a condition from self.parameters. By default, last element added is removed.</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">        Otherwise, the removed condition is the one at self.parameters[or_position][condnum].</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="sd">        To remove all conditions, use ESSearch.clearConditions() method.</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[[]]:</span> <span class="k">return</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            <span class="k">if</span> <span class="n">condnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># by default : remove the very last added condition.</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">condnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">condnum</span><span class="p">)</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="k">if</span> <span class="n">condnum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">condnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">or_position</span><span class="p">)</span> <span class="c1"># if or_position is not None and condnum is, the whole sublist at or_position is removed.</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">condnum</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[]:</span> <span class="c1"># ensure self.parameters returns to its default value after being emptied</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>    <span class="k">def</span> <span class="nf">clearConditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        Removes all conditions from self.parameters.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">        To remove all attributes, use ESSearch.clear() method.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        Resets self.</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        (Creating a new Observation would be smarter than using this function.)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="bp">self</span> <span class="o">=</span> <span class="n">ESSearch</span><span class="p">()</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>    <span class="k">def</span> <span class="nf">_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">,</span> <span class="n">comparator</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">inverted</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">formatstring</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unwind</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">regex_options</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">        Takes parameters and adds corresponding MongoDB expression to self._match.</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        self._unwind and self._set are updated when necessary.</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="k">if</span> <span class="n">unwind</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unwind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unwind</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unwind</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">unwind</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unwind</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># format : (&lt;path&gt;, &lt;unwind quantity&gt;)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">unwind</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unwind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;unwind must be a tuple, a str or an int.&quot;</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="ow">and</span> <span class="n">operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="c1"># peut-tre mieux de laisser l&#39;utilisateur choisir manuellement</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.v&quot;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="k">if</span> <span class="n">operand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># no operand =&gt; we only test if there is something located at path</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="n">comparator</span> <span class="o">=</span> <span class="s2">&quot;$exists&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">operand</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">operand</span><span class="p">)][</span><span class="n">comparator</span><span class="p">]</span> <span class="c1">#global variable</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                <span class="k">if</span> <span class="n">formatstring</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                    <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">][</span><span class="n">comparator</span><span class="p">]</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparator not allowed.&quot;</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseGeometry</span><span class="p">):</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="n">operand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="o">.</span><span class="n">geom_type</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)}</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparator not allowed.&quot;</span><span class="p">)</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="c1">##if path in {&quot;$year&quot;, &quot;$month&quot;, &quot;$dayOfMonth&quot;, &quot;$hour&quot;, &quot;$minute&quot;, &quot;$second&quot;, &quot;$millisecond&quot;, &quot;$dayOfYear&quot;, &quot;$dayOfWeek&quot;}:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="c1">##    self._set |= {path[1:]: {&#39;datation&#39; : path}} # tester</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="c1">##    path = datation</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="c1">##    self._project |= {name[1:]:0}</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">):</span> <span class="c1">#equals-&gt;within, contains-&gt;intersects, within, disjoint, intersects</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="k">if</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;intersects&quot;</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># pourquoi False et pas inverted ici ??</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>            <span class="k">return</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="k">if</span> <span class="n">formatstring</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>            <span class="k">if</span> <span class="n">formatstring</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                    <span class="n">operand</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">|=</span> <span class="p">{</span><span class="n">path</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$convert&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span> <span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;onError&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">}}}</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">formatstring</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">|=</span> <span class="p">{</span><span class="n">path</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$dateFromString&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dateString&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">formatstring</span><span class="p">,</span> <span class="s2">&quot;onError&quot;</span><span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">}}}</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$geoWithin&quot;</span><span class="p">}:</span>  <span class="c1"># operand :</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                                                            <span class="c1"># [x, y] or [[x, y]] -&gt; Point ;</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                                                            <span class="c1"># [[x1, y1], [x2, y2]] -&gt; LineString ;</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                                                            <span class="c1"># [[x1, y1], [x2, y2], [x3, y3], ...] or [[x1, y1], [x2, y2], [x3, y3], ..., [x1, y1]] or [[[x1, y1], [x2, y2], [x3, y3], ..., [x1, y1]]] -&gt; Polygon.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                    <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Point&quot;</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>                        <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Point&quot;</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                        <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;LineString&quot;</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">operand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                            <span class="n">operand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>                        <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Polygon&quot;</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                        <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">operand</span><span class="p">]</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to define a geometry from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">operand</span><span class="p">))</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>                    <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Polygon&quot;</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                <span class="n">operand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$geometry&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">geom_type</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span> <span class="p">:</span> <span class="n">coordinates</span><span class="p">}}</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;$geometry&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">operand</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                <span class="n">operand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$geometry&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">}</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;$geoNear&quot;</span><span class="p">:</span> <span class="c1"># $geoNear is a MongoDB stage</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span> <span class="o">|</span> <span class="n">kwargs</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="k">if</span> <span class="s1">&#39;distanceField&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;distanceField missing in MongoDB stage $geoNear.&quot;</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>            <span class="k">return</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># lists are interpreted as geometries. An additional filtering is necessary for geometry-specific functions</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>            <span class="k">return</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;$regex&quot;</span> <span class="ow">and</span> <span class="n">regex_options</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="n">cond_0</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">,</span> <span class="s2">&quot;$options&quot;</span> <span class="p">:</span> <span class="n">regex_options</span><span class="p">}</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>            <span class="n">cond_0</span> <span class="o">=</span> <span class="p">{</span><span class="n">comparator</span> <span class="p">:</span> <span class="n">operand</span><span class="p">}</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">]:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                <span class="k">if</span> <span class="s2">&quot;$nor&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$nor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond_0</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                <span class="k">elif</span> <span class="s2">&quot;not&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]:</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$nor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$not&quot;</span><span class="p">],</span> <span class="n">cond_0</span><span class="p">]</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$not&quot;</span><span class="p">]</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$not&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond_0</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span> <span class="p">:</span> <span class="n">cond_0</span><span class="p">}</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">]:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond_0</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cond_0</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    <span class="k">def</span> <span class="nf">_fullSearchMongo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">        Takes self.parameters and returns a MongoDB Aggregation query.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 1: Declare private variables</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="n">request</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># two additional set stages to treat nested objects</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">|=</span> <span class="p">{</span><span class="n">el</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 2: Update private variables for each condition</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)):</span> <span class="c1"># rewriting conditions in MongoDB format</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>            <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">cond</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 3: Case 1 : find request</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">:</span> <span class="c1"># collection.find() request</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">:</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">)):</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span> <span class="c1"># removing empty elements in place</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># when there is no $or</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                <span class="k">else</span><span class="p">:</span> <span class="c1"># when there is a $or</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[:</span><span class="n">j</span><span class="p">]}</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>            <span class="k">return</span> <span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="n">match</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 4: Case 2 : aggregate request</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>                                                    <span class="c1"># Mongo $unwind stage</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                <span class="k">for</span> <span class="n">unwind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>                    <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$unwind&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">unwind</span><span class="p">})</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="p">:</span>                                               <span class="c1"># Additional Mongo $set stage if self.heavy is True</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                <span class="n">heavy</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                    <span class="n">heavy</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">:{</span><span class="s2">&quot;$cond&quot;</span><span class="p">:{</span><span class="s2">&quot;if&quot;</span><span class="p">:{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:[{</span><span class="s2">&quot;$type&quot;</span><span class="p">:</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">},</span><span class="s2">&quot;object&quot;</span><span class="p">]},</span><span class="s2">&quot;then&quot;</span><span class="p">:{</span><span class="s2">&quot;$objectToArray&quot;</span><span class="p">:</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">},</span><span class="s2">&quot;else&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;v&quot;</span><span class="p">:</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">}}}}</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">|=</span> <span class="p">{</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span> <span class="p">:</span> <span class="n">heavy</span><span class="p">})</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">})</span>                  <span class="c1"># Mongo $set stage</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$geoNear&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">})</span>      <span class="c1"># Mongo $geoNear stage</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">:</span>                                                     <span class="c1"># Mongo $match stage</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">)):</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># when there is no $or</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="k">else</span><span class="p">:</span> <span class="c1"># when there is a $or</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                    <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[:</span><span class="n">j</span><span class="p">]}})</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>                                                    <span class="c1"># Second Mongo $set stage when unwind not empty</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>                <span class="n">dico</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                <span class="k">for</span> <span class="n">unwind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">unwind</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span> <span class="n">dico</span><span class="p">[</span><span class="n">unwind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">unwind</span><span class="p">]</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">dico</span><span class="p">[</span><span class="n">unwind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dico</span><span class="p">[</span><span class="n">unwind</span><span class="p">]]</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span> <span class="p">:</span> <span class="n">dico</span><span class="p">})</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">})</span>      <span class="c1"># Mongo $project stage</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="k">return</span> <span class="s1">&#39;aggregation&#39;</span><span class="p">,</span> <span class="n">request</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>    <span class="nd">@property</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">        Getter returning the content of the query or aggregation query to be executed with ESSearch.execute().</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="k">return</span> <span class="s1">&#39;collection.find(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="k">return</span> <span class="s1">&#39;collection.aggregate(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="nd">@property</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">        Getter returning the cursors of the query or aggregation query result on all collections and cursors contained in self.input.</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>        <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="n">cursor_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># Determine the result cursor for each element of the input on which a Mongo query makes sense</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>                    <span class="n">cursor_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">request_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">))</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>                    <span class="n">cursor_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">request_content</span><span class="p">))</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cursor_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="k">return</span> <span class="n">cursor_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="k">return</span> <span class="n">cursor_list</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returnmode</span> <span class="o">=</span> <span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        Executes the request and returns its result, either in one or many Observations.</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        *Parameter*</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">        - **returnmode** : str (default None) - Parameter giving the format of the output:</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">            - &#39;unchanged&#39; : output is returned as it is in the database, some operations like operations sepcific to TimeSlot object are not performed;</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">            - &#39;observation&#39;: Each element is returned as an observation, but original observations aren&#39;t recreated;</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">            - &#39;idfused&#39;: observations whose ids are the same are merged together; </span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">            - &#39;single&#39;: return a single observation merging all observations together.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        - **fillvalue** :  (default None) - Value to use to fill gaps when observations are merged together.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        - **name** : str (default None) - name of the output observation when returnmode is &#39;single&#39;.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        - **param** : dict (default None) - param of the output observation when returnmode is &#39;single&#39;.</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;unchanged&#39;</span><span class="p">,</span> <span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="s1">&#39;idfused&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">}:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;returnmode must have one of these values: &#39;unchanged&#39;, &#39;observation&#39;, &#39;idfused&#39;, &#39;single&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="k">if</span> <span class="n">name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>  <span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name should be a string.&quot;</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;param should be a dictionnary.&quot;</span><span class="p">)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Boolean put to True inside of self._cond() if an additional filtering specific to TimeSlot and shapely geometries is necessary.</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="c1">## Construction of a result list where data are in the format given by returnmode</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="c1">## ESSearch.execute() 1: Query is executed on each Mongo Collection or Cursor of self.input</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">request_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;observation&#39;</span><span class="p">:</span> <span class="c1"># Only in this case is an observation created directly.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="c1"># Additional filtering for objects like TimeSlot who need it</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                        <span class="k">for</span> <span class="n">conds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                            <span class="n">checks_parameters</span><span class="p">,</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                            <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                                    <span class="k">try</span><span class="p">:</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="n">checks_conds</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">cond</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]],</span> <span class="n">cond</span><span class="p">)</span> <span class="c1"># checking for each condition if it is satisfied</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                                    <span class="k">except</span><span class="p">:</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                                    <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                            <span class="n">checks_parameters</span> <span class="o">=</span> <span class="n">checks_parameters</span> <span class="ow">or</span> <span class="n">checks_conds</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                    <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                        <span class="k">if</span> <span class="s1">&#39;name&#39;</span>  <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                        <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                        <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="ow">and</span> <span class="n">checks_parameters</span><span class="p">):</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="o">**</span><span class="n">dic</span><span class="p">))</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                    <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="p">:</span> <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># returnmode == &#39;unchanged&#39; or returnmode == &#39;idfused&#39;</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="c1">## ESSearch.execute() 2: Operations for cases &#39;idfused&#39; and &#39;single&#39; are performed on output objects.</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="c1"># (more efficient to do it like this than after a conversion to Observation)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="n">arg</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># argument to be given to Observation.dic() merging all observations together</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span> <span class="c1"># for columns already in the new Observation</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                    <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="c1"># for columns missing in the new Observation</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                    <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">column_name</span><span class="p">]]</span> <span class="c1"># an empty column filled with fillvalue is added if a new column name is encountered</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="n">arg</span><span class="p">))]</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;idfused&#39;</span><span class="p">:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="n">hashs_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="c1"># will throw an error if item has no id. Should items with no id be let as is or merged together?</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span> <span class="c1"># one line is added to hashs_dic[id] for each element of result having this id</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                    <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span> <span class="c1"># Two items with the same id should have the same metadata.</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]:</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>                    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]:</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">column_name</span><span class="p">]]</span> <span class="c1"># a filled column is added if a new column name is encountered</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                    <span class="k">if</span> <span class="s1">&#39;name&#39;</span>  <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                    <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                    <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                    <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span> <span class="c1"># an Observation is added to result for each id</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="n">obs_out</span> <span class="o">=</span> <span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="o">**</span><span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                <span class="k">if</span> <span class="n">obs_out</span><span class="p">:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">obs_out</span><span class="p">))</span> <span class="c1"># finalement, semble plus pertinent de faire ce filtrage directemt sur la sortie Mongo, car mme si un  un les tests de condition sont faits  de nombreuses reprises, au global ce ne sont jamais les mmes combinaisons de test</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_out</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="c1"># At this point, result is a list of observations.</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="c1">## ESSearch.execute() 3: Other inputs (pure observations) are treated purely in python with the self._filtered_observation() method</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># data which are not taken from a Mongo database and already are observations are treated here.</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="c1">## ESSearch.execute() 4: Operations for cases &#39;idfused&#39; and &#39;single&#39; are performed again with the added observations</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>            <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fusion</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ESSearch query result on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="c1"># default value for name</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># default value for param</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                        <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">:</span> <span class="c1"># informations about the inputs are added to param</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Observation</span><span class="p">):</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Observation: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MongoDB collection: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">):</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pymongo cursor: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">+</span> <span class="s1">&#39; from collection &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> 
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                                                <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">):</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pymongo commandcursor: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">+</span> <span class="s1">&#39; from collection &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> 
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                                                <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                            <span class="k">else</span><span class="p">:</span> <span class="c1"># should not happen</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                    <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span> <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;essearch&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dim3&#39;</span><span class="p">,</span> 
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;ESSearch query&#39;</span><span class="p">,</span> <span class="s1">&#39;sources &#39;</span><span class="p">:</span> <span class="n">sources</span><span class="p">,</span> 
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                            <span class="s1">&#39;ESSearch_parameters&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)}}</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="n">result</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;idfused&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                <span class="n">hashs_dic</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># This dictionnary is in the format {id: [observations]}</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                        <span class="n">hashs_dic</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                        <span class="n">hashs_dic</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                    <span class="n">obs_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fusion</span><span class="p">(</span><span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">fillvalue</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                    <span class="k">if</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="n">obs_out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="c1"># name and param associated to the id are put back</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                    <span class="k">if</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">:</span> <span class="n">obs_out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                    <span class="k">if</span> <span class="n">obs_out</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_out</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="c1">## ESSearch.execute() 5: Return result</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>    <span class="k">def</span> <span class="nf">_filtered_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">is_from_mongo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span> <span class="c1"># Vrifier que cette fonction n&#39;est pas moins efficace que de tout dplier / filtrer / tout replier</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># Regarder si on ne peut pas faire la mme chose en mieux avec des fonctions de numpy ou panda.</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">        Takes an Observation and returns a filtered Observation with self.parameters as a filter.</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="c1"># self.parameters = [[cond1 AND cond 2 AND cond 3] OR [cond4 AND cond5 AND cond6]]</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="c1"># dico = {&quot;data&quot;: [[&quot;datation&quot;, [date1, date2, date3], [0,1,0,2,2,1]], [&quot;location&quot;, [loc1, loc2, loc3], [0,1,2,0,1,1]]]} # dico n&#39;est plus utilis</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[[]]:</span> <span class="k">return</span> <span class="n">obs</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="c1">## ESSearch._filtered_observation() 0: This function is done with an iteration over self.parameters </span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="n">final_filter</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">lencomplete</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)):</span> <span class="c1"># for each group of conditions separated by a or</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="c1">## ESSearch._filtered_observation() 1: Checking if no column is missing and if conditions on metadata are verified</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>                <span class="n">conds</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># conds is a dict which associates columns to the condition which concern them (inside of [cond1 AND cond 2 AND cond 3] : only AND)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                <span class="n">relevant</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># no column given by cond[&quot;path&quot;] is missing from obs</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>                    <span class="n">next_relevant</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">)):</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>                        <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>                            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">:</span> <span class="n">conds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>                            <span class="k">else</span><span class="p">:</span> <span class="n">conds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cond</span><span class="p">]</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>                            <span class="n">next_relevant</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>                        <span class="k">elif</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_metadata&quot;</span><span class="p">:</span> <span class="c1"># metadata are id, name and param</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_from_mongo</span><span class="p">:</span> <span class="c1"># This step is considered to be done already for data taken out of Mongo</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">next_relevant</span> <span class="o">=</span> <span class="n">next_relevant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span>   <span class="p">:</span> <span class="n">next_relevant</span> <span class="o">=</span> <span class="n">next_relevant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="n">next_relevant</span> <span class="o">=</span> <span class="n">next_relevant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>                                <span class="n">next_relevant</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>                    <span class="n">relevant</span> <span class="o">=</span> <span class="n">relevant</span> <span class="ow">and</span> <span class="n">next_relevant</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># if a column on which a condition is applied is missing, the set of conditions given by the element of self.parameters is considered not verified.</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="c1">## ESSearch._filtered_observation() 2: Condition is applied on all elements of the Observation to create a boolean filter</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>                <span class="n">full_filter</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">lencomplete</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lenidx</span><span class="p">):</span> <span class="c1"># iteration over the columns</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>                    <span class="nb">filter</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">cod</span><span class="p">:</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>                        <span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                        <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                            <span class="k">try</span><span class="p">:</span> <span class="n">boolean</span> <span class="o">=</span> <span class="n">boolean</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>                            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1">#boolean = False # pose problme pour les regex et autres oprations non implmentes...</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>                        <span class="nb">filter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boolean</span><span class="p">)</span> <span class="c1"># condition is rewritten as a boolean filter for the incoming data</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                    <span class="n">next_full_filter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">tovalues</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span> <span class="c1"># filter changed from filter on optimize codec to filter on full codec. (filter on optimize codec was the just how we calculated it, this isn&#39;t an actual method of the module)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                    <span class="n">full_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">full_filter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">next_full_filter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_filter</span><span class="p">))]</span> <span class="c1"># full filter is updated each time</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="c1">## ESSearch._filtered_observation() 3: or_position is taken into account</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                <span class="n">final_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_filter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">or</span> <span class="n">full_filter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_filter</span><span class="p">))]</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="c1">## ESSearch._filtered_observation() 4: Application of the final filter on the incoming Observation</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">obs</span><span class="o">.</span><span class="n">setfilter</span><span class="p">(</span><span class="n">final_filter</span><span class="p">)</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>        <span class="n">obs</span><span class="o">.</span><span class="n">applyfilter</span><span class="p">()</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="k">return</span> <span class="n">obs</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>    <span class="k">def</span> <span class="nf">_condcheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># ajouter la gestion des regex</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">        Takes an item and returns a Boolean if it verifies criteria given by parameter.</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="c1">#cond = {&quot;comparator&quot; : comparator, &quot;operand&quot; : operand, &quot;path&quot; : path} and sometimes can contain other things</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="c1"># 0. Basic cases</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="k">if</span> <span class="s1">&#39;inverted&#39;</span> <span class="ow">in</span> <span class="n">cond</span> <span class="ow">and</span> <span class="n">cond</span><span class="p">[</span><span class="s1">&#39;inverted&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;inverted&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="c1"># 1. formatstring applied if formatstring there is</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="k">if</span> <span class="s2">&quot;formatstring&quot;</span> <span class="ow">in</span> <span class="n">cond</span><span class="p">:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">)):</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                <span class="n">item</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;formatstring&quot;</span><span class="p">])</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">)):</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;formatstring&quot;</span><span class="p">])</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="c1"># 2. Cases TimeSlot, geometry and nested property need specific treatment</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">):</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="n">TimeSlot</span><span class="p">):</span> <span class="c1"># if comparator is one of the specific operators for TimeSlot</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dico_alias_python</span><span class="p">[</span><span class="n">TimeSlot</span><span class="p">][</span><span class="n">TimeSlot</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]]</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># if operand is a datetime</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">dico_alias_python</span><span class="p">[</span><span class="n">TimeSlot</span><span class="p">][</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]](</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparator not supported for TimeSlot.&quot;</span><span class="p">)</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseGeometry</span><span class="p">):</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># lists are interpreted as geometries</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span> <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                        <span class="n">item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                    <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span><span class="n">item</span><span class="p">])</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># lists are interpreted as geometries</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                    <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                        <span class="n">item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                    <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span><span class="n">item</span><span class="p">])</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>            <span class="k">return</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]](</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="k">elif</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;property&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># assuming that property contains dicts and that the query targets one of its values</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cond</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}):</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="c1"># 3. General comparison for remaining cases</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]](</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="c1">#raise ValueError(&quot;Comparator not supported.&quot;)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>    <span class="k">def</span> <span class="nf">_fusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obsList</span><span class="p">,</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># Idalement, utiliser une mthode fusion de Observation.</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">        Takes a list of observations and returns one observation merging them together in one single observation.</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="c1">## ESSearch._fusion() 0: Basic cases</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="k">if</span>   <span class="nb">len</span><span class="p">(</span><span class="n">obsList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">Observation</span><span class="p">()</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">Observation</span><span class="p">(</span><span class="n">obsList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Fusion of a list with more than one element</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>            <span class="n">lidx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="c1">## ESSearch._fusion() 1: Determination of the names of the columns</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="n">new_lname</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsList</span><span class="p">:</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>                <span class="n">new_lname</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">new_lname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_lname</span><span class="p">)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>            
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1">## ESSearch._fusion() 2: Fill the columns with the values of the observations to merge</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_lname</span><span class="p">)):</span> <span class="c1"># for each column of the new Observation</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>                <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsList</span><span class="p">:</span> <span class="c1"># for each Observation in the list</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>                    <span class="k">if</span> <span class="n">new_lname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">:</span> <span class="n">values</span> <span class="o">+=</span> <span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">new_lname</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># values of the column are added to the new column</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">values</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="c1"># when there is no value, filled with fillvalue</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>                <span class="n">codec</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">tocodec</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>                <span class="n">lidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Iindex</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">new_lname</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">util</span><span class="o">.</span><span class="n">tokeys</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">codec</span><span class="p">)))</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="c1">## ESSearch._fusion() 3: Build the actual Observation</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="k">return</span> <span class="n">Observation</span><span class="p">(</span><span class="n">lidx</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="c1"># Il y aurait peut-tre moyen d&#39;optimiser un peu en remplaant Iindex, util.tokeys et l&#39;appel final d&#39;Observation par des manipulations directes sur les objets.</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>            <span class="c1"># faire la fusion directement sur les keys au lieu de la faire sur les codec ?</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>            <span class="c1"># Avec la mthode actuelle, certaines oprations sont faites plusieurs fois.</span>
</span></pre></div>


            </section>
                <section id="insert_from_doc">
                            <input id="insert_from_doc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">insert_from_doc</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">collection</span>, </span><span class="param"><span class="n">document</span>, </span><span class="param"><span class="n">info</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="insert_from_doc-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#insert_from_doc"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="insert_from_doc-192"><a href="#insert_from_doc-192"><span class="linenos">192</span></a><span class="k">def</span> <span class="nf">insert_from_doc</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">document</span> <span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="insert_from_doc-193"><a href="#insert_from_doc-193"><span class="linenos">193</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Inserts all observations from a document into a collection, where each line of the document corresponds to an observation.&#39;&#39;&#39;</span>
</span><span id="insert_from_doc-194"><a href="#insert_from_doc-194"><span class="linenos">194</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">doc</span><span class="p">:</span>
</span><span id="insert_from_doc-195"><a href="#insert_from_doc-195"><span class="linenos">195</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
</span><span id="insert_from_doc-196"><a href="#insert_from_doc-196"><span class="linenos">196</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">insert_to_mongo</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span><span id="insert_from_doc-197"><a href="#insert_from_doc-197"><span class="linenos">197</span></a>            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Inserts all observations from a document into a collection, where each line of the document corresponds to an observation.</p>
</div>


                </section>
                <section id="insert_to_mongo">
                            <input id="insert_to_mongo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">insert_to_mongo</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">collection</span>, </span><span class="param"><span class="n">obj</span>, </span><span class="param"><span class="n">info</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="insert_to_mongo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#insert_to_mongo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="insert_to_mongo-199"><a href="#insert_to_mongo-199"><span class="linenos">199</span></a><span class="k">def</span> <span class="nf">insert_to_mongo</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># Mieux avec panda ?</span>
</span><span id="insert_to_mongo-200"><a href="#insert_to_mongo-200"><span class="linenos">200</span></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Takes an observation or a list of observations and inserts them into a MongoDB collection, with info by default.&#39;&#39;&#39;</span>
</span><span id="insert_to_mongo-201"><a href="#insert_to_mongo-201"><span class="linenos">201</span></a>    <span class="c1"># Faire une fonction pour permettre l&#39;ajout direct de fichiers csv.</span>
</span><span id="insert_to_mongo-202"><a href="#insert_to_mongo-202"><span class="linenos">202</span></a>    <span class="n">inserted_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="insert_to_mongo-203"><a href="#insert_to_mongo-203"><span class="linenos">203</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="insert_to_mongo-204"><a href="#insert_to_mongo-204"><span class="linenos">204</span></a>        <span class="n">pile</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="insert_to_mongo-205"><a href="#insert_to_mongo-205"><span class="linenos">205</span></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Observation</span><span class="p">):</span>
</span><span id="insert_to_mongo-206"><a href="#insert_to_mongo-206"><span class="linenos">206</span></a>        <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span>
</span><span id="insert_to_mongo-207"><a href="#insert_to_mongo-207"><span class="linenos">207</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="insert_to_mongo-208"><a href="#insert_to_mongo-208"><span class="linenos">208</span></a>        <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span>
</span><span id="insert_to_mongo-209"><a href="#insert_to_mongo-209"><span class="linenos">209</span></a>    <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">pile</span><span class="p">:</span>
</span><span id="insert_to_mongo-210"><a href="#insert_to_mongo-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">obs_hash</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">id</span>
</span><span id="insert_to_mongo-211"><a href="#insert_to_mongo-211"><span class="linenos">211</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">obs_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</span><span id="insert_to_mongo-212"><a href="#insert_to_mongo-212"><span class="linenos">212</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">obs_hash</span><span class="p">}</span>
</span><span id="insert_to_mongo-213"><a href="#insert_to_mongo-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">name</span>
</span><span id="insert_to_mongo-214"><a href="#insert_to_mongo-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">param</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">param</span>
</span><span id="insert_to_mongo-215"><a href="#insert_to_mongo-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;information&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Observation</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="insert_to_mongo-216"><a href="#insert_to_mongo-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># a special case is needed because lists with one element are replaced by the element itself so iteration doesn&#39;t work</span>
</span><span id="insert_to_mongo-217"><a href="#insert_to_mongo-217"><span class="linenos">217</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">:</span>
</span><span id="insert_to_mongo-218"><a href="#insert_to_mongo-218"><span class="linenos">218</span></a>                <span class="n">inserted_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">util</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">encoded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typevalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simpleval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geojson</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="insert_to_mongo-219"><a href="#insert_to_mongo-219"><span class="linenos">219</span></a>                                        <span class="s1">&#39;_metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">})</span>
</span><span id="insert_to_mongo-220"><a href="#insert_to_mongo-220"><span class="linenos">220</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="insert_to_mongo-221"><a href="#insert_to_mongo-221"><span class="linenos">221</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">:</span>
</span><span id="insert_to_mongo-222"><a href="#insert_to_mongo-222"><span class="linenos">222</span></a>                <span class="n">inserted_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">util</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">encoded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typevalue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simpleval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geojson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span><span id="insert_to_mongo-223"><a href="#insert_to_mongo-223"><span class="linenos">223</span></a>                                                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))}</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;_metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">})</span>
</span><span id="insert_to_mongo-224"><a href="#insert_to_mongo-224"><span class="linenos">224</span></a>    <span class="k">if</span> <span class="n">inserted_list</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">inserted_list</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Takes an observation or a list of observations and inserts them into a MongoDB collection, with info by default.</p>
</div>


                </section>
                <section id="empty_request">
                            <input id="empty_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">empty_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">collection</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="empty_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#empty_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="empty_request-226"><a href="#empty_request-226"><span class="linenos">226</span></a><span class="k">def</span> <span class="nf">empty_request</span><span class="p">(</span><span class="n">collection</span><span class="p">):</span>
</span><span id="empty_request-227"><a href="#empty_request-227"><span class="linenos">227</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="empty_request-228"><a href="#empty_request-228"><span class="linenos">228</span></a><span class="sd">    Empty request to get an idea of what the database contains.</span>
</span><span id="empty_request-229"><a href="#empty_request-229"><span class="linenos">229</span></a><span class="sd">    Currently returns the count of elements in the collection and the name of each column.</span>
</span><span id="empty_request-230"><a href="#empty_request-230"><span class="linenos">230</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="empty_request-231"><a href="#empty_request-231"><span class="linenos">231</span></a>    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="empty_request-232"><a href="#empty_request-232"><span class="linenos">232</span></a>    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="empty_request-233"><a href="#empty_request-233"><span class="linenos">233</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
</span><span id="empty_request-234"><a href="#empty_request-234"><span class="linenos">234</span></a>    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="empty_request-235"><a href="#empty_request-235"><span class="linenos">235</span></a>        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="empty_request-236"><a href="#empty_request-236"><span class="linenos">236</span></a>        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
</span><span id="empty_request-237"><a href="#empty_request-237"><span class="linenos">237</span></a>            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
</span><span id="empty_request-238"><a href="#empty_request-238"><span class="linenos">238</span></a>                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
</span><span id="empty_request-239"><a href="#empty_request-239"><span class="linenos">239</span></a>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;column_names&#39;</span><span class="p">:</span> <span class="n">column_names</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Empty request to get an idea of what the database contains.
Currently returns the count of elements in the collection and the name of each column.</p>
</div>


                </section>
                <section id="ESSearch">
                            <input id="ESSearch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ESSearch</span>:

                <label class="view-source-button" for="ESSearch-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch-241"><a href="#ESSearch-241"><span class="linenos"> 241</span></a><span class="k">class</span> <span class="nc">ESSearch</span><span class="p">:</span>
</span><span id="ESSearch-242"><a href="#ESSearch-242"><span class="linenos"> 242</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ESSearch-243"><a href="#ESSearch-243"><span class="linenos"> 243</span></a><span class="sd">    An `ESSearch` is defined as an ensemble of conditions to be used to execute a MongoDB request or any iterable containing only observations.</span>
</span><span id="ESSearch-244"><a href="#ESSearch-244"><span class="linenos"> 244</span></a>
</span><span id="ESSearch-245"><a href="#ESSearch-245"><span class="linenos"> 245</span></a><span class="sd">    *Attributes (for @property, see methods)* :</span>
</span><span id="ESSearch-246"><a href="#ESSearch-246"><span class="linenos"> 246</span></a>
</span><span id="ESSearch-247"><a href="#ESSearch-247"><span class="linenos"> 247</span></a><span class="sd">    - **input** : input on which the query is done. One of or a list of these : </span>
</span><span id="ESSearch-248"><a href="#ESSearch-248"><span class="linenos"> 248</span></a><span class="sd">        - pymongo.collection.Collection</span>
</span><span id="ESSearch-249"><a href="#ESSearch-249"><span class="linenos"> 249</span></a><span class="sd">        - pymongo.cursor.Cursor</span>
</span><span id="ESSearch-250"><a href="#ESSearch-250"><span class="linenos"> 250</span></a><span class="sd">        - pymongo.command_cursor.CommandCursor</span>
</span><span id="ESSearch-251"><a href="#ESSearch-251"><span class="linenos"> 251</span></a><span class="sd">        - Observation (can be defined from a str or a dict)</span>
</span><span id="ESSearch-252"><a href="#ESSearch-252"><span class="linenos"> 252</span></a><span class="sd">    - **parameters** : list of list of conditions for queries, to be interpreted as : parameters = [[cond_1 AND cond_2 AND cond_3] OR [cond_4 AND cond_5 AND cond_6]] where conds are criteria for queries</span>
</span><span id="ESSearch-253"><a href="#ESSearch-253"><span class="linenos"> 253</span></a><span class="sd">    - **hide** : list of paths to hide from the output</span>
</span><span id="ESSearch-254"><a href="#ESSearch-254"><span class="linenos"> 254</span></a><span class="sd">    - **heavy** : boolean indicating whether the request should search for nested values or not. Does not work with geoJSON.</span>
</span><span id="ESSearch-255"><a href="#ESSearch-255"><span class="linenos"> 255</span></a><span class="sd">    - **sources** : attribute used to indicate the sources of the data in param</span>
</span><span id="ESSearch-256"><a href="#ESSearch-256"><span class="linenos"> 256</span></a>
</span><span id="ESSearch-257"><a href="#ESSearch-257"><span class="linenos"> 257</span></a><span class="sd">    The methods defined in this class are (documentations in methods definitions):</span>
</span><span id="ESSearch-258"><a href="#ESSearch-258"><span class="linenos"> 258</span></a><span class="sd">    </span>
</span><span id="ESSearch-259"><a href="#ESSearch-259"><span class="linenos"> 259</span></a><span class="sd">    *setter*</span>
</span><span id="ESSearch-260"><a href="#ESSearch-260"><span class="linenos"> 260</span></a>
</span><span id="ESSearch-261"><a href="#ESSearch-261"><span class="linenos"> 261</span></a><span class="sd">    - `ESSearch.addInput`</span>
</span><span id="ESSearch-262"><a href="#ESSearch-262"><span class="linenos"> 262</span></a><span class="sd">    - `ESSearch.removeInputs`</span>
</span><span id="ESSearch-263"><a href="#ESSearch-263"><span class="linenos"> 263</span></a><span class="sd">    - `ESSearch.setHide`</span>
</span><span id="ESSearch-264"><a href="#ESSearch-264"><span class="linenos"> 264</span></a><span class="sd">    - `ESSearch.setHeavy`</span>
</span><span id="ESSearch-265"><a href="#ESSearch-265"><span class="linenos"> 265</span></a><span class="sd">    - `ESSearch.clear`</span>
</span><span id="ESSearch-266"><a href="#ESSearch-266"><span class="linenos"> 266</span></a><span class="sd">    </span>
</span><span id="ESSearch-267"><a href="#ESSearch-267"><span class="linenos"> 267</span></a><span class="sd">    *dynamic value (getter @property)*</span>
</span><span id="ESSearch-268"><a href="#ESSearch-268"><span class="linenos"> 268</span></a>
</span><span id="ESSearch-269"><a href="#ESSearch-269"><span class="linenos"> 269</span></a><span class="sd">    - `ESSearch.request`</span>
</span><span id="ESSearch-270"><a href="#ESSearch-270"><span class="linenos"> 270</span></a><span class="sd">    - `ESSearch.cursor`</span>
</span><span id="ESSearch-271"><a href="#ESSearch-271"><span class="linenos"> 271</span></a><span class="sd">    </span>
</span><span id="ESSearch-272"><a href="#ESSearch-272"><span class="linenos"> 272</span></a><span class="sd">    *parameters for query - update methods*</span>
</span><span id="ESSearch-273"><a href="#ESSearch-273"><span class="linenos"> 273</span></a>
</span><span id="ESSearch-274"><a href="#ESSearch-274"><span class="linenos"> 274</span></a><span class="sd">    - `ESSearch.addConditions`</span>
</span><span id="ESSearch-275"><a href="#ESSearch-275"><span class="linenos"> 275</span></a><span class="sd">    - `ESSearch.addCondition`</span>
</span><span id="ESSearch-276"><a href="#ESSearch-276"><span class="linenos"> 276</span></a><span class="sd">    - `ESSearch.orCondition`</span>
</span><span id="ESSearch-277"><a href="#ESSearch-277"><span class="linenos"> 277</span></a><span class="sd">    - `ESSearch.removeCondition`</span>
</span><span id="ESSearch-278"><a href="#ESSearch-278"><span class="linenos"> 278</span></a><span class="sd">    - `ESSearch.clearConditions`</span>
</span><span id="ESSearch-279"><a href="#ESSearch-279"><span class="linenos"> 279</span></a>
</span><span id="ESSearch-280"><a href="#ESSearch-280"><span class="linenos"> 280</span></a><span class="sd">    *query method*</span>
</span><span id="ESSearch-281"><a href="#ESSearch-281"><span class="linenos"> 281</span></a>
</span><span id="ESSearch-282"><a href="#ESSearch-282"><span class="linenos"> 282</span></a><span class="sd">    - `ESSearch.execute`</span>
</span><span id="ESSearch-283"><a href="#ESSearch-283"><span class="linenos"> 283</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ESSearch-284"><a href="#ESSearch-284"><span class="linenos"> 284</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ESSearch-285"><a href="#ESSearch-285"><span class="linenos"> 285</span></a>                    <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ESSearch-286"><a href="#ESSearch-286"><span class="linenos"> 286</span></a>                    <span class="n">parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ESSearch-287"><a href="#ESSearch-287"><span class="linenos"> 287</span></a>                    <span class="n">hide</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="ESSearch-288"><a href="#ESSearch-288"><span class="linenos"> 288</span></a>                    <span class="n">heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="ESSearch-289"><a href="#ESSearch-289"><span class="linenos"> 289</span></a>                    <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="ESSearch-290"><a href="#ESSearch-290"><span class="linenos"> 290</span></a>                    <span class="o">**</span><span class="n">kwargs</span>
</span><span id="ESSearch-291"><a href="#ESSearch-291"><span class="linenos"> 291</span></a>                    <span class="p">):</span>
</span><span id="ESSearch-292"><a href="#ESSearch-292"><span class="linenos"> 292</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-293"><a href="#ESSearch-293"><span class="linenos"> 293</span></a><span class="sd">        ESSearch constructor. Parameters can also be defined and updated using class methods.</span>
</span><span id="ESSearch-294"><a href="#ESSearch-294"><span class="linenos"> 294</span></a>
</span><span id="ESSearch-295"><a href="#ESSearch-295"><span class="linenos"> 295</span></a><span class="sd">        *Arguments*</span>
</span><span id="ESSearch-296"><a href="#ESSearch-296"><span class="linenos"> 296</span></a>
</span><span id="ESSearch-297"><a href="#ESSearch-297"><span class="linenos"> 297</span></a><span class="sd">        - **input** : input on which the query is done. Must be one of or a list of these (can be nested):</span>
</span><span id="ESSearch-298"><a href="#ESSearch-298"><span class="linenos"> 298</span></a><span class="sd">            - pymongo.collection.Collection</span>
</span><span id="ESSearch-299"><a href="#ESSearch-299"><span class="linenos"> 299</span></a><span class="sd">            - pymongo.cursor.Cursor</span>
</span><span id="ESSearch-300"><a href="#ESSearch-300"><span class="linenos"> 300</span></a><span class="sd">            - pymongo.command_cursor.CommandCursor</span>
</span><span id="ESSearch-301"><a href="#ESSearch-301"><span class="linenos"> 301</span></a><span class="sd">            - Observation</span>
</span><span id="ESSearch-302"><a href="#ESSearch-302"><span class="linenos"> 302</span></a><span class="sd">            - str corresponding to a json Observation</span>
</span><span id="ESSearch-303"><a href="#ESSearch-303"><span class="linenos"> 303</span></a><span class="sd">            - dict corresponding to a json Observation</span>
</span><span id="ESSearch-304"><a href="#ESSearch-304"><span class="linenos"> 304</span></a><span class="sd">        - **parameters** :  dict, list (default None) - list of list or list of dictionnaries whose keys are arguments of ESSearch.addCondition method</span>
</span><span id="ESSearch-305"><a href="#ESSearch-305"><span class="linenos"> 305</span></a><span class="sd">        ex: parameters = [</span>
</span><span id="ESSearch-306"><a href="#ESSearch-306"><span class="linenos"> 306</span></a><span class="sd">            {&#39;name&#39; : &#39;datation&#39;, &#39;operand&#39; : datetime.datetime(2022, 9, 19, 1), &#39;comparator&#39; : &#39;&gt;=&#39;},</span>
</span><span id="ESSearch-307"><a href="#ESSearch-307"><span class="linenos"> 307</span></a><span class="sd">            {&#39;name&#39; : &#39;property&#39;, &#39;operand&#39; : &#39;PM2&#39;}</span>
</span><span id="ESSearch-308"><a href="#ESSearch-308"><span class="linenos"> 308</span></a><span class="sd">        ]</span>
</span><span id="ESSearch-309"><a href="#ESSearch-309"><span class="linenos"> 309</span></a><span class="sd">        - **hide** : list (default []) - List of strings where strings correspond to paths to remove from the output</span>
</span><span id="ESSearch-310"><a href="#ESSearch-310"><span class="linenos"> 310</span></a><span class="sd">        - **heavy** :  bool (default False) - Must be True when values are defined directly and inside dictionnaries simultaneously.</span>
</span><span id="ESSearch-311"><a href="#ESSearch-311"><span class="linenos"> 311</span></a><span class="sd">        - **sources** : (default None) - Optional parameter indicating the sources of the data in case when a query is executed with parameter single = True.</span>
</span><span id="ESSearch-312"><a href="#ESSearch-312"><span class="linenos"> 312</span></a><span class="sd">        - **kwargs** :  other parameters are used as arguments for ESSearch.addCondition method.</span>
</span><span id="ESSearch-313"><a href="#ESSearch-313"><span class="linenos"> 313</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-314"><a href="#ESSearch-314"><span class="linenos"> 314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>                                          <span class="c1"># self.parameters</span>
</span><span id="ESSearch-315"><a href="#ESSearch-315"><span class="linenos"> 315</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span>                     <span class="c1"># self.hide</span>
</span><span id="ESSearch-316"><a href="#ESSearch-316"><span class="linenos"> 316</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;hide must be a list.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-317"><a href="#ESSearch-317"><span class="linenos"> 317</span></a>
</span><span id="ESSearch-318"><a href="#ESSearch-318"><span class="linenos"> 318</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heavy</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="o">=</span> <span class="n">heavy</span>                  <span class="c1"># self.heavy</span>
</span><span id="ESSearch-319"><a href="#ESSearch-319"><span class="linenos"> 319</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;heavy must be a bool.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-320"><a href="#ESSearch-320"><span class="linenos"> 320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>                                          <span class="c1"># self.sources</span>
</span><span id="ESSearch-321"><a href="#ESSearch-321"><span class="linenos"> 321</span></a>
</span><span id="ESSearch-322"><a href="#ESSearch-322"><span class="linenos"> 322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>                                           <span class="c1"># self.input : formatted as [[Mongo Objects], [Observations]] (list of two lists)</span>
</span><span id="ESSearch-323"><a href="#ESSearch-323"><span class="linenos"> 323</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">pile</span> <span class="o">=</span> <span class="nb">input</span>
</span><span id="ESSearch-324"><a href="#ESSearch-324"><span class="linenos"> 324</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
</span><span id="ESSearch-325"><a href="#ESSearch-325"><span class="linenos"> 325</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ESSearch-326"><a href="#ESSearch-326"><span class="linenos"> 326</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="ESSearch-327"><a href="#ESSearch-327"><span class="linenos"> 327</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch-328"><a href="#ESSearch-328"><span class="linenos"> 328</span></a>                <span class="n">pile</span> <span class="o">+=</span> <span class="n">obj</span>
</span><span id="ESSearch-329"><a href="#ESSearch-329"><span class="linenos"> 329</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="ESSearch-330"><a href="#ESSearch-330"><span class="linenos"> 330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch-331"><a href="#ESSearch-331"><span class="linenos"> 331</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="n">Observation</span><span class="p">):</span>
</span><span id="ESSearch-332"><a href="#ESSearch-332"><span class="linenos"> 332</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch-333"><a href="#ESSearch-333"><span class="linenos"> 333</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
</span><span id="ESSearch-334"><a href="#ESSearch-334"><span class="linenos"> 334</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ESSearch-335"><a href="#ESSearch-335"><span class="linenos"> 335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch-336"><a href="#ESSearch-336"><span class="linenos"> 336</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="ESSearch-337"><a href="#ESSearch-337"><span class="linenos"> 337</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to an Observation.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-338"><a href="#ESSearch-338"><span class="linenos"> 338</span></a>            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch-339"><a href="#ESSearch-339"><span class="linenos"> 339</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for input &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch-340"><a href="#ESSearch-340"><span class="linenos"> 340</span></a>
</span><span id="ESSearch-341"><a href="#ESSearch-341"><span class="linenos"> 341</span></a>        <span class="k">if</span> <span class="n">parameters</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addConditions</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="ESSearch-342"><a href="#ESSearch-342"><span class="linenos"> 342</span></a>        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ESSearch-343"><a href="#ESSearch-343"><span class="linenos"> 343</span></a>
</span><span id="ESSearch-344"><a href="#ESSearch-344"><span class="linenos"> 344</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-345"><a href="#ESSearch-345"><span class="linenos"> 345</span></a>        <span class="k">return</span> <span class="s2">&quot;ESSearch(input = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, parameters = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</span><span id="ESSearch-346"><a href="#ESSearch-346"><span class="linenos"> 346</span></a>
</span><span id="ESSearch-347"><a href="#ESSearch-347"><span class="linenos"> 347</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-348"><a href="#ESSearch-348"><span class="linenos"> 348</span></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="ESSearch-349"><a href="#ESSearch-349"><span class="linenos"> 349</span></a>
</span><span id="ESSearch-350"><a href="#ESSearch-350"><span class="linenos"> 350</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-351"><a href="#ESSearch-351"><span class="linenos"> 351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="ESSearch-352"><a href="#ESSearch-352"><span class="linenos"> 352</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="ESSearch-353"><a href="#ESSearch-353"><span class="linenos"> 353</span></a>
</span><span id="ESSearch-354"><a href="#ESSearch-354"><span class="linenos"> 354</span></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-355"><a href="#ESSearch-355"><span class="linenos"> 355</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch-356"><a href="#ESSearch-356"><span class="linenos"> 356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ESSearch-357"><a href="#ESSearch-357"><span class="linenos"> 357</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>
</span><span id="ESSearch-358"><a href="#ESSearch-358"><span class="linenos"> 358</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-359"><a href="#ESSearch-359"><span class="linenos"> 359</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="ESSearch-360"><a href="#ESSearch-360"><span class="linenos"> 360</span></a>
</span><span id="ESSearch-361"><a href="#ESSearch-361"><span class="linenos"> 361</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="ESSearch-362"><a href="#ESSearch-362"><span class="linenos"> 362</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="ESSearch-363"><a href="#ESSearch-363"><span class="linenos"> 363</span></a>
</span><span id="ESSearch-364"><a href="#ESSearch-364"><span class="linenos"> 364</span></a>    <span class="k">def</span> <span class="nf">addInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span><span id="ESSearch-365"><a href="#ESSearch-365"><span class="linenos"> 365</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ESSearch-366"><a href="#ESSearch-366"><span class="linenos"> 366</span></a><span class="sd">        Adds one or many inputs on which the query is to be executed given by argument input.</span>
</span><span id="ESSearch-367"><a href="#ESSearch-367"><span class="linenos"> 367</span></a><span class="sd">        Inputs can be:</span>
</span><span id="ESSearch-368"><a href="#ESSearch-368"><span class="linenos"> 368</span></a><span class="sd">            - pymongo.collection.Collection</span>
</span><span id="ESSearch-369"><a href="#ESSearch-369"><span class="linenos"> 369</span></a><span class="sd">            - pymongo.cursor.Cursor</span>
</span><span id="ESSearch-370"><a href="#ESSearch-370"><span class="linenos"> 370</span></a><span class="sd">            - pymongo.command_cursor.CommandCursor</span>
</span><span id="ESSearch-371"><a href="#ESSearch-371"><span class="linenos"> 371</span></a><span class="sd">            - Observation</span>
</span><span id="ESSearch-372"><a href="#ESSearch-372"><span class="linenos"> 372</span></a><span class="sd">            - str corresponding to a json Observation</span>
</span><span id="ESSearch-373"><a href="#ESSearch-373"><span class="linenos"> 373</span></a><span class="sd">            - dict corresponding to a json Observation</span>
</span><span id="ESSearch-374"><a href="#ESSearch-374"><span class="linenos"> 374</span></a><span class="sd">        or a list of any of these.</span>
</span><span id="ESSearch-375"><a href="#ESSearch-375"><span class="linenos"> 375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ESSearch-376"><a href="#ESSearch-376"><span class="linenos"> 376</span></a>        <span class="n">added_input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
</span><span id="ESSearch-377"><a href="#ESSearch-377"><span class="linenos"> 377</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">pile</span> <span class="o">=</span> <span class="nb">input</span>
</span><span id="ESSearch-378"><a href="#ESSearch-378"><span class="linenos"> 378</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
</span><span id="ESSearch-379"><a href="#ESSearch-379"><span class="linenos"> 379</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># using a stack (LIFO) to allow easy treatment of nested data.</span>
</span><span id="ESSearch-380"><a href="#ESSearch-380"><span class="linenos"> 380</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="ESSearch-381"><a href="#ESSearch-381"><span class="linenos"> 381</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch-382"><a href="#ESSearch-382"><span class="linenos"> 382</span></a>                <span class="n">pile</span> <span class="o">+=</span> <span class="n">obj</span>
</span><span id="ESSearch-383"><a href="#ESSearch-383"><span class="linenos"> 383</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="ESSearch-384"><a href="#ESSearch-384"><span class="linenos"> 384</span></a>                <span class="n">added_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch-385"><a href="#ESSearch-385"><span class="linenos"> 385</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="n">Observation</span><span class="p">):</span>
</span><span id="ESSearch-386"><a href="#ESSearch-386"><span class="linenos"> 386</span></a>                <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch-387"><a href="#ESSearch-387"><span class="linenos"> 387</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
</span><span id="ESSearch-388"><a href="#ESSearch-388"><span class="linenos"> 388</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ESSearch-389"><a href="#ESSearch-389"><span class="linenos"> 389</span></a>                    <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch-390"><a href="#ESSearch-390"><span class="linenos"> 390</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="ESSearch-391"><a href="#ESSearch-391"><span class="linenos"> 391</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to an Observation.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-392"><a href="#ESSearch-392"><span class="linenos"> 392</span></a>            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch-393"><a href="#ESSearch-393"><span class="linenos"> 393</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for input &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch-394"><a href="#ESSearch-394"><span class="linenos"> 394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">added_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># self.input is updated with the new inputs</span>
</span><span id="ESSearch-395"><a href="#ESSearch-395"><span class="linenos"> 395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ESSearch-396"><a href="#ESSearch-396"><span class="linenos"> 396</span></a>
</span><span id="ESSearch-397"><a href="#ESSearch-397"><span class="linenos"> 397</span></a>    <span class="k">def</span> <span class="nf">removeInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-398"><a href="#ESSearch-398"><span class="linenos"> 398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ESSearch-399"><a href="#ESSearch-399"><span class="linenos"> 399</span></a><span class="sd">        Removes all inputs from self.</span>
</span><span id="ESSearch-400"><a href="#ESSearch-400"><span class="linenos"> 400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ESSearch-401"><a href="#ESSearch-401"><span class="linenos"> 401</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
</span><span id="ESSearch-402"><a href="#ESSearch-402"><span class="linenos"> 402</span></a>
</span><span id="ESSearch-403"><a href="#ESSearch-403"><span class="linenos"> 403</span></a>    <span class="k">def</span> <span class="nf">setHide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hide</span><span class="p">):</span>
</span><span id="ESSearch-404"><a href="#ESSearch-404"><span class="linenos"> 404</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-405"><a href="#ESSearch-405"><span class="linenos"> 405</span></a><span class="sd">        Sets self.hide to a value given by argument hide.</span>
</span><span id="ESSearch-406"><a href="#ESSearch-406"><span class="linenos"> 406</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-407"><a href="#ESSearch-407"><span class="linenos"> 407</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span>
</span><span id="ESSearch-408"><a href="#ESSearch-408"><span class="linenos"> 408</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;hide must be a list.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-409"><a href="#ESSearch-409"><span class="linenos"> 409</span></a>        
</span><span id="ESSearch-410"><a href="#ESSearch-410"><span class="linenos"> 410</span></a>    <span class="k">def</span> <span class="nf">setHeavy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heavy</span><span class="p">):</span>
</span><span id="ESSearch-411"><a href="#ESSearch-411"><span class="linenos"> 411</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-412"><a href="#ESSearch-412"><span class="linenos"> 412</span></a><span class="sd">        Sets self.heavy to a value given by argument heavy.</span>
</span><span id="ESSearch-413"><a href="#ESSearch-413"><span class="linenos"> 413</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-414"><a href="#ESSearch-414"><span class="linenos"> 414</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heavy</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="o">=</span> <span class="n">heavy</span>
</span><span id="ESSearch-415"><a href="#ESSearch-415"><span class="linenos"> 415</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;heavy must be a bool.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-416"><a href="#ESSearch-416"><span class="linenos"> 416</span></a>
</span><span id="ESSearch-417"><a href="#ESSearch-417"><span class="linenos"> 417</span></a>    <span class="k">def</span> <span class="nf">setSources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
</span><span id="ESSearch-418"><a href="#ESSearch-418"><span class="linenos"> 418</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-419"><a href="#ESSearch-419"><span class="linenos"> 419</span></a><span class="sd">        Sets self.sources to a value given by argument sources.</span>
</span><span id="ESSearch-420"><a href="#ESSearch-420"><span class="linenos"> 420</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-421"><a href="#ESSearch-421"><span class="linenos"> 421</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
</span><span id="ESSearch-422"><a href="#ESSearch-422"><span class="linenos"> 422</span></a>
</span><span id="ESSearch-423"><a href="#ESSearch-423"><span class="linenos"> 423</span></a>    <span class="k">def</span> <span class="nf">addConditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
</span><span id="ESSearch-424"><a href="#ESSearch-424"><span class="linenos"> 424</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-425"><a href="#ESSearch-425"><span class="linenos"> 425</span></a><span class="sd">        Takes multiple parameters and applies self.addCondition() on each of them.</span>
</span><span id="ESSearch-426"><a href="#ESSearch-426"><span class="linenos"> 426</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-427"><a href="#ESSearch-427"><span class="linenos"> 427</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># case when one single condition is added</span>
</span><span id="ESSearch-428"><a href="#ESSearch-428"><span class="linenos"> 428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="ESSearch-429"><a href="#ESSearch-429"><span class="linenos"> 429</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="c1"># case when several conditions are added</span>
</span><span id="ESSearch-430"><a href="#ESSearch-430"><span class="linenos"> 430</span></a>            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
</span><span id="ESSearch-431"><a href="#ESSearch-431"><span class="linenos"> 431</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="ESSearch-432"><a href="#ESSearch-432"><span class="linenos"> 432</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">*</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="ESSearch-433"><a href="#ESSearch-433"><span class="linenos"> 433</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="ESSearch-434"><a href="#ESSearch-434"><span class="linenos"> 434</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;parameters must be either a dict or a list of dict.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-435"><a href="#ESSearch-435"><span class="linenos"> 435</span></a>            
</span><span id="ESSearch-436"><a href="#ESSearch-436"><span class="linenos"> 436</span></a>    <span class="k">def</span> <span class="nf">addCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">operand</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comparator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">or_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ESSearch-437"><a href="#ESSearch-437"><span class="linenos"> 437</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-438"><a href="#ESSearch-438"><span class="linenos"> 438</span></a><span class="sd">        Takes parameters and inserts corresponding query condition in self.parameters.</span>
</span><span id="ESSearch-439"><a href="#ESSearch-439"><span class="linenos"> 439</span></a>
</span><span id="ESSearch-440"><a href="#ESSearch-440"><span class="linenos"> 440</span></a><span class="sd">        *Parameters*</span>
</span><span id="ESSearch-441"><a href="#ESSearch-441"><span class="linenos"> 441</span></a>
</span><span id="ESSearch-442"><a href="#ESSearch-442"><span class="linenos"> 442</span></a><span class="sd">        - **path** :  str (required argument) - name of an IIndex, which corresponds to an Ilist column name, or name of a metadata element.</span>
</span><span id="ESSearch-443"><a href="#ESSearch-443"><span class="linenos"> 443</span></a><span class="sd">                    (ex: &#39;datation&#39;, &#39;location&#39;, &#39;property&#39;)</span>
</span><span id="ESSearch-444"><a href="#ESSearch-444"><span class="linenos"> 444</span></a>
</span><span id="ESSearch-445"><a href="#ESSearch-445"><span class="linenos"> 445</span></a><span class="sd">        - **operand** :  - (default None) - Object used for the comparison.</span>
</span><span id="ESSearch-446"><a href="#ESSearch-446"><span class="linenos"> 446</span></a><span class="sd">                    (ex: if we search for observations made in Paris, operand is &#39;Paris&#39;)</span>
</span><span id="ESSearch-447"><a href="#ESSearch-447"><span class="linenos"> 447</span></a>
</span><span id="ESSearch-448"><a href="#ESSearch-448"><span class="linenos"> 448</span></a><span class="sd">        - **comparator**:  str (default None) - str giving the comparator to use. (ex: &#39;&gt;=&#39;, &#39;in&#39;)</span>
</span><span id="ESSearch-449"><a href="#ESSearch-449"><span class="linenos"> 449</span></a><span class="sd">        </span>
</span><span id="ESSearch-450"><a href="#ESSearch-450"><span class="linenos"> 450</span></a><span class="sd">        - **or_position** :  int (default -1) - position in self.parameters in which the condition is to be inserted.</span>
</span><span id="ESSearch-451"><a href="#ESSearch-451"><span class="linenos"> 451</span></a>
</span><span id="ESSearch-452"><a href="#ESSearch-452"><span class="linenos"> 452</span></a><span class="sd">        - **formatstring** :  str (default None) - str to use to automatically change str to datetime before applying condition.</span>
</span><span id="ESSearch-453"><a href="#ESSearch-453"><span class="linenos"> 453</span></a><span class="sd">                    Does not update the data base. If value is set to &#39;default&#39;, format is assumed to be Isoformat.</span>
</span><span id="ESSearch-454"><a href="#ESSearch-454"><span class="linenos"> 454</span></a><span class="sd">        </span>
</span><span id="ESSearch-455"><a href="#ESSearch-455"><span class="linenos"> 455</span></a><span class="sd">        - **inverted** :  bool (default None) - to add a &quot;not&quot; in the condition.</span>
</span><span id="ESSearch-456"><a href="#ESSearch-456"><span class="linenos"> 456</span></a><span class="sd">                    To use in case where every element of a MongoDB array (equivalent to python list) must verify the condition (by default, condition is verified when at least one element of the array verifies it).</span>
</span><span id="ESSearch-457"><a href="#ESSearch-457"><span class="linenos"> 457</span></a><span class="sd">        </span>
</span><span id="ESSearch-458"><a href="#ESSearch-458"><span class="linenos"> 458</span></a><span class="sd">        - **unwind** :  int (default None) - int corresponding to the number of additional {&quot;$unwind&quot; : &quot;$&quot; + path} to be added in the beginning of the query.</span>
</span><span id="ESSearch-459"><a href="#ESSearch-459"><span class="linenos"> 459</span></a><span class="sd">        </span>
</span><span id="ESSearch-460"><a href="#ESSearch-460"><span class="linenos"> 460</span></a><span class="sd">        - **regex_options** :  str (default None) - str associated to regex options (i, m, x and s). See [this link](https://www.mongodb.com/docs/manual/reference/operator/query/regex/) for more details.</span>
</span><span id="ESSearch-461"><a href="#ESSearch-461"><span class="linenos"> 461</span></a>
</span><span id="ESSearch-462"><a href="#ESSearch-462"><span class="linenos"> 462</span></a><span class="sd">        no comparator =&gt; default comparator associated with operand type in dico_alias_mongo is used (mainly equality)</span>
</span><span id="ESSearch-463"><a href="#ESSearch-463"><span class="linenos"> 463</span></a><span class="sd">        no operand =&gt; only the existence of something located at path is tested</span>
</span><span id="ESSearch-464"><a href="#ESSearch-464"><span class="linenos"> 464</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-465"><a href="#ESSearch-465"><span class="linenos"> 465</span></a>
</span><span id="ESSearch-466"><a href="#ESSearch-466"><span class="linenos"> 466</span></a>        <span class="c1">## 1. Check if arguments given are valid.</span>
</span><span id="ESSearch-467"><a href="#ESSearch-467"><span class="linenos"> 467</span></a>
</span><span id="ESSearch-468"><a href="#ESSearch-468"><span class="linenos"> 468</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name must be a str.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-469"><a href="#ESSearch-469"><span class="linenos"> 469</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;comparator must be a str.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-470"><a href="#ESSearch-470"><span class="linenos"> 470</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">or_position</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;or_position must be an int.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-471"><a href="#ESSearch-471"><span class="linenos"> 471</span></a>
</span><span id="ESSearch-472"><a href="#ESSearch-472"><span class="linenos"> 472</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="c1"># checking if parameters in kwarg do exist</span>
</span><span id="ESSearch-473"><a href="#ESSearch-473"><span class="linenos"> 473</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;formatstring&#39;</span><span class="p">,</span> <span class="s1">&#39;inverted&#39;</span><span class="p">,</span> <span class="s1">&#39;unwind&#39;</span><span class="p">,</span> <span class="s1">&#39;regex_options&#39;</span><span class="p">,</span> <span class="s1">&#39;distanceField&#39;</span><span class="p">,</span> <span class="s1">&#39;distanceMultiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;includeLocs&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;maxDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;minDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;near&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">}:</span>
</span><span id="ESSearch-474"><a href="#ESSearch-474"><span class="linenos"> 474</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown parameter : &quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch-475"><a href="#ESSearch-475"><span class="linenos"> 475</span></a>
</span><span id="ESSearch-476"><a href="#ESSearch-476"><span class="linenos"> 476</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">operand</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ESSearch-477"><a href="#ESSearch-477"><span class="linenos"> 477</span></a>            <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="ESSearch-478"><a href="#ESSearch-478"><span class="linenos"> 478</span></a>
</span><span id="ESSearch-479"><a href="#ESSearch-479"><span class="linenos"> 479</span></a>        <span class="k">if</span> <span class="n">operand</span><span class="p">:</span> <span class="c1"># checking if comparator can be applied on the operand</span>
</span><span id="ESSearch-480"><a href="#ESSearch-480"><span class="linenos"> 480</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">operand</span><span class="p">)][</span><span class="n">comparator</span><span class="p">]</span>
</span><span id="ESSearch-481"><a href="#ESSearch-481"><span class="linenos"> 481</span></a>            <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible values for comparator and operand. Ensure parameters are in the correct order.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-482"><a href="#ESSearch-482"><span class="linenos"> 482</span></a>        <span class="k">elif</span> <span class="n">comparator</span><span class="p">:</span>
</span><span id="ESSearch-483"><a href="#ESSearch-483"><span class="linenos"> 483</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;operand must be defined when comparator is used.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-484"><a href="#ESSearch-484"><span class="linenos"> 484</span></a>        
</span><span id="ESSearch-485"><a href="#ESSearch-485"><span class="linenos"> 485</span></a>        <span class="c1">## 2. Add the condition to self.parameters</span>
</span><span id="ESSearch-486"><a href="#ESSearch-486"><span class="linenos"> 486</span></a>
</span><span id="ESSearch-487"><a href="#ESSearch-487"><span class="linenos"> 487</span></a>        <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;comparator&quot;</span> <span class="p">:</span> <span class="n">comparator</span><span class="p">,</span> <span class="s2">&quot;operand&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span> <span class="p">:</span> <span class="n">path</span><span class="p">}</span> <span class="o">|</span> <span class="n">kwargs</span>
</span><span id="ESSearch-488"><a href="#ESSearch-488"><span class="linenos"> 488</span></a>
</span><span id="ESSearch-489"><a href="#ESSearch-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
</span><span id="ESSearch-490"><a href="#ESSearch-490"><span class="linenos"> 490</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">condition</span><span class="p">])</span>
</span><span id="ESSearch-491"><a href="#ESSearch-491"><span class="linenos"> 491</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-492"><a href="#ESSearch-492"><span class="linenos"> 492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
</span><span id="ESSearch-493"><a href="#ESSearch-493"><span class="linenos"> 493</span></a>
</span><span id="ESSearch-494"><a href="#ESSearch-494"><span class="linenos"> 494</span></a>    <span class="k">def</span> <span class="nf">orCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ESSearch-495"><a href="#ESSearch-495"><span class="linenos"> 495</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-496"><a href="#ESSearch-496"><span class="linenos"> 496</span></a><span class="sd">        Adds a condition in a new sublist in self.parameters. Separations in sublists correspond to &quot;or&quot; in the query.</span>
</span><span id="ESSearch-497"><a href="#ESSearch-497"><span class="linenos"> 497</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-498"><a href="#ESSearch-498"><span class="linenos"> 498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">or_position</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ESSearch-499"><a href="#ESSearch-499"><span class="linenos"> 499</span></a>
</span><span id="ESSearch-500"><a href="#ESSearch-500"><span class="linenos"> 500</span></a>    <span class="k">def</span> <span class="nf">removeCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">or_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">condnum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ESSearch-501"><a href="#ESSearch-501"><span class="linenos"> 501</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-502"><a href="#ESSearch-502"><span class="linenos"> 502</span></a><span class="sd">        Removes a condition from self.parameters. By default, last element added is removed.</span>
</span><span id="ESSearch-503"><a href="#ESSearch-503"><span class="linenos"> 503</span></a><span class="sd">        Otherwise, the removed condition is the one at self.parameters[or_position][condnum].</span>
</span><span id="ESSearch-504"><a href="#ESSearch-504"><span class="linenos"> 504</span></a>
</span><span id="ESSearch-505"><a href="#ESSearch-505"><span class="linenos"> 505</span></a><span class="sd">        To remove all conditions, use ESSearch.clearConditions() method.</span>
</span><span id="ESSearch-506"><a href="#ESSearch-506"><span class="linenos"> 506</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-507"><a href="#ESSearch-507"><span class="linenos"> 507</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[[]]:</span> <span class="k">return</span>
</span><span id="ESSearch-508"><a href="#ESSearch-508"><span class="linenos"> 508</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch-509"><a href="#ESSearch-509"><span class="linenos"> 509</span></a>            <span class="k">if</span> <span class="n">condnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># by default : remove the very last added condition.</span>
</span><span id="ESSearch-510"><a href="#ESSearch-510"><span class="linenos"> 510</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ESSearch-511"><a href="#ESSearch-511"><span class="linenos"> 511</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ESSearch-512"><a href="#ESSearch-512"><span class="linenos"> 512</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-513"><a href="#ESSearch-513"><span class="linenos"> 513</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">condnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">condnum</span><span class="p">)</span>
</span><span id="ESSearch-514"><a href="#ESSearch-514"><span class="linenos"> 514</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ESSearch-515"><a href="#ESSearch-515"><span class="linenos"> 515</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-516"><a href="#ESSearch-516"><span class="linenos"> 516</span></a>            <span class="k">if</span> <span class="n">condnum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">condnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">or_position</span><span class="p">)</span> <span class="c1"># if or_position is not None and condnum is, the whole sublist at or_position is removed.</span>
</span><span id="ESSearch-517"><a href="#ESSearch-517"><span class="linenos"> 517</span></a>            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">condnum</span><span class="p">)</span>
</span><span id="ESSearch-518"><a href="#ESSearch-518"><span class="linenos"> 518</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[]:</span> <span class="c1"># ensure self.parameters returns to its default value after being emptied</span>
</span><span id="ESSearch-519"><a href="#ESSearch-519"><span class="linenos"> 519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>
</span><span id="ESSearch-520"><a href="#ESSearch-520"><span class="linenos"> 520</span></a>
</span><span id="ESSearch-521"><a href="#ESSearch-521"><span class="linenos"> 521</span></a>    <span class="k">def</span> <span class="nf">clearConditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-522"><a href="#ESSearch-522"><span class="linenos"> 522</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-523"><a href="#ESSearch-523"><span class="linenos"> 523</span></a><span class="sd">        Removes all conditions from self.parameters.</span>
</span><span id="ESSearch-524"><a href="#ESSearch-524"><span class="linenos"> 524</span></a><span class="sd">        To remove all attributes, use ESSearch.clear() method.</span>
</span><span id="ESSearch-525"><a href="#ESSearch-525"><span class="linenos"> 525</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-526"><a href="#ESSearch-526"><span class="linenos"> 526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>
</span><span id="ESSearch-527"><a href="#ESSearch-527"><span class="linenos"> 527</span></a>
</span><span id="ESSearch-528"><a href="#ESSearch-528"><span class="linenos"> 528</span></a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-529"><a href="#ESSearch-529"><span class="linenos"> 529</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-530"><a href="#ESSearch-530"><span class="linenos"> 530</span></a><span class="sd">        Resets self.</span>
</span><span id="ESSearch-531"><a href="#ESSearch-531"><span class="linenos"> 531</span></a><span class="sd">        (Creating a new Observation would be smarter than using this function.)</span>
</span><span id="ESSearch-532"><a href="#ESSearch-532"><span class="linenos"> 532</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-533"><a href="#ESSearch-533"><span class="linenos"> 533</span></a>        <span class="bp">self</span> <span class="o">=</span> <span class="n">ESSearch</span><span class="p">()</span>
</span><span id="ESSearch-534"><a href="#ESSearch-534"><span class="linenos"> 534</span></a>
</span><span id="ESSearch-535"><a href="#ESSearch-535"><span class="linenos"> 535</span></a>    <span class="k">def</span> <span class="nf">_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">,</span> <span class="n">comparator</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">inverted</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">formatstring</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unwind</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">regex_options</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ESSearch-536"><a href="#ESSearch-536"><span class="linenos"> 536</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-537"><a href="#ESSearch-537"><span class="linenos"> 537</span></a><span class="sd">        Takes parameters and adds corresponding MongoDB expression to self._match.</span>
</span><span id="ESSearch-538"><a href="#ESSearch-538"><span class="linenos"> 538</span></a><span class="sd">        self._unwind and self._set are updated when necessary.</span>
</span><span id="ESSearch-539"><a href="#ESSearch-539"><span class="linenos"> 539</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-540"><a href="#ESSearch-540"><span class="linenos"> 540</span></a>        <span class="k">if</span> <span class="n">unwind</span><span class="p">:</span>
</span><span id="ESSearch-541"><a href="#ESSearch-541"><span class="linenos"> 541</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unwind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ESSearch-542"><a href="#ESSearch-542"><span class="linenos"> 542</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unwind</span><span class="p">)</span>
</span><span id="ESSearch-543"><a href="#ESSearch-543"><span class="linenos"> 543</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unwind</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="ESSearch-544"><a href="#ESSearch-544"><span class="linenos"> 544</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">unwind</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="ESSearch-545"><a href="#ESSearch-545"><span class="linenos"> 545</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unwind</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># format : (&lt;path&gt;, &lt;unwind quantity&gt;)</span>
</span><span id="ESSearch-546"><a href="#ESSearch-546"><span class="linenos"> 546</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">unwind</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unwind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-547"><a href="#ESSearch-547"><span class="linenos"> 547</span></a>            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;unwind must be a tuple, a str or an int.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-548"><a href="#ESSearch-548"><span class="linenos"> 548</span></a>
</span><span id="ESSearch-549"><a href="#ESSearch-549"><span class="linenos"> 549</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="ow">and</span> <span class="n">operand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch-550"><a href="#ESSearch-550"><span class="linenos"> 550</span></a>            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="c1"># peut-tre mieux de laisser l&#39;utilisateur choisir manuellement</span>
</span><span id="ESSearch-551"><a href="#ESSearch-551"><span class="linenos"> 551</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.v&quot;</span>
</span><span id="ESSearch-552"><a href="#ESSearch-552"><span class="linenos"> 552</span></a>
</span><span id="ESSearch-553"><a href="#ESSearch-553"><span class="linenos"> 553</span></a>        <span class="k">if</span> <span class="n">operand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># no operand =&gt; we only test if there is something located at path</span>
</span><span id="ESSearch-554"><a href="#ESSearch-554"><span class="linenos"> 554</span></a>            <span class="n">comparator</span> <span class="o">=</span> <span class="s2">&quot;$exists&quot;</span>
</span><span id="ESSearch-555"><a href="#ESSearch-555"><span class="linenos"> 555</span></a>            <span class="n">operand</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ESSearch-556"><a href="#ESSearch-556"><span class="linenos"> 556</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-557"><a href="#ESSearch-557"><span class="linenos"> 557</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">operand</span><span class="p">)][</span><span class="n">comparator</span><span class="p">]</span> <span class="c1">#global variable</span>
</span><span id="ESSearch-558"><a href="#ESSearch-558"><span class="linenos"> 558</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="ESSearch-559"><a href="#ESSearch-559"><span class="linenos"> 559</span></a>                <span class="k">if</span> <span class="n">formatstring</span><span class="p">:</span>
</span><span id="ESSearch-560"><a href="#ESSearch-560"><span class="linenos"> 560</span></a>                    <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">][</span><span class="n">comparator</span><span class="p">]</span>
</span><span id="ESSearch-561"><a href="#ESSearch-561"><span class="linenos"> 561</span></a>                    <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparator not allowed.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-562"><a href="#ESSearch-562"><span class="linenos"> 562</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseGeometry</span><span class="p">):</span>
</span><span id="ESSearch-563"><a href="#ESSearch-563"><span class="linenos"> 563</span></a>                    <span class="n">operand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="o">.</span><span class="n">geom_type</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)}</span>
</span><span id="ESSearch-564"><a href="#ESSearch-564"><span class="linenos"> 564</span></a>                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparator not allowed.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-565"><a href="#ESSearch-565"><span class="linenos"> 565</span></a>
</span><span id="ESSearch-566"><a href="#ESSearch-566"><span class="linenos"> 566</span></a>        <span class="c1">##if path in {&quot;$year&quot;, &quot;$month&quot;, &quot;$dayOfMonth&quot;, &quot;$hour&quot;, &quot;$minute&quot;, &quot;$second&quot;, &quot;$millisecond&quot;, &quot;$dayOfYear&quot;, &quot;$dayOfWeek&quot;}:</span>
</span><span id="ESSearch-567"><a href="#ESSearch-567"><span class="linenos"> 567</span></a>        <span class="c1">##    self._set |= {path[1:]: {&#39;datation&#39; : path}} # tester</span>
</span><span id="ESSearch-568"><a href="#ESSearch-568"><span class="linenos"> 568</span></a>        <span class="c1">##    path = datation</span>
</span><span id="ESSearch-569"><a href="#ESSearch-569"><span class="linenos"> 569</span></a>        <span class="c1">##    self._project |= {name[1:]:0}</span>
</span><span id="ESSearch-570"><a href="#ESSearch-570"><span class="linenos"> 570</span></a>
</span><span id="ESSearch-571"><a href="#ESSearch-571"><span class="linenos"> 571</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">):</span> <span class="c1">#equals-&gt;within, contains-&gt;intersects, within, disjoint, intersects</span>
</span><span id="ESSearch-572"><a href="#ESSearch-572"><span class="linenos"> 572</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ESSearch-573"><a href="#ESSearch-573"><span class="linenos"> 573</span></a>            <span class="k">if</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;within&quot;</span><span class="p">:</span>
</span><span id="ESSearch-574"><a href="#ESSearch-574"><span class="linenos"> 574</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="ESSearch-575"><a href="#ESSearch-575"><span class="linenos"> 575</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="ESSearch-576"><a href="#ESSearch-576"><span class="linenos"> 576</span></a>            <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;intersects&quot;</span><span class="p">:</span>
</span><span id="ESSearch-577"><a href="#ESSearch-577"><span class="linenos"> 577</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;$lte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># pourquoi False et pas inverted ici ??</span>
</span><span id="ESSearch-578"><a href="#ESSearch-578"><span class="linenos"> 578</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span><span class="p">,</span> <span class="n">operand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;$gte&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="ESSearch-579"><a href="#ESSearch-579"><span class="linenos"> 579</span></a>            <span class="k">return</span>
</span><span id="ESSearch-580"><a href="#ESSearch-580"><span class="linenos"> 580</span></a>
</span><span id="ESSearch-581"><a href="#ESSearch-581"><span class="linenos"> 581</span></a>        <span class="k">if</span> <span class="n">formatstring</span><span class="p">:</span>
</span><span id="ESSearch-582"><a href="#ESSearch-582"><span class="linenos"> 582</span></a>            <span class="k">if</span> <span class="n">formatstring</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
</span><span id="ESSearch-583"><a href="#ESSearch-583"><span class="linenos"> 583</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ESSearch-584"><a href="#ESSearch-584"><span class="linenos"> 584</span></a>                    <span class="n">operand</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
</span><span id="ESSearch-585"><a href="#ESSearch-585"><span class="linenos"> 585</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">|=</span> <span class="p">{</span><span class="n">path</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$convert&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span> <span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;onError&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">}}}</span>
</span><span id="ESSearch-586"><a href="#ESSearch-586"><span class="linenos"> 586</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-587"><a href="#ESSearch-587"><span class="linenos"> 587</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ESSearch-588"><a href="#ESSearch-588"><span class="linenos"> 588</span></a>                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">formatstring</span><span class="p">)</span>
</span><span id="ESSearch-589"><a href="#ESSearch-589"><span class="linenos"> 589</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">|=</span> <span class="p">{</span><span class="n">path</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$dateFromString&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dateString&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">formatstring</span><span class="p">,</span> <span class="s2">&quot;onError&quot;</span><span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">}}}</span>
</span><span id="ESSearch-590"><a href="#ESSearch-590"><span class="linenos"> 590</span></a>
</span><span id="ESSearch-591"><a href="#ESSearch-591"><span class="linenos"> 591</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$geoIntersects&quot;</span><span class="p">,</span> <span class="s2">&quot;$geoWithin&quot;</span><span class="p">}:</span>  <span class="c1"># operand :</span>
</span><span id="ESSearch-592"><a href="#ESSearch-592"><span class="linenos"> 592</span></a>                                                            <span class="c1"># [x, y] or [[x, y]] -&gt; Point ;</span>
</span><span id="ESSearch-593"><a href="#ESSearch-593"><span class="linenos"> 593</span></a>                                                            <span class="c1"># [[x1, y1], [x2, y2]] -&gt; LineString ;</span>
</span><span id="ESSearch-594"><a href="#ESSearch-594"><span class="linenos"> 594</span></a>                                                            <span class="c1"># [[x1, y1], [x2, y2], [x3, y3], ...] or [[x1, y1], [x2, y2], [x3, y3], ..., [x1, y1]] or [[[x1, y1], [x2, y2], [x3, y3], ..., [x1, y1]]] -&gt; Polygon.</span>
</span><span id="ESSearch-595"><a href="#ESSearch-595"><span class="linenos"> 595</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch-596"><a href="#ESSearch-596"><span class="linenos"> 596</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch-597"><a href="#ESSearch-597"><span class="linenos"> 597</span></a>                    <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Point&quot;</span>
</span><span id="ESSearch-598"><a href="#ESSearch-598"><span class="linenos"> 598</span></a>                    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span>
</span><span id="ESSearch-599"><a href="#ESSearch-599"><span class="linenos"> 599</span></a>                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch-600"><a href="#ESSearch-600"><span class="linenos"> 600</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch-601"><a href="#ESSearch-601"><span class="linenos"> 601</span></a>                        <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Point&quot;</span>
</span><span id="ESSearch-602"><a href="#ESSearch-602"><span class="linenos"> 602</span></a>                        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ESSearch-603"><a href="#ESSearch-603"><span class="linenos"> 603</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ESSearch-604"><a href="#ESSearch-604"><span class="linenos"> 604</span></a>                        <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;LineString&quot;</span>
</span><span id="ESSearch-605"><a href="#ESSearch-605"><span class="linenos"> 605</span></a>                        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span>
</span><span id="ESSearch-606"><a href="#ESSearch-606"><span class="linenos"> 606</span></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ESSearch-607"><a href="#ESSearch-607"><span class="linenos"> 607</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">operand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ESSearch-608"><a href="#ESSearch-608"><span class="linenos"> 608</span></a>                            <span class="n">operand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-609"><a href="#ESSearch-609"><span class="linenos"> 609</span></a>                        <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Polygon&quot;</span>
</span><span id="ESSearch-610"><a href="#ESSearch-610"><span class="linenos"> 610</span></a>                        <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="n">operand</span><span class="p">]</span>
</span><span id="ESSearch-611"><a href="#ESSearch-611"><span class="linenos"> 611</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to define a geometry from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">operand</span><span class="p">))</span>
</span><span id="ESSearch-612"><a href="#ESSearch-612"><span class="linenos"> 612</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-613"><a href="#ESSearch-613"><span class="linenos"> 613</span></a>                    <span class="n">geom_type</span> <span class="o">=</span> <span class="s2">&quot;Polygon&quot;</span>
</span><span id="ESSearch-614"><a href="#ESSearch-614"><span class="linenos"> 614</span></a>                    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">operand</span>
</span><span id="ESSearch-615"><a href="#ESSearch-615"><span class="linenos"> 615</span></a>                <span class="n">operand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$geometry&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="n">geom_type</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span> <span class="p">:</span> <span class="n">coordinates</span><span class="p">}}</span>
</span><span id="ESSearch-616"><a href="#ESSearch-616"><span class="linenos"> 616</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;$geometry&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">operand</span><span class="p">:</span>
</span><span id="ESSearch-617"><a href="#ESSearch-617"><span class="linenos"> 617</span></a>                <span class="n">operand</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$geometry&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">}</span>
</span><span id="ESSearch-618"><a href="#ESSearch-618"><span class="linenos"> 618</span></a>        <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;$geoNear&quot;</span><span class="p">:</span> <span class="c1"># $geoNear is a MongoDB stage</span>
</span><span id="ESSearch-619"><a href="#ESSearch-619"><span class="linenos"> 619</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span> <span class="o">|</span> <span class="n">kwargs</span>
</span><span id="ESSearch-620"><a href="#ESSearch-620"><span class="linenos"> 620</span></a>            <span class="k">if</span> <span class="s1">&#39;distanceField&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;distanceField missing in MongoDB stage $geoNear.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-621"><a href="#ESSearch-621"><span class="linenos"> 621</span></a>            <span class="k">return</span>
</span><span id="ESSearch-622"><a href="#ESSearch-622"><span class="linenos"> 622</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># lists are interpreted as geometries. An additional filtering is necessary for geometry-specific functions</span>
</span><span id="ESSearch-623"><a href="#ESSearch-623"><span class="linenos"> 623</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ESSearch-624"><a href="#ESSearch-624"><span class="linenos"> 624</span></a>            <span class="k">return</span>
</span><span id="ESSearch-625"><a href="#ESSearch-625"><span class="linenos"> 625</span></a>        
</span><span id="ESSearch-626"><a href="#ESSearch-626"><span class="linenos"> 626</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s2">&quot;$regex&quot;</span> <span class="ow">and</span> <span class="n">regex_options</span><span class="p">:</span>
</span><span id="ESSearch-627"><a href="#ESSearch-627"><span class="linenos"> 627</span></a>            <span class="n">cond_0</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">,</span> <span class="s2">&quot;$options&quot;</span> <span class="p">:</span> <span class="n">regex_options</span><span class="p">}</span>
</span><span id="ESSearch-628"><a href="#ESSearch-628"><span class="linenos"> 628</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-629"><a href="#ESSearch-629"><span class="linenos"> 629</span></a>            <span class="n">cond_0</span> <span class="o">=</span> <span class="p">{</span><span class="n">comparator</span> <span class="p">:</span> <span class="n">operand</span><span class="p">}</span>
</span><span id="ESSearch-630"><a href="#ESSearch-630"><span class="linenos"> 630</span></a>        
</span><span id="ESSearch-631"><a href="#ESSearch-631"><span class="linenos"> 631</span></a>        <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
</span><span id="ESSearch-632"><a href="#ESSearch-632"><span class="linenos"> 632</span></a>            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">]:</span>
</span><span id="ESSearch-633"><a href="#ESSearch-633"><span class="linenos"> 633</span></a>                <span class="k">if</span> <span class="s2">&quot;$nor&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]:</span>
</span><span id="ESSearch-634"><a href="#ESSearch-634"><span class="linenos"> 634</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$nor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond_0</span><span class="p">)</span>
</span><span id="ESSearch-635"><a href="#ESSearch-635"><span class="linenos"> 635</span></a>                <span class="k">elif</span> <span class="s2">&quot;not&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]:</span>
</span><span id="ESSearch-636"><a href="#ESSearch-636"><span class="linenos"> 636</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$nor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$not&quot;</span><span class="p">],</span> <span class="n">cond_0</span><span class="p">]</span>
</span><span id="ESSearch-637"><a href="#ESSearch-637"><span class="linenos"> 637</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$not&quot;</span><span class="p">]</span>
</span><span id="ESSearch-638"><a href="#ESSearch-638"><span class="linenos"> 638</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-639"><a href="#ESSearch-639"><span class="linenos"> 639</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">][</span><span class="s2">&quot;$not&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond_0</span>
</span><span id="ESSearch-640"><a href="#ESSearch-640"><span class="linenos"> 640</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-641"><a href="#ESSearch-641"><span class="linenos"> 641</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span> <span class="p">:</span> <span class="n">cond_0</span><span class="p">}</span>
</span><span id="ESSearch-642"><a href="#ESSearch-642"><span class="linenos"> 642</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-643"><a href="#ESSearch-643"><span class="linenos"> 643</span></a>            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">]:</span>
</span><span id="ESSearch-644"><a href="#ESSearch-644"><span class="linenos"> 644</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond_0</span>
</span><span id="ESSearch-645"><a href="#ESSearch-645"><span class="linenos"> 645</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-646"><a href="#ESSearch-646"><span class="linenos"> 646</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">or_pos</span><span class="p">][</span><span class="n">path</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cond_0</span>
</span><span id="ESSearch-647"><a href="#ESSearch-647"><span class="linenos"> 647</span></a>
</span><span id="ESSearch-648"><a href="#ESSearch-648"><span class="linenos"> 648</span></a>    <span class="k">def</span> <span class="nf">_fullSearchMongo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-649"><a href="#ESSearch-649"><span class="linenos"> 649</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ESSearch-650"><a href="#ESSearch-650"><span class="linenos"> 650</span></a><span class="sd">        Takes self.parameters and returns a MongoDB Aggregation query.</span>
</span><span id="ESSearch-651"><a href="#ESSearch-651"><span class="linenos"> 651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ESSearch-652"><a href="#ESSearch-652"><span class="linenos"> 652</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 1: Declare private variables</span>
</span><span id="ESSearch-653"><a href="#ESSearch-653"><span class="linenos"> 653</span></a>
</span><span id="ESSearch-654"><a href="#ESSearch-654"><span class="linenos"> 654</span></a>        <span class="n">request</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-655"><a href="#ESSearch-655"><span class="linenos"> 655</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-656"><a href="#ESSearch-656"><span class="linenos"> 656</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-657"><a href="#ESSearch-657"><span class="linenos"> 657</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span> <span class="c1"># two additional set stages to treat nested objects</span>
</span><span id="ESSearch-658"><a href="#ESSearch-658"><span class="linenos"> 658</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-659"><a href="#ESSearch-659"><span class="linenos"> 659</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-660"><a href="#ESSearch-660"><span class="linenos"> 660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-661"><a href="#ESSearch-661"><span class="linenos"> 661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="ESSearch-662"><a href="#ESSearch-662"><span class="linenos"> 662</span></a>        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">|=</span> <span class="p">{</span><span class="n">el</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="ESSearch-663"><a href="#ESSearch-663"><span class="linenos"> 663</span></a>        
</span><span id="ESSearch-664"><a href="#ESSearch-664"><span class="linenos"> 664</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 2: Update private variables for each condition</span>
</span><span id="ESSearch-665"><a href="#ESSearch-665"><span class="linenos"> 665</span></a>
</span><span id="ESSearch-666"><a href="#ESSearch-666"><span class="linenos"> 666</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)):</span> <span class="c1"># rewriting conditions in MongoDB format</span>
</span><span id="ESSearch-667"><a href="#ESSearch-667"><span class="linenos"> 667</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
</span><span id="ESSearch-668"><a href="#ESSearch-668"><span class="linenos"> 668</span></a>            <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="ESSearch-669"><a href="#ESSearch-669"><span class="linenos"> 669</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="p">(</span><span class="n">or_pos</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">cond</span><span class="p">)</span>
</span><span id="ESSearch-670"><a href="#ESSearch-670"><span class="linenos"> 670</span></a>
</span><span id="ESSearch-671"><a href="#ESSearch-671"><span class="linenos"> 671</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 3: Case 1 : find request</span>
</span><span id="ESSearch-672"><a href="#ESSearch-672"><span class="linenos"> 672</span></a>
</span><span id="ESSearch-673"><a href="#ESSearch-673"><span class="linenos"> 673</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">:</span> <span class="c1"># collection.find() request</span>
</span><span id="ESSearch-674"><a href="#ESSearch-674"><span class="linenos"> 674</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">:</span>
</span><span id="ESSearch-675"><a href="#ESSearch-675"><span class="linenos"> 675</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ESSearch-676"><a href="#ESSearch-676"><span class="linenos"> 676</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">)):</span>
</span><span id="ESSearch-677"><a href="#ESSearch-677"><span class="linenos"> 677</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span> <span class="c1"># removing empty elements in place</span>
</span><span id="ESSearch-678"><a href="#ESSearch-678"><span class="linenos"> 678</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="ESSearch-679"><a href="#ESSearch-679"><span class="linenos"> 679</span></a>                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ESSearch-680"><a href="#ESSearch-680"><span class="linenos"> 680</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># when there is no $or</span>
</span><span id="ESSearch-681"><a href="#ESSearch-681"><span class="linenos"> 681</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ESSearch-682"><a href="#ESSearch-682"><span class="linenos"> 682</span></a>                <span class="k">else</span><span class="p">:</span> <span class="c1"># when there is a $or</span>
</span><span id="ESSearch-683"><a href="#ESSearch-683"><span class="linenos"> 683</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[:</span><span class="n">j</span><span class="p">]}</span>
</span><span id="ESSearch-684"><a href="#ESSearch-684"><span class="linenos"> 684</span></a>            <span class="k">return</span> <span class="s1">&#39;find&#39;</span><span class="p">,</span> <span class="n">match</span>
</span><span id="ESSearch-685"><a href="#ESSearch-685"><span class="linenos"> 685</span></a>
</span><span id="ESSearch-686"><a href="#ESSearch-686"><span class="linenos"> 686</span></a>        <span class="c1">## ESSearch._fullSearchMongo() 4: Case 2 : aggregate request</span>
</span><span id="ESSearch-687"><a href="#ESSearch-687"><span class="linenos"> 687</span></a>
</span><span id="ESSearch-688"><a href="#ESSearch-688"><span class="linenos"> 688</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-689"><a href="#ESSearch-689"><span class="linenos"> 689</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>                                                    <span class="c1"># Mongo $unwind stage</span>
</span><span id="ESSearch-690"><a href="#ESSearch-690"><span class="linenos"> 690</span></a>                <span class="k">for</span> <span class="n">unwind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>
</span><span id="ESSearch-691"><a href="#ESSearch-691"><span class="linenos"> 691</span></a>                    <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$unwind&quot;</span> <span class="p">:</span> <span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">unwind</span><span class="p">})</span>
</span><span id="ESSearch-692"><a href="#ESSearch-692"><span class="linenos"> 692</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="p">:</span>                                               <span class="c1"># Additional Mongo $set stage if self.heavy is True</span>
</span><span id="ESSearch-693"><a href="#ESSearch-693"><span class="linenos"> 693</span></a>                <span class="n">heavy</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-694"><a href="#ESSearch-694"><span class="linenos"> 694</span></a>                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heavystages</span><span class="p">:</span>
</span><span id="ESSearch-695"><a href="#ESSearch-695"><span class="linenos"> 695</span></a>                    <span class="n">heavy</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">:{</span><span class="s2">&quot;$cond&quot;</span><span class="p">:{</span><span class="s2">&quot;if&quot;</span><span class="p">:{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:[{</span><span class="s2">&quot;$type&quot;</span><span class="p">:</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">},</span><span class="s2">&quot;object&quot;</span><span class="p">]},</span><span class="s2">&quot;then&quot;</span><span class="p">:{</span><span class="s2">&quot;$objectToArray&quot;</span><span class="p">:</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">},</span><span class="s2">&quot;else&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;v&quot;</span><span class="p">:</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">path</span><span class="p">}}}}</span>
</span><span id="ESSearch-696"><a href="#ESSearch-696"><span class="linenos"> 696</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">|=</span> <span class="p">{</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="ESSearch-697"><a href="#ESSearch-697"><span class="linenos"> 697</span></a>                <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span> <span class="p">:</span> <span class="n">heavy</span><span class="p">})</span>
</span><span id="ESSearch-698"><a href="#ESSearch-698"><span class="linenos"> 698</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">})</span>                  <span class="c1"># Mongo $set stage</span>
</span><span id="ESSearch-699"><a href="#ESSearch-699"><span class="linenos"> 699</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$geoNear&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geonear</span><span class="p">})</span>      <span class="c1"># Mongo $geoNear stage</span>
</span><span id="ESSearch-700"><a href="#ESSearch-700"><span class="linenos"> 700</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">:</span>                                                     <span class="c1"># Mongo $match stage</span>
</span><span id="ESSearch-701"><a href="#ESSearch-701"><span class="linenos"> 701</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ESSearch-702"><a href="#ESSearch-702"><span class="linenos"> 702</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">)):</span>
</span><span id="ESSearch-703"><a href="#ESSearch-703"><span class="linenos"> 703</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
</span><span id="ESSearch-704"><a href="#ESSearch-704"><span class="linenos"> 704</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="ESSearch-705"><a href="#ESSearch-705"><span class="linenos"> 705</span></a>                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ESSearch-706"><a href="#ESSearch-706"><span class="linenos"> 706</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># when there is no $or</span>
</span><span id="ESSearch-707"><a href="#ESSearch-707"><span class="linenos"> 707</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
</span><span id="ESSearch-708"><a href="#ESSearch-708"><span class="linenos"> 708</span></a>                <span class="k">else</span><span class="p">:</span> <span class="c1"># when there is a $or</span>
</span><span id="ESSearch-709"><a href="#ESSearch-709"><span class="linenos"> 709</span></a>                    <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$match&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">[:</span><span class="n">j</span><span class="p">]}})</span>
</span><span id="ESSearch-710"><a href="#ESSearch-710"><span class="linenos"> 710</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>                                                    <span class="c1"># Second Mongo $set stage when unwind not empty</span>
</span><span id="ESSearch-711"><a href="#ESSearch-711"><span class="linenos"> 711</span></a>                <span class="n">dico</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-712"><a href="#ESSearch-712"><span class="linenos"> 712</span></a>                <span class="k">for</span> <span class="n">unwind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwind</span><span class="p">:</span>
</span><span id="ESSearch-713"><a href="#ESSearch-713"><span class="linenos"> 713</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">unwind</span> <span class="ow">in</span> <span class="n">dico</span><span class="p">:</span> <span class="n">dico</span><span class="p">[</span><span class="n">unwind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="n">unwind</span><span class="p">]</span>
</span><span id="ESSearch-714"><a href="#ESSearch-714"><span class="linenos"> 714</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">dico</span><span class="p">[</span><span class="n">unwind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dico</span><span class="p">[</span><span class="n">unwind</span><span class="p">]]</span>
</span><span id="ESSearch-715"><a href="#ESSearch-715"><span class="linenos"> 715</span></a>                <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$set&quot;</span> <span class="p">:</span> <span class="n">dico</span><span class="p">})</span>
</span><span id="ESSearch-716"><a href="#ESSearch-716"><span class="linenos"> 716</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$project&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">})</span>      <span class="c1"># Mongo $project stage</span>
</span><span id="ESSearch-717"><a href="#ESSearch-717"><span class="linenos"> 717</span></a>            <span class="k">return</span> <span class="s1">&#39;aggregation&#39;</span><span class="p">,</span> <span class="n">request</span>
</span><span id="ESSearch-718"><a href="#ESSearch-718"><span class="linenos"> 718</span></a>
</span><span id="ESSearch-719"><a href="#ESSearch-719"><span class="linenos"> 719</span></a>    <span class="nd">@property</span>
</span><span id="ESSearch-720"><a href="#ESSearch-720"><span class="linenos"> 720</span></a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-721"><a href="#ESSearch-721"><span class="linenos"> 721</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-722"><a href="#ESSearch-722"><span class="linenos"> 722</span></a><span class="sd">        Getter returning the content of the query or aggregation query to be executed with ESSearch.execute().</span>
</span><span id="ESSearch-723"><a href="#ESSearch-723"><span class="linenos"> 723</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-724"><a href="#ESSearch-724"><span class="linenos"> 724</span></a>        <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="ESSearch-725"><a href="#ESSearch-725"><span class="linenos"> 725</span></a>
</span><span id="ESSearch-726"><a href="#ESSearch-726"><span class="linenos"> 726</span></a>        <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="ESSearch-727"><a href="#ESSearch-727"><span class="linenos"> 727</span></a>            <span class="k">return</span> <span class="s1">&#39;collection.find(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
</span><span id="ESSearch-728"><a href="#ESSearch-728"><span class="linenos"> 728</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-729"><a href="#ESSearch-729"><span class="linenos"> 729</span></a>            <span class="k">return</span> <span class="s1">&#39;collection.aggregate(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
</span><span id="ESSearch-730"><a href="#ESSearch-730"><span class="linenos"> 730</span></a>
</span><span id="ESSearch-731"><a href="#ESSearch-731"><span class="linenos"> 731</span></a>    <span class="nd">@property</span>
</span><span id="ESSearch-732"><a href="#ESSearch-732"><span class="linenos"> 732</span></a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch-733"><a href="#ESSearch-733"><span class="linenos"> 733</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-734"><a href="#ESSearch-734"><span class="linenos"> 734</span></a><span class="sd">        Getter returning the cursors of the query or aggregation query result on all collections and cursors contained in self.input.</span>
</span><span id="ESSearch-735"><a href="#ESSearch-735"><span class="linenos"> 735</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-736"><a href="#ESSearch-736"><span class="linenos"> 736</span></a>        <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="ESSearch-737"><a href="#ESSearch-737"><span class="linenos"> 737</span></a>        
</span><span id="ESSearch-738"><a href="#ESSearch-738"><span class="linenos"> 738</span></a>        <span class="n">cursor_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-739"><a href="#ESSearch-739"><span class="linenos"> 739</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># Determine the result cursor for each element of the input on which a Mongo query makes sense</span>
</span><span id="ESSearch-740"><a href="#ESSearch-740"><span class="linenos"> 740</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="ESSearch-741"><a href="#ESSearch-741"><span class="linenos"> 741</span></a>                <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="ESSearch-742"><a href="#ESSearch-742"><span class="linenos"> 742</span></a>                    <span class="n">cursor_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">request_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">))</span>
</span><span id="ESSearch-743"><a href="#ESSearch-743"><span class="linenos"> 743</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-744"><a href="#ESSearch-744"><span class="linenos"> 744</span></a>                    <span class="n">cursor_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">request_content</span><span class="p">))</span>
</span><span id="ESSearch-745"><a href="#ESSearch-745"><span class="linenos"> 745</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cursor_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch-746"><a href="#ESSearch-746"><span class="linenos"> 746</span></a>            <span class="k">return</span> <span class="n">cursor_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ESSearch-747"><a href="#ESSearch-747"><span class="linenos"> 747</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-748"><a href="#ESSearch-748"><span class="linenos"> 748</span></a>            <span class="k">return</span> <span class="n">cursor_list</span>
</span><span id="ESSearch-749"><a href="#ESSearch-749"><span class="linenos"> 749</span></a>
</span><span id="ESSearch-750"><a href="#ESSearch-750"><span class="linenos"> 750</span></a>
</span><span id="ESSearch-751"><a href="#ESSearch-751"><span class="linenos"> 751</span></a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returnmode</span> <span class="o">=</span> <span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ESSearch-752"><a href="#ESSearch-752"><span class="linenos"> 752</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-753"><a href="#ESSearch-753"><span class="linenos"> 753</span></a><span class="sd">        Executes the request and returns its result, either in one or many Observations.</span>
</span><span id="ESSearch-754"><a href="#ESSearch-754"><span class="linenos"> 754</span></a>
</span><span id="ESSearch-755"><a href="#ESSearch-755"><span class="linenos"> 755</span></a><span class="sd">        *Parameter*</span>
</span><span id="ESSearch-756"><a href="#ESSearch-756"><span class="linenos"> 756</span></a>
</span><span id="ESSearch-757"><a href="#ESSearch-757"><span class="linenos"> 757</span></a><span class="sd">        - **returnmode** : str (default None) - Parameter giving the format of the output:</span>
</span><span id="ESSearch-758"><a href="#ESSearch-758"><span class="linenos"> 758</span></a><span class="sd">            - &#39;unchanged&#39; : output is returned as it is in the database, some operations like operations sepcific to TimeSlot object are not performed;</span>
</span><span id="ESSearch-759"><a href="#ESSearch-759"><span class="linenos"> 759</span></a><span class="sd">            - &#39;observation&#39;: Each element is returned as an observation, but original observations aren&#39;t recreated;</span>
</span><span id="ESSearch-760"><a href="#ESSearch-760"><span class="linenos"> 760</span></a><span class="sd">            - &#39;idfused&#39;: observations whose ids are the same are merged together; </span>
</span><span id="ESSearch-761"><a href="#ESSearch-761"><span class="linenos"> 761</span></a><span class="sd">            - &#39;single&#39;: return a single observation merging all observations together.</span>
</span><span id="ESSearch-762"><a href="#ESSearch-762"><span class="linenos"> 762</span></a><span class="sd">        - **fillvalue** :  (default None) - Value to use to fill gaps when observations are merged together.</span>
</span><span id="ESSearch-763"><a href="#ESSearch-763"><span class="linenos"> 763</span></a><span class="sd">        - **name** : str (default None) - name of the output observation when returnmode is &#39;single&#39;.</span>
</span><span id="ESSearch-764"><a href="#ESSearch-764"><span class="linenos"> 764</span></a><span class="sd">        - **param** : dict (default None) - param of the output observation when returnmode is &#39;single&#39;.</span>
</span><span id="ESSearch-765"><a href="#ESSearch-765"><span class="linenos"> 765</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-766"><a href="#ESSearch-766"><span class="linenos"> 766</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;unchanged&#39;</span><span class="p">,</span> <span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="s1">&#39;idfused&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">}:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;returnmode must have one of these values: &#39;unchanged&#39;, &#39;observation&#39;, &#39;idfused&#39;, &#39;single&#39;.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-767"><a href="#ESSearch-767"><span class="linenos"> 767</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch-768"><a href="#ESSearch-768"><span class="linenos"> 768</span></a>            <span class="k">if</span> <span class="n">name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>  <span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name should be a string.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-769"><a href="#ESSearch-769"><span class="linenos"> 769</span></a>            <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;param should be a dictionnary.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-770"><a href="#ESSearch-770"><span class="linenos"> 770</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Boolean put to True inside of self._cond() if an additional filtering specific to TimeSlot and shapely geometries is necessary.</span>
</span><span id="ESSearch-771"><a href="#ESSearch-771"><span class="linenos"> 771</span></a>        
</span><span id="ESSearch-772"><a href="#ESSearch-772"><span class="linenos"> 772</span></a>        <span class="c1">## Construction of a result list where data are in the format given by returnmode</span>
</span><span id="ESSearch-773"><a href="#ESSearch-773"><span class="linenos"> 773</span></a>        
</span><span id="ESSearch-774"><a href="#ESSearch-774"><span class="linenos"> 774</span></a>        <span class="c1">## ESSearch.execute() 1: Query is executed on each Mongo Collection or Cursor of self.input</span>
</span><span id="ESSearch-775"><a href="#ESSearch-775"><span class="linenos"> 775</span></a>
</span><span id="ESSearch-776"><a href="#ESSearch-776"><span class="linenos"> 776</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-777"><a href="#ESSearch-777"><span class="linenos"> 777</span></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ESSearch-778"><a href="#ESSearch-778"><span class="linenos"> 778</span></a>            <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="ESSearch-779"><a href="#ESSearch-779"><span class="linenos"> 779</span></a>            <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="ESSearch-780"><a href="#ESSearch-780"><span class="linenos"> 780</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">request_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">)</span>
</span><span id="ESSearch-781"><a href="#ESSearch-781"><span class="linenos"> 781</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-782"><a href="#ESSearch-782"><span class="linenos"> 782</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span>
</span><span id="ESSearch-783"><a href="#ESSearch-783"><span class="linenos"> 783</span></a>
</span><span id="ESSearch-784"><a href="#ESSearch-784"><span class="linenos"> 784</span></a>            <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;observation&#39;</span><span class="p">:</span> <span class="c1"># Only in this case is an observation created directly.</span>
</span><span id="ESSearch-785"><a href="#ESSearch-785"><span class="linenos"> 785</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="ESSearch-786"><a href="#ESSearch-786"><span class="linenos"> 786</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="c1"># Additional filtering for objects like TimeSlot who need it</span>
</span><span id="ESSearch-787"><a href="#ESSearch-787"><span class="linenos"> 787</span></a>                        <span class="k">for</span> <span class="n">conds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
</span><span id="ESSearch-788"><a href="#ESSearch-788"><span class="linenos"> 788</span></a>                            <span class="n">checks_parameters</span><span class="p">,</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="ESSearch-789"><a href="#ESSearch-789"><span class="linenos"> 789</span></a>                            <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">:</span>
</span><span id="ESSearch-790"><a href="#ESSearch-790"><span class="linenos"> 790</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch-791"><a href="#ESSearch-791"><span class="linenos"> 791</span></a>                                    <span class="k">try</span><span class="p">:</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="n">checks_conds</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">cond</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]],</span> <span class="n">cond</span><span class="p">)</span> <span class="c1"># checking for each condition if it is satisfied</span>
</span><span id="ESSearch-792"><a href="#ESSearch-792"><span class="linenos"> 792</span></a>                                    <span class="k">except</span><span class="p">:</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ESSearch-793"><a href="#ESSearch-793"><span class="linenos"> 793</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-794"><a href="#ESSearch-794"><span class="linenos"> 794</span></a>                                    <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ESSearch-795"><a href="#ESSearch-795"><span class="linenos"> 795</span></a>                            <span class="n">checks_parameters</span> <span class="o">=</span> <span class="n">checks_parameters</span> <span class="ow">or</span> <span class="n">checks_conds</span>
</span><span id="ESSearch-796"><a href="#ESSearch-796"><span class="linenos"> 796</span></a>                    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-797"><a href="#ESSearch-797"><span class="linenos"> 797</span></a>                    <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch-798"><a href="#ESSearch-798"><span class="linenos"> 798</span></a>                        <span class="k">if</span> <span class="s1">&#39;name&#39;</span>  <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="ESSearch-799"><a href="#ESSearch-799"><span class="linenos"> 799</span></a>                        <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
</span><span id="ESSearch-800"><a href="#ESSearch-800"><span class="linenos"> 800</span></a>                        <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="ESSearch-801"><a href="#ESSearch-801"><span class="linenos"> 801</span></a>                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
</span><span id="ESSearch-802"><a href="#ESSearch-802"><span class="linenos"> 802</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="ow">and</span> <span class="n">checks_parameters</span><span class="p">):</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="o">**</span><span class="n">dic</span><span class="p">))</span>
</span><span id="ESSearch-803"><a href="#ESSearch-803"><span class="linenos"> 803</span></a>
</span><span id="ESSearch-804"><a href="#ESSearch-804"><span class="linenos"> 804</span></a>            <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch-805"><a href="#ESSearch-805"><span class="linenos"> 805</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="ESSearch-806"><a href="#ESSearch-806"><span class="linenos"> 806</span></a>                    <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="p">:</span> <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="ESSearch-807"><a href="#ESSearch-807"><span class="linenos"> 807</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch-808"><a href="#ESSearch-808"><span class="linenos"> 808</span></a>
</span><span id="ESSearch-809"><a href="#ESSearch-809"><span class="linenos"> 809</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># returnmode == &#39;unchanged&#39; or returnmode == &#39;idfused&#39;</span>
</span><span id="ESSearch-810"><a href="#ESSearch-810"><span class="linenos"> 810</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="ESSearch-811"><a href="#ESSearch-811"><span class="linenos"> 811</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch-812"><a href="#ESSearch-812"><span class="linenos"> 812</span></a>                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch-813"><a href="#ESSearch-813"><span class="linenos"> 813</span></a>
</span><span id="ESSearch-814"><a href="#ESSearch-814"><span class="linenos"> 814</span></a>        <span class="c1">## ESSearch.execute() 2: Operations for cases &#39;idfused&#39; and &#39;single&#39; are performed on output objects.</span>
</span><span id="ESSearch-815"><a href="#ESSearch-815"><span class="linenos"> 815</span></a>        <span class="c1"># (more efficient to do it like this than after a conversion to Observation)</span>
</span><span id="ESSearch-816"><a href="#ESSearch-816"><span class="linenos"> 816</span></a>
</span><span id="ESSearch-817"><a href="#ESSearch-817"><span class="linenos"> 817</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch-818"><a href="#ESSearch-818"><span class="linenos"> 818</span></a>            <span class="n">arg</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># argument to be given to Observation.dic() merging all observations together</span>
</span><span id="ESSearch-819"><a href="#ESSearch-819"><span class="linenos"> 819</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
</span><span id="ESSearch-820"><a href="#ESSearch-820"><span class="linenos"> 820</span></a>                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span> <span class="c1"># for columns already in the new Observation</span>
</span><span id="ESSearch-821"><a href="#ESSearch-821"><span class="linenos"> 821</span></a>                    <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="ESSearch-822"><a href="#ESSearch-822"><span class="linenos"> 822</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch-823"><a href="#ESSearch-823"><span class="linenos"> 823</span></a>                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="c1"># for columns missing in the new Observation</span>
</span><span id="ESSearch-824"><a href="#ESSearch-824"><span class="linenos"> 824</span></a>                    <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
</span><span id="ESSearch-825"><a href="#ESSearch-825"><span class="linenos"> 825</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">column_name</span><span class="p">]]</span> <span class="c1"># an empty column filled with fillvalue is added if a new column name is encountered</span>
</span><span id="ESSearch-826"><a href="#ESSearch-826"><span class="linenos"> 826</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-827"><a href="#ESSearch-827"><span class="linenos"> 827</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="ESSearch-828"><a href="#ESSearch-828"><span class="linenos"> 828</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="n">arg</span><span class="p">))]</span>
</span><span id="ESSearch-829"><a href="#ESSearch-829"><span class="linenos"> 829</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
</span><span id="ESSearch-830"><a href="#ESSearch-830"><span class="linenos"> 830</span></a>
</span><span id="ESSearch-831"><a href="#ESSearch-831"><span class="linenos"> 831</span></a>        <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;idfused&#39;</span><span class="p">:</span>
</span><span id="ESSearch-832"><a href="#ESSearch-832"><span class="linenos"> 832</span></a>            <span class="n">hashs_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-833"><a href="#ESSearch-833"><span class="linenos"> 833</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="ESSearch-834"><a href="#ESSearch-834"><span class="linenos"> 834</span></a>                <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="c1"># will throw an error if item has no id. Should items with no id be let as is or merged together?</span>
</span><span id="ESSearch-835"><a href="#ESSearch-835"><span class="linenos"> 835</span></a>                <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span> <span class="c1"># one line is added to hashs_dic[id] for each element of result having this id</span>
</span><span id="ESSearch-836"><a href="#ESSearch-836"><span class="linenos"> 836</span></a>                    <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span> <span class="c1"># Two items with the same id should have the same metadata.</span>
</span><span id="ESSearch-837"><a href="#ESSearch-837"><span class="linenos"> 837</span></a>                    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]:</span>
</span><span id="ESSearch-838"><a href="#ESSearch-838"><span class="linenos"> 838</span></a>                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch-839"><a href="#ESSearch-839"><span class="linenos"> 839</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch-840"><a href="#ESSearch-840"><span class="linenos"> 840</span></a>                    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch-841"><a href="#ESSearch-841"><span class="linenos"> 841</span></a>                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]:</span>
</span><span id="ESSearch-842"><a href="#ESSearch-842"><span class="linenos"> 842</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">column_name</span><span class="p">]]</span> <span class="c1"># a filled column is added if a new column name is encountered</span>
</span><span id="ESSearch-843"><a href="#ESSearch-843"><span class="linenos"> 843</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-844"><a href="#ESSearch-844"><span class="linenos"> 844</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="ESSearch-845"><a href="#ESSearch-845"><span class="linenos"> 845</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-846"><a href="#ESSearch-846"><span class="linenos"> 846</span></a>                    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch-847"><a href="#ESSearch-847"><span class="linenos"> 847</span></a>                    <span class="k">if</span> <span class="s1">&#39;name&#39;</span>  <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="ESSearch-848"><a href="#ESSearch-848"><span class="linenos"> 848</span></a>                    <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
</span><span id="ESSearch-849"><a href="#ESSearch-849"><span class="linenos"> 849</span></a>                    <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="ESSearch-850"><a href="#ESSearch-850"><span class="linenos"> 850</span></a>                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
</span><span id="ESSearch-851"><a href="#ESSearch-851"><span class="linenos"> 851</span></a>                    <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span>
</span><span id="ESSearch-852"><a href="#ESSearch-852"><span class="linenos"> 852</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-853"><a href="#ESSearch-853"><span class="linenos"> 853</span></a>            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span> <span class="c1"># an Observation is added to result for each id</span>
</span><span id="ESSearch-854"><a href="#ESSearch-854"><span class="linenos"> 854</span></a>                <span class="n">obs_out</span> <span class="o">=</span> <span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="o">**</span><span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
</span><span id="ESSearch-855"><a href="#ESSearch-855"><span class="linenos"> 855</span></a>                <span class="k">if</span> <span class="n">obs_out</span><span class="p">:</span>
</span><span id="ESSearch-856"><a href="#ESSearch-856"><span class="linenos"> 856</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">obs_out</span><span class="p">))</span> <span class="c1"># finalement, semble plus pertinent de faire ce filtrage directemt sur la sortie Mongo, car mme si un  un les tests de condition sont faits  de nombreuses reprises, au global ce ne sont jamais les mmes combinaisons de test</span>
</span><span id="ESSearch-857"><a href="#ESSearch-857"><span class="linenos"> 857</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_out</span><span class="p">)</span>
</span><span id="ESSearch-858"><a href="#ESSearch-858"><span class="linenos"> 858</span></a>        <span class="c1"># At this point, result is a list of observations.</span>
</span><span id="ESSearch-859"><a href="#ESSearch-859"><span class="linenos"> 859</span></a>
</span><span id="ESSearch-860"><a href="#ESSearch-860"><span class="linenos"> 860</span></a>        <span class="c1">## ESSearch.execute() 3: Other inputs (pure observations) are treated purely in python with the self._filtered_observation() method</span>
</span><span id="ESSearch-861"><a href="#ESSearch-861"><span class="linenos"> 861</span></a>
</span><span id="ESSearch-862"><a href="#ESSearch-862"><span class="linenos"> 862</span></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># data which are not taken from a Mongo database and already are observations are treated here.</span>
</span><span id="ESSearch-863"><a href="#ESSearch-863"><span class="linenos"> 863</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</span><span id="ESSearch-864"><a href="#ESSearch-864"><span class="linenos"> 864</span></a>
</span><span id="ESSearch-865"><a href="#ESSearch-865"><span class="linenos"> 865</span></a>        <span class="c1">## ESSearch.execute() 4: Operations for cases &#39;idfused&#39; and &#39;single&#39; are performed again with the added observations</span>
</span><span id="ESSearch-866"><a href="#ESSearch-866"><span class="linenos"> 866</span></a>
</span><span id="ESSearch-867"><a href="#ESSearch-867"><span class="linenos"> 867</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch-868"><a href="#ESSearch-868"><span class="linenos"> 868</span></a>            <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch-869"><a href="#ESSearch-869"><span class="linenos"> 869</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fusion</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch-870"><a href="#ESSearch-870"><span class="linenos"> 870</span></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ESSearch query result on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="c1"># default value for name</span>
</span><span id="ESSearch-871"><a href="#ESSearch-871"><span class="linenos"> 871</span></a>                <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># default value for param</span>
</span><span id="ESSearch-872"><a href="#ESSearch-872"><span class="linenos"> 872</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch-873"><a href="#ESSearch-873"><span class="linenos"> 873</span></a>                        <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
</span><span id="ESSearch-874"><a href="#ESSearch-874"><span class="linenos"> 874</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-875"><a href="#ESSearch-875"><span class="linenos"> 875</span></a>                        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-876"><a href="#ESSearch-876"><span class="linenos"> 876</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">:</span> <span class="c1"># informations about the inputs are added to param</span>
</span><span id="ESSearch-877"><a href="#ESSearch-877"><span class="linenos"> 877</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Observation</span><span class="p">):</span>
</span><span id="ESSearch-878"><a href="#ESSearch-878"><span class="linenos"> 878</span></a>                                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch-879"><a href="#ESSearch-879"><span class="linenos"> 879</span></a>                                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Observation: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch-880"><a href="#ESSearch-880"><span class="linenos"> 880</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-881"><a href="#ESSearch-881"><span class="linenos"> 881</span></a>                                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</span><span id="ESSearch-882"><a href="#ESSearch-882"><span class="linenos"> 882</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
</span><span id="ESSearch-883"><a href="#ESSearch-883"><span class="linenos"> 883</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MongoDB collection: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch-884"><a href="#ESSearch-884"><span class="linenos"> 884</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">):</span>
</span><span id="ESSearch-885"><a href="#ESSearch-885"><span class="linenos"> 885</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pymongo cursor: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">+</span> <span class="s1">&#39; from collection &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> 
</span><span id="ESSearch-886"><a href="#ESSearch-886"><span class="linenos"> 886</span></a>                                                <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch-887"><a href="#ESSearch-887"><span class="linenos"> 887</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">):</span>
</span><span id="ESSearch-888"><a href="#ESSearch-888"><span class="linenos"> 888</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pymongo commandcursor: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">+</span> <span class="s1">&#39; from collection &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> 
</span><span id="ESSearch-889"><a href="#ESSearch-889"><span class="linenos"> 889</span></a>                                                <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch-890"><a href="#ESSearch-890"><span class="linenos"> 890</span></a>                            <span class="k">else</span><span class="p">:</span> <span class="c1"># should not happen</span>
</span><span id="ESSearch-891"><a href="#ESSearch-891"><span class="linenos"> 891</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</span><span id="ESSearch-892"><a href="#ESSearch-892"><span class="linenos"> 892</span></a>                    <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span> <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;essearch&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dim3&#39;</span><span class="p">,</span> 
</span><span id="ESSearch-893"><a href="#ESSearch-893"><span class="linenos"> 893</span></a>                            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;ESSearch query&#39;</span><span class="p">,</span> <span class="s1">&#39;sources &#39;</span><span class="p">:</span> <span class="n">sources</span><span class="p">,</span> 
</span><span id="ESSearch-894"><a href="#ESSearch-894"><span class="linenos"> 894</span></a>                            <span class="s1">&#39;ESSearch_parameters&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)}}</span>
</span><span id="ESSearch-895"><a href="#ESSearch-895"><span class="linenos"> 895</span></a>                <span class="n">result</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="ESSearch-896"><a href="#ESSearch-896"><span class="linenos"> 896</span></a>
</span><span id="ESSearch-897"><a href="#ESSearch-897"><span class="linenos"> 897</span></a>            <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;idfused&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch-898"><a href="#ESSearch-898"><span class="linenos"> 898</span></a>                <span class="n">hashs_dic</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># This dictionnary is in the format {id: [observations]}</span>
</span><span id="ESSearch-899"><a href="#ESSearch-899"><span class="linenos"> 899</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="ESSearch-900"><a href="#ESSearch-900"><span class="linenos"> 900</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span>
</span><span id="ESSearch-901"><a href="#ESSearch-901"><span class="linenos"> 901</span></a>                        <span class="n">hashs_dic</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch-902"><a href="#ESSearch-902"><span class="linenos"> 902</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-903"><a href="#ESSearch-903"><span class="linenos"> 903</span></a>                        <span class="n">hashs_dic</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="ESSearch-904"><a href="#ESSearch-904"><span class="linenos"> 904</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-905"><a href="#ESSearch-905"><span class="linenos"> 905</span></a>                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span>
</span><span id="ESSearch-906"><a href="#ESSearch-906"><span class="linenos"> 906</span></a>                    <span class="n">obs_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fusion</span><span class="p">(</span><span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch-907"><a href="#ESSearch-907"><span class="linenos"> 907</span></a>                    <span class="k">if</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="n">obs_out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="c1"># name and param associated to the id are put back</span>
</span><span id="ESSearch-908"><a href="#ESSearch-908"><span class="linenos"> 908</span></a>                    <span class="k">if</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">:</span> <span class="n">obs_out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param</span>
</span><span id="ESSearch-909"><a href="#ESSearch-909"><span class="linenos"> 909</span></a>                    <span class="k">if</span> <span class="n">obs_out</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_out</span><span class="p">)</span>
</span><span id="ESSearch-910"><a href="#ESSearch-910"><span class="linenos"> 910</span></a>
</span><span id="ESSearch-911"><a href="#ESSearch-911"><span class="linenos"> 911</span></a>        <span class="c1">## ESSearch.execute() 5: Return result</span>
</span><span id="ESSearch-912"><a href="#ESSearch-912"><span class="linenos"> 912</span></a>
</span><span id="ESSearch-913"><a href="#ESSearch-913"><span class="linenos"> 913</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="ESSearch-914"><a href="#ESSearch-914"><span class="linenos"> 914</span></a>
</span><span id="ESSearch-915"><a href="#ESSearch-915"><span class="linenos"> 915</span></a>    <span class="k">def</span> <span class="nf">_filtered_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">is_from_mongo</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span> <span class="c1"># Vrifier que cette fonction n&#39;est pas moins efficace que de tout dplier / filtrer / tout replier</span>
</span><span id="ESSearch-916"><a href="#ESSearch-916"><span class="linenos"> 916</span></a>        <span class="c1"># Regarder si on ne peut pas faire la mme chose en mieux avec des fonctions de numpy ou panda.</span>
</span><span id="ESSearch-917"><a href="#ESSearch-917"><span class="linenos"> 917</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-918"><a href="#ESSearch-918"><span class="linenos"> 918</span></a><span class="sd">        Takes an Observation and returns a filtered Observation with self.parameters as a filter.</span>
</span><span id="ESSearch-919"><a href="#ESSearch-919"><span class="linenos"> 919</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-920"><a href="#ESSearch-920"><span class="linenos"> 920</span></a>        <span class="c1"># self.parameters = [[cond1 AND cond 2 AND cond 3] OR [cond4 AND cond5 AND cond6]]</span>
</span><span id="ESSearch-921"><a href="#ESSearch-921"><span class="linenos"> 921</span></a>        <span class="c1"># dico = {&quot;data&quot;: [[&quot;datation&quot;, [date1, date2, date3], [0,1,0,2,2,1]], [&quot;location&quot;, [loc1, loc2, loc3], [0,1,2,0,1,1]]]} # dico n&#39;est plus utilis</span>
</span><span id="ESSearch-922"><a href="#ESSearch-922"><span class="linenos"> 922</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[[]]:</span> <span class="k">return</span> <span class="n">obs</span>
</span><span id="ESSearch-923"><a href="#ESSearch-923"><span class="linenos"> 923</span></a>
</span><span id="ESSearch-924"><a href="#ESSearch-924"><span class="linenos"> 924</span></a>        <span class="c1">## ESSearch._filtered_observation() 0: This function is done with an iteration over self.parameters </span>
</span><span id="ESSearch-925"><a href="#ESSearch-925"><span class="linenos"> 925</span></a>
</span><span id="ESSearch-926"><a href="#ESSearch-926"><span class="linenos"> 926</span></a>        <span class="n">final_filter</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">lencomplete</span>
</span><span id="ESSearch-927"><a href="#ESSearch-927"><span class="linenos"> 927</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)):</span> <span class="c1"># for each group of conditions separated by a or</span>
</span><span id="ESSearch-928"><a href="#ESSearch-928"><span class="linenos"> 928</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
</span><span id="ESSearch-929"><a href="#ESSearch-929"><span class="linenos"> 929</span></a>
</span><span id="ESSearch-930"><a href="#ESSearch-930"><span class="linenos"> 930</span></a>        <span class="c1">## ESSearch._filtered_observation() 1: Checking if no column is missing and if conditions on metadata are verified</span>
</span><span id="ESSearch-931"><a href="#ESSearch-931"><span class="linenos"> 931</span></a>
</span><span id="ESSearch-932"><a href="#ESSearch-932"><span class="linenos"> 932</span></a>                <span class="n">conds</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># conds is a dict which associates columns to the condition which concern them (inside of [cond1 AND cond 2 AND cond 3] : only AND)</span>
</span><span id="ESSearch-933"><a href="#ESSearch-933"><span class="linenos"> 933</span></a>                <span class="n">relevant</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># no column given by cond[&quot;path&quot;] is missing from obs</span>
</span><span id="ESSearch-934"><a href="#ESSearch-934"><span class="linenos"> 934</span></a>                <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="ESSearch-935"><a href="#ESSearch-935"><span class="linenos"> 935</span></a>                    <span class="n">next_relevant</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ESSearch-936"><a href="#ESSearch-936"><span class="linenos"> 936</span></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">)):</span>
</span><span id="ESSearch-937"><a href="#ESSearch-937"><span class="linenos"> 937</span></a>                        <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="ESSearch-938"><a href="#ESSearch-938"><span class="linenos"> 938</span></a>                            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">:</span> <span class="n">conds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
</span><span id="ESSearch-939"><a href="#ESSearch-939"><span class="linenos"> 939</span></a>                            <span class="k">else</span><span class="p">:</span> <span class="n">conds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cond</span><span class="p">]</span>
</span><span id="ESSearch-940"><a href="#ESSearch-940"><span class="linenos"> 940</span></a>                            <span class="n">next_relevant</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ESSearch-941"><a href="#ESSearch-941"><span class="linenos"> 941</span></a>                        <span class="k">elif</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_metadata&quot;</span><span class="p">:</span> <span class="c1"># metadata are id, name and param</span>
</span><span id="ESSearch-942"><a href="#ESSearch-942"><span class="linenos"> 942</span></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_from_mongo</span><span class="p">:</span> <span class="c1"># This step is considered to be done already for data taken out of Mongo</span>
</span><span id="ESSearch-943"><a href="#ESSearch-943"><span class="linenos"> 943</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">next_relevant</span> <span class="o">=</span> <span class="n">next_relevant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="ESSearch-944"><a href="#ESSearch-944"><span class="linenos"> 944</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span>   <span class="p">:</span> <span class="n">next_relevant</span> <span class="o">=</span> <span class="n">next_relevant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="ESSearch-945"><a href="#ESSearch-945"><span class="linenos"> 945</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;param&#39;</span><span class="p">:</span> <span class="n">next_relevant</span> <span class="o">=</span> <span class="n">next_relevant</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="ESSearch-946"><a href="#ESSearch-946"><span class="linenos"> 946</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch-947"><a href="#ESSearch-947"><span class="linenos"> 947</span></a>                                <span class="n">next_relevant</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ESSearch-948"><a href="#ESSearch-948"><span class="linenos"> 948</span></a>                    <span class="n">relevant</span> <span class="o">=</span> <span class="n">relevant</span> <span class="ow">and</span> <span class="n">next_relevant</span>
</span><span id="ESSearch-949"><a href="#ESSearch-949"><span class="linenos"> 949</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">relevant</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># if a column on which a condition is applied is missing, the set of conditions given by the element of self.parameters is considered not verified.</span>
</span><span id="ESSearch-950"><a href="#ESSearch-950"><span class="linenos"> 950</span></a>
</span><span id="ESSearch-951"><a href="#ESSearch-951"><span class="linenos"> 951</span></a>        <span class="c1">## ESSearch._filtered_observation() 2: Condition is applied on all elements of the Observation to create a boolean filter</span>
</span><span id="ESSearch-952"><a href="#ESSearch-952"><span class="linenos"> 952</span></a>
</span><span id="ESSearch-953"><a href="#ESSearch-953"><span class="linenos"> 953</span></a>                <span class="n">full_filter</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">lencomplete</span>
</span><span id="ESSearch-954"><a href="#ESSearch-954"><span class="linenos"> 954</span></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lenidx</span><span class="p">):</span> <span class="c1"># iteration over the columns</span>
</span><span id="ESSearch-955"><a href="#ESSearch-955"><span class="linenos"> 955</span></a>                    <span class="nb">filter</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-956"><a href="#ESSearch-956"><span class="linenos"> 956</span></a>                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">cod</span><span class="p">:</span>
</span><span id="ESSearch-957"><a href="#ESSearch-957"><span class="linenos"> 957</span></a>                        <span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ESSearch-958"><a href="#ESSearch-958"><span class="linenos"> 958</span></a>                        <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="ESSearch-959"><a href="#ESSearch-959"><span class="linenos"> 959</span></a>                            <span class="k">try</span><span class="p">:</span> <span class="n">boolean</span> <span class="o">=</span> <span class="n">boolean</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
</span><span id="ESSearch-960"><a href="#ESSearch-960"><span class="linenos"> 960</span></a>                            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1">#boolean = False # pose problme pour les regex et autres oprations non implmentes...</span>
</span><span id="ESSearch-961"><a href="#ESSearch-961"><span class="linenos"> 961</span></a>                        <span class="nb">filter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">boolean</span><span class="p">)</span> <span class="c1"># condition is rewritten as a boolean filter for the incoming data</span>
</span><span id="ESSearch-962"><a href="#ESSearch-962"><span class="linenos"> 962</span></a>                    <span class="n">next_full_filter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">tovalues</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span> <span class="c1"># filter changed from filter on optimize codec to filter on full codec. (filter on optimize codec was the just how we calculated it, this isn&#39;t an actual method of the module)</span>
</span><span id="ESSearch-963"><a href="#ESSearch-963"><span class="linenos"> 963</span></a>                    <span class="n">full_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">full_filter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="n">next_full_filter</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_filter</span><span class="p">))]</span> <span class="c1"># full filter is updated each time</span>
</span><span id="ESSearch-964"><a href="#ESSearch-964"><span class="linenos"> 964</span></a>
</span><span id="ESSearch-965"><a href="#ESSearch-965"><span class="linenos"> 965</span></a>        <span class="c1">## ESSearch._filtered_observation() 3: or_position is taken into account</span>
</span><span id="ESSearch-966"><a href="#ESSearch-966"><span class="linenos"> 966</span></a>
</span><span id="ESSearch-967"><a href="#ESSearch-967"><span class="linenos"> 967</span></a>                <span class="n">final_filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_filter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">or</span> <span class="n">full_filter</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_filter</span><span class="p">))]</span>
</span><span id="ESSearch-968"><a href="#ESSearch-968"><span class="linenos"> 968</span></a>
</span><span id="ESSearch-969"><a href="#ESSearch-969"><span class="linenos"> 969</span></a>        <span class="c1">## ESSearch._filtered_observation() 4: Application of the final filter on the incoming Observation</span>
</span><span id="ESSearch-970"><a href="#ESSearch-970"><span class="linenos"> 970</span></a>
</span><span id="ESSearch-971"><a href="#ESSearch-971"><span class="linenos"> 971</span></a>        <span class="n">obs</span><span class="o">.</span><span class="n">setfilter</span><span class="p">(</span><span class="n">final_filter</span><span class="p">)</span>
</span><span id="ESSearch-972"><a href="#ESSearch-972"><span class="linenos"> 972</span></a>        <span class="n">obs</span><span class="o">.</span><span class="n">applyfilter</span><span class="p">()</span>
</span><span id="ESSearch-973"><a href="#ESSearch-973"><span class="linenos"> 973</span></a>        <span class="k">return</span> <span class="n">obs</span>
</span><span id="ESSearch-974"><a href="#ESSearch-974"><span class="linenos"> 974</span></a>
</span><span id="ESSearch-975"><a href="#ESSearch-975"><span class="linenos"> 975</span></a>    <span class="k">def</span> <span class="nf">_condcheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">cond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># ajouter la gestion des regex</span>
</span><span id="ESSearch-976"><a href="#ESSearch-976"><span class="linenos"> 976</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-977"><a href="#ESSearch-977"><span class="linenos"> 977</span></a><span class="sd">        Takes an item and returns a Boolean if it verifies criteria given by parameter.</span>
</span><span id="ESSearch-978"><a href="#ESSearch-978"><span class="linenos"> 978</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-979"><a href="#ESSearch-979"><span class="linenos"> 979</span></a>        <span class="c1">#cond = {&quot;comparator&quot; : comparator, &quot;operand&quot; : operand, &quot;path&quot; : path} and sometimes can contain other things</span>
</span><span id="ESSearch-980"><a href="#ESSearch-980"><span class="linenos"> 980</span></a>
</span><span id="ESSearch-981"><a href="#ESSearch-981"><span class="linenos"> 981</span></a>        <span class="c1"># 0. Basic cases</span>
</span><span id="ESSearch-982"><a href="#ESSearch-982"><span class="linenos"> 982</span></a>
</span><span id="ESSearch-983"><a href="#ESSearch-983"><span class="linenos"> 983</span></a>        <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
</span><span id="ESSearch-984"><a href="#ESSearch-984"><span class="linenos"> 984</span></a>        <span class="k">if</span> <span class="s1">&#39;inverted&#39;</span> <span class="ow">in</span> <span class="n">cond</span> <span class="ow">and</span> <span class="n">cond</span><span class="p">[</span><span class="s1">&#39;inverted&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;inverted&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</span><span id="ESSearch-985"><a href="#ESSearch-985"><span class="linenos"> 985</span></a>        <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
</span><span id="ESSearch-986"><a href="#ESSearch-986"><span class="linenos"> 986</span></a>
</span><span id="ESSearch-987"><a href="#ESSearch-987"><span class="linenos"> 987</span></a>        <span class="c1"># 1. formatstring applied if formatstring there is</span>
</span><span id="ESSearch-988"><a href="#ESSearch-988"><span class="linenos"> 988</span></a>
</span><span id="ESSearch-989"><a href="#ESSearch-989"><span class="linenos"> 989</span></a>        <span class="k">if</span> <span class="s2">&quot;formatstring&quot;</span> <span class="ow">in</span> <span class="n">cond</span><span class="p">:</span>
</span><span id="ESSearch-990"><a href="#ESSearch-990"><span class="linenos"> 990</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">)):</span>
</span><span id="ESSearch-991"><a href="#ESSearch-991"><span class="linenos"> 991</span></a>                <span class="n">item</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;formatstring&quot;</span><span class="p">])</span>
</span><span id="ESSearch-992"><a href="#ESSearch-992"><span class="linenos"> 992</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">)):</span>
</span><span id="ESSearch-993"><a href="#ESSearch-993"><span class="linenos"> 993</span></a>                <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;formatstring&quot;</span><span class="p">])</span>
</span><span id="ESSearch-994"><a href="#ESSearch-994"><span class="linenos"> 994</span></a>
</span><span id="ESSearch-995"><a href="#ESSearch-995"><span class="linenos"> 995</span></a>        <span class="c1"># 2. Cases TimeSlot, geometry and nested property need specific treatment</span>
</span><span id="ESSearch-996"><a href="#ESSearch-996"><span class="linenos"> 996</span></a>
</span><span id="ESSearch-997"><a href="#ESSearch-997"><span class="linenos"> 997</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">TimeSlot</span><span class="p">):</span>
</span><span id="ESSearch-998"><a href="#ESSearch-998"><span class="linenos"> 998</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="n">TimeSlot</span><span class="p">):</span> <span class="c1"># if comparator is one of the specific operators for TimeSlot</span>
</span><span id="ESSearch-999"><a href="#ESSearch-999"><span class="linenos"> 999</span></a>                <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dico_alias_python</span><span class="p">[</span><span class="n">TimeSlot</span><span class="p">][</span><span class="n">TimeSlot</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]]</span>
</span><span id="ESSearch-1000"><a href="#ESSearch-1000"><span class="linenos">1000</span></a>                <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span>
</span><span id="ESSearch-1001"><a href="#ESSearch-1001"><span class="linenos">1001</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># if operand is a datetime</span>
</span><span id="ESSearch-1002"><a href="#ESSearch-1002"><span class="linenos">1002</span></a>                <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">dico_alias_python</span><span class="p">[</span><span class="n">TimeSlot</span><span class="p">][</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]](</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="ESSearch-1003"><a href="#ESSearch-1003"><span class="linenos">1003</span></a>                <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Comparator not supported for TimeSlot.&quot;</span><span class="p">)</span>
</span><span id="ESSearch-1004"><a href="#ESSearch-1004"><span class="linenos">1004</span></a>
</span><span id="ESSearch-1005"><a href="#ESSearch-1005"><span class="linenos">1005</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseGeometry</span><span class="p">):</span>
</span><span id="ESSearch-1006"><a href="#ESSearch-1006"><span class="linenos">1006</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># lists are interpreted as geometries</span>
</span><span id="ESSearch-1007"><a href="#ESSearch-1007"><span class="linenos">1007</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-1008"><a href="#ESSearch-1008"><span class="linenos">1008</span></a>                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span> <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch-1009"><a href="#ESSearch-1009"><span class="linenos">1009</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch-1010"><a href="#ESSearch-1010"><span class="linenos">1010</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ESSearch-1011"><a href="#ESSearch-1011"><span class="linenos">1011</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ESSearch-1012"><a href="#ESSearch-1012"><span class="linenos">1012</span></a>                        <span class="n">item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-1013"><a href="#ESSearch-1013"><span class="linenos">1013</span></a>                    <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span><span class="n">item</span><span class="p">])</span>
</span><span id="ESSearch-1014"><a href="#ESSearch-1014"><span class="linenos">1014</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># lists are interpreted as geometries</span>
</span><span id="ESSearch-1015"><a href="#ESSearch-1015"><span class="linenos">1015</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-1016"><a href="#ESSearch-1016"><span class="linenos">1016</span></a>                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="ESSearch-1017"><a href="#ESSearch-1017"><span class="linenos">1017</span></a>                    <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="ESSearch-1018"><a href="#ESSearch-1018"><span class="linenos">1018</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="ESSearch-1019"><a href="#ESSearch-1019"><span class="linenos">1019</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ESSearch-1020"><a href="#ESSearch-1020"><span class="linenos">1020</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ESSearch-1021"><a href="#ESSearch-1021"><span class="linenos">1021</span></a>                        <span class="n">item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-1022"><a href="#ESSearch-1022"><span class="linenos">1022</span></a>                    <span class="n">item</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span><span class="n">item</span><span class="p">])</span>
</span><span id="ESSearch-1023"><a href="#ESSearch-1023"><span class="linenos">1023</span></a>            <span class="k">return</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]](</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="ESSearch-1024"><a href="#ESSearch-1024"><span class="linenos">1024</span></a>
</span><span id="ESSearch-1025"><a href="#ESSearch-1025"><span class="linenos">1025</span></a>        <span class="k">elif</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;property&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># assuming that property contains dicts and that the query targets one of its values</span>
</span><span id="ESSearch-1026"><a href="#ESSearch-1026"><span class="linenos">1026</span></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="ESSearch-1027"><a href="#ESSearch-1027"><span class="linenos">1027</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">cond</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}):</span>
</span><span id="ESSearch-1028"><a href="#ESSearch-1028"><span class="linenos">1028</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="ESSearch-1029"><a href="#ESSearch-1029"><span class="linenos">1029</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="ESSearch-1030"><a href="#ESSearch-1030"><span class="linenos">1030</span></a>
</span><span id="ESSearch-1031"><a href="#ESSearch-1031"><span class="linenos">1031</span></a>        <span class="c1"># 3. General comparison for remaining cases</span>
</span><span id="ESSearch-1032"><a href="#ESSearch-1032"><span class="linenos">1032</span></a>
</span><span id="ESSearch-1033"><a href="#ESSearch-1033"><span class="linenos">1033</span></a>        <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">][</span><span class="n">cond</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]](</span><span class="n">item</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;operand&quot;</span><span class="p">])</span>
</span><span id="ESSearch-1034"><a href="#ESSearch-1034"><span class="linenos">1034</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="ESSearch-1035"><a href="#ESSearch-1035"><span class="linenos">1035</span></a>            <span class="c1">#raise ValueError(&quot;Comparator not supported.&quot;)</span>
</span><span id="ESSearch-1036"><a href="#ESSearch-1036"><span class="linenos">1036</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="ESSearch-1037"><a href="#ESSearch-1037"><span class="linenos">1037</span></a>
</span><span id="ESSearch-1038"><a href="#ESSearch-1038"><span class="linenos">1038</span></a>    <span class="k">def</span> <span class="nf">_fusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obsList</span><span class="p">,</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># Idalement, utiliser une mthode fusion de Observation.</span>
</span><span id="ESSearch-1039"><a href="#ESSearch-1039"><span class="linenos">1039</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch-1040"><a href="#ESSearch-1040"><span class="linenos">1040</span></a><span class="sd">        Takes a list of observations and returns one observation merging them together in one single observation.</span>
</span><span id="ESSearch-1041"><a href="#ESSearch-1041"><span class="linenos">1041</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch-1042"><a href="#ESSearch-1042"><span class="linenos">1042</span></a>        <span class="c1">## ESSearch._fusion() 0: Basic cases</span>
</span><span id="ESSearch-1043"><a href="#ESSearch-1043"><span class="linenos">1043</span></a>
</span><span id="ESSearch-1044"><a href="#ESSearch-1044"><span class="linenos">1044</span></a>        <span class="k">if</span>   <span class="nb">len</span><span class="p">(</span><span class="n">obsList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">Observation</span><span class="p">()</span>
</span><span id="ESSearch-1045"><a href="#ESSearch-1045"><span class="linenos">1045</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">Observation</span><span class="p">(</span><span class="n">obsList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ESSearch-1046"><a href="#ESSearch-1046"><span class="linenos">1046</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Fusion of a list with more than one element</span>
</span><span id="ESSearch-1047"><a href="#ESSearch-1047"><span class="linenos">1047</span></a>            <span class="n">lidx</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-1048"><a href="#ESSearch-1048"><span class="linenos">1048</span></a>
</span><span id="ESSearch-1049"><a href="#ESSearch-1049"><span class="linenos">1049</span></a>        <span class="c1">## ESSearch._fusion() 1: Determination of the names of the columns</span>
</span><span id="ESSearch-1050"><a href="#ESSearch-1050"><span class="linenos">1050</span></a>
</span><span id="ESSearch-1051"><a href="#ESSearch-1051"><span class="linenos">1051</span></a>            <span class="n">new_lname</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ESSearch-1052"><a href="#ESSearch-1052"><span class="linenos">1052</span></a>            <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsList</span><span class="p">:</span>
</span><span id="ESSearch-1053"><a href="#ESSearch-1053"><span class="linenos">1053</span></a>                <span class="n">new_lname</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">)</span>
</span><span id="ESSearch-1054"><a href="#ESSearch-1054"><span class="linenos">1054</span></a>            <span class="n">new_lname</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_lname</span><span class="p">)</span>
</span><span id="ESSearch-1055"><a href="#ESSearch-1055"><span class="linenos">1055</span></a>            
</span><span id="ESSearch-1056"><a href="#ESSearch-1056"><span class="linenos">1056</span></a>        <span class="c1">## ESSearch._fusion() 2: Fill the columns with the values of the observations to merge</span>
</span><span id="ESSearch-1057"><a href="#ESSearch-1057"><span class="linenos">1057</span></a>
</span><span id="ESSearch-1058"><a href="#ESSearch-1058"><span class="linenos">1058</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_lname</span><span class="p">)):</span> <span class="c1"># for each column of the new Observation</span>
</span><span id="ESSearch-1059"><a href="#ESSearch-1059"><span class="linenos">1059</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch-1060"><a href="#ESSearch-1060"><span class="linenos">1060</span></a>                <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obsList</span><span class="p">:</span> <span class="c1"># for each Observation in the list</span>
</span><span id="ESSearch-1061"><a href="#ESSearch-1061"><span class="linenos">1061</span></a>                    <span class="k">if</span> <span class="n">new_lname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="p">:</span> <span class="n">values</span> <span class="o">+=</span> <span class="n">obs</span><span class="o">.</span><span class="n">lindex</span><span class="p">[</span><span class="n">obs</span><span class="o">.</span><span class="n">lname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">new_lname</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># values of the column are added to the new column</span>
</span><span id="ESSearch-1062"><a href="#ESSearch-1062"><span class="linenos">1062</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">values</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="c1"># when there is no value, filled with fillvalue</span>
</span><span id="ESSearch-1063"><a href="#ESSearch-1063"><span class="linenos">1063</span></a>                <span class="n">codec</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">tocodec</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span id="ESSearch-1064"><a href="#ESSearch-1064"><span class="linenos">1064</span></a>                <span class="n">lidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Iindex</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">new_lname</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">util</span><span class="o">.</span><span class="n">tokeys</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">codec</span><span class="p">)))</span>
</span><span id="ESSearch-1065"><a href="#ESSearch-1065"><span class="linenos">1065</span></a>
</span><span id="ESSearch-1066"><a href="#ESSearch-1066"><span class="linenos">1066</span></a>        <span class="c1">## ESSearch._fusion() 3: Build the actual Observation</span>
</span><span id="ESSearch-1067"><a href="#ESSearch-1067"><span class="linenos">1067</span></a>
</span><span id="ESSearch-1068"><a href="#ESSearch-1068"><span class="linenos">1068</span></a>            <span class="k">return</span> <span class="n">Observation</span><span class="p">(</span><span class="n">lidx</span><span class="p">)</span>
</span><span id="ESSearch-1069"><a href="#ESSearch-1069"><span class="linenos">1069</span></a>            <span class="c1"># Il y aurait peut-tre moyen d&#39;optimiser un peu en remplaant Iindex, util.tokeys et l&#39;appel final d&#39;Observation par des manipulations directes sur les objets.</span>
</span><span id="ESSearch-1070"><a href="#ESSearch-1070"><span class="linenos">1070</span></a>            <span class="c1"># faire la fusion directement sur les keys au lieu de la faire sur les codec ?</span>
</span><span id="ESSearch-1071"><a href="#ESSearch-1071"><span class="linenos">1071</span></a>            <span class="c1"># Avec la mthode actuelle, certaines oprations sont faites plusieurs fois.</span>
</span></pre></div>


            <div class="docstring"><p>An <code><a href="#ESSearch">ESSearch</a></code> is defined as an ensemble of conditions to be used to execute a MongoDB request or any iterable containing only observations.</p>

<p><em>Attributes (for @property, see methods)</em> :</p>

<ul>
<li><strong>input</strong> : input on which the query is done. One of or a list of these : 
<ul>
<li>pymongo.collection.Collection</li>
<li>pymongo.cursor.Cursor</li>
<li>pymongo.command_cursor.CommandCursor</li>
<li>Observation (can be defined from a str or a dict)</li>
</ul></li>
<li><strong>parameters</strong> : list of list of conditions for queries, to be interpreted as : parameters = [[cond_1 AND cond_2 AND cond_3] OR [cond_4 AND cond_5 AND cond_6]] where conds are criteria for queries</li>
<li><strong>hide</strong> : list of paths to hide from the output</li>
<li><strong>heavy</strong> : boolean indicating whether the request should search for nested values or not. Does not work with geoJSON.</li>
<li><strong>sources</strong> : attribute used to indicate the sources of the data in param</li>
</ul>

<p>The methods defined in this class are (documentations in methods definitions):</p>

<p><em>setter</em></p>

<ul>
<li><code><a href="#ESSearch.addInput">ESSearch.addInput</a></code></li>
<li><code><a href="#ESSearch.removeInputs">ESSearch.removeInputs</a></code></li>
<li><code><a href="#ESSearch.setHide">ESSearch.setHide</a></code></li>
<li><code><a href="#ESSearch.setHeavy">ESSearch.setHeavy</a></code></li>
<li><code><a href="#ESSearch.clear">ESSearch.clear</a></code></li>
</ul>

<p><em>dynamic value (getter @property)</em></p>

<ul>
<li><code><a href="#ESSearch.request">ESSearch.request</a></code></li>
<li><code><a href="#ESSearch.cursor">ESSearch.cursor</a></code></li>
</ul>

<p><em>parameters for query - update methods</em></p>

<ul>
<li><code><a href="#ESSearch.addConditions">ESSearch.addConditions</a></code></li>
<li><code><a href="#ESSearch.addCondition">ESSearch.addCondition</a></code></li>
<li><code><a href="#ESSearch.orCondition">ESSearch.orCondition</a></code></li>
<li><code><a href="#ESSearch.removeCondition">ESSearch.removeCondition</a></code></li>
<li><code><a href="#ESSearch.clearConditions">ESSearch.clearConditions</a></code></li>
</ul>

<p><em>query method</em></p>

<ul>
<li><code><a href="#ESSearch.execute">ESSearch.execute</a></code></li>
</ul>
</div>


                            <div id="ESSearch.__init__" class="classattr">
                                        <input id="ESSearch.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ESSearch</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="nb">input</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">parameters</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">hide</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">heavy</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">sources</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ESSearch.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.__init__-284"><a href="#ESSearch.__init__-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="ESSearch.__init__-285"><a href="#ESSearch.__init__-285"><span class="linenos">285</span></a>                    <span class="nb">input</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ESSearch.__init__-286"><a href="#ESSearch.__init__-286"><span class="linenos">286</span></a>                    <span class="n">parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ESSearch.__init__-287"><a href="#ESSearch.__init__-287"><span class="linenos">287</span></a>                    <span class="n">hide</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="ESSearch.__init__-288"><a href="#ESSearch.__init__-288"><span class="linenos">288</span></a>                    <span class="n">heavy</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="ESSearch.__init__-289"><a href="#ESSearch.__init__-289"><span class="linenos">289</span></a>                    <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
</span><span id="ESSearch.__init__-290"><a href="#ESSearch.__init__-290"><span class="linenos">290</span></a>                    <span class="o">**</span><span class="n">kwargs</span>
</span><span id="ESSearch.__init__-291"><a href="#ESSearch.__init__-291"><span class="linenos">291</span></a>                    <span class="p">):</span>
</span><span id="ESSearch.__init__-292"><a href="#ESSearch.__init__-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.__init__-293"><a href="#ESSearch.__init__-293"><span class="linenos">293</span></a><span class="sd">        ESSearch constructor. Parameters can also be defined and updated using class methods.</span>
</span><span id="ESSearch.__init__-294"><a href="#ESSearch.__init__-294"><span class="linenos">294</span></a>
</span><span id="ESSearch.__init__-295"><a href="#ESSearch.__init__-295"><span class="linenos">295</span></a><span class="sd">        *Arguments*</span>
</span><span id="ESSearch.__init__-296"><a href="#ESSearch.__init__-296"><span class="linenos">296</span></a>
</span><span id="ESSearch.__init__-297"><a href="#ESSearch.__init__-297"><span class="linenos">297</span></a><span class="sd">        - **input** : input on which the query is done. Must be one of or a list of these (can be nested):</span>
</span><span id="ESSearch.__init__-298"><a href="#ESSearch.__init__-298"><span class="linenos">298</span></a><span class="sd">            - pymongo.collection.Collection</span>
</span><span id="ESSearch.__init__-299"><a href="#ESSearch.__init__-299"><span class="linenos">299</span></a><span class="sd">            - pymongo.cursor.Cursor</span>
</span><span id="ESSearch.__init__-300"><a href="#ESSearch.__init__-300"><span class="linenos">300</span></a><span class="sd">            - pymongo.command_cursor.CommandCursor</span>
</span><span id="ESSearch.__init__-301"><a href="#ESSearch.__init__-301"><span class="linenos">301</span></a><span class="sd">            - Observation</span>
</span><span id="ESSearch.__init__-302"><a href="#ESSearch.__init__-302"><span class="linenos">302</span></a><span class="sd">            - str corresponding to a json Observation</span>
</span><span id="ESSearch.__init__-303"><a href="#ESSearch.__init__-303"><span class="linenos">303</span></a><span class="sd">            - dict corresponding to a json Observation</span>
</span><span id="ESSearch.__init__-304"><a href="#ESSearch.__init__-304"><span class="linenos">304</span></a><span class="sd">        - **parameters** :  dict, list (default None) - list of list or list of dictionnaries whose keys are arguments of ESSearch.addCondition method</span>
</span><span id="ESSearch.__init__-305"><a href="#ESSearch.__init__-305"><span class="linenos">305</span></a><span class="sd">        ex: parameters = [</span>
</span><span id="ESSearch.__init__-306"><a href="#ESSearch.__init__-306"><span class="linenos">306</span></a><span class="sd">            {&#39;name&#39; : &#39;datation&#39;, &#39;operand&#39; : datetime.datetime(2022, 9, 19, 1), &#39;comparator&#39; : &#39;&gt;=&#39;},</span>
</span><span id="ESSearch.__init__-307"><a href="#ESSearch.__init__-307"><span class="linenos">307</span></a><span class="sd">            {&#39;name&#39; : &#39;property&#39;, &#39;operand&#39; : &#39;PM2&#39;}</span>
</span><span id="ESSearch.__init__-308"><a href="#ESSearch.__init__-308"><span class="linenos">308</span></a><span class="sd">        ]</span>
</span><span id="ESSearch.__init__-309"><a href="#ESSearch.__init__-309"><span class="linenos">309</span></a><span class="sd">        - **hide** : list (default []) - List of strings where strings correspond to paths to remove from the output</span>
</span><span id="ESSearch.__init__-310"><a href="#ESSearch.__init__-310"><span class="linenos">310</span></a><span class="sd">        - **heavy** :  bool (default False) - Must be True when values are defined directly and inside dictionnaries simultaneously.</span>
</span><span id="ESSearch.__init__-311"><a href="#ESSearch.__init__-311"><span class="linenos">311</span></a><span class="sd">        - **sources** : (default None) - Optional parameter indicating the sources of the data in case when a query is executed with parameter single = True.</span>
</span><span id="ESSearch.__init__-312"><a href="#ESSearch.__init__-312"><span class="linenos">312</span></a><span class="sd">        - **kwargs** :  other parameters are used as arguments for ESSearch.addCondition method.</span>
</span><span id="ESSearch.__init__-313"><a href="#ESSearch.__init__-313"><span class="linenos">313</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.__init__-314"><a href="#ESSearch.__init__-314"><span class="linenos">314</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>                                          <span class="c1"># self.parameters</span>
</span><span id="ESSearch.__init__-315"><a href="#ESSearch.__init__-315"><span class="linenos">315</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span>                     <span class="c1"># self.hide</span>
</span><span id="ESSearch.__init__-316"><a href="#ESSearch.__init__-316"><span class="linenos">316</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;hide must be a list.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.__init__-317"><a href="#ESSearch.__init__-317"><span class="linenos">317</span></a>
</span><span id="ESSearch.__init__-318"><a href="#ESSearch.__init__-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heavy</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="o">=</span> <span class="n">heavy</span>                  <span class="c1"># self.heavy</span>
</span><span id="ESSearch.__init__-319"><a href="#ESSearch.__init__-319"><span class="linenos">319</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;heavy must be a bool.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.__init__-320"><a href="#ESSearch.__init__-320"><span class="linenos">320</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>                                          <span class="c1"># self.sources</span>
</span><span id="ESSearch.__init__-321"><a href="#ESSearch.__init__-321"><span class="linenos">321</span></a>
</span><span id="ESSearch.__init__-322"><a href="#ESSearch.__init__-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>                                           <span class="c1"># self.input : formatted as [[Mongo Objects], [Observations]] (list of two lists)</span>
</span><span id="ESSearch.__init__-323"><a href="#ESSearch.__init__-323"><span class="linenos">323</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">pile</span> <span class="o">=</span> <span class="nb">input</span>
</span><span id="ESSearch.__init__-324"><a href="#ESSearch.__init__-324"><span class="linenos">324</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
</span><span id="ESSearch.__init__-325"><a href="#ESSearch.__init__-325"><span class="linenos">325</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ESSearch.__init__-326"><a href="#ESSearch.__init__-326"><span class="linenos">326</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="ESSearch.__init__-327"><a href="#ESSearch.__init__-327"><span class="linenos">327</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch.__init__-328"><a href="#ESSearch.__init__-328"><span class="linenos">328</span></a>                <span class="n">pile</span> <span class="o">+=</span> <span class="n">obj</span>
</span><span id="ESSearch.__init__-329"><a href="#ESSearch.__init__-329"><span class="linenos">329</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="ESSearch.__init__-330"><a href="#ESSearch.__init__-330"><span class="linenos">330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch.__init__-331"><a href="#ESSearch.__init__-331"><span class="linenos">331</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="n">Observation</span><span class="p">):</span>
</span><span id="ESSearch.__init__-332"><a href="#ESSearch.__init__-332"><span class="linenos">332</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch.__init__-333"><a href="#ESSearch.__init__-333"><span class="linenos">333</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
</span><span id="ESSearch.__init__-334"><a href="#ESSearch.__init__-334"><span class="linenos">334</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ESSearch.__init__-335"><a href="#ESSearch.__init__-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch.__init__-336"><a href="#ESSearch.__init__-336"><span class="linenos">336</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="ESSearch.__init__-337"><a href="#ESSearch.__init__-337"><span class="linenos">337</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to an Observation.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.__init__-338"><a href="#ESSearch.__init__-338"><span class="linenos">338</span></a>            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch.__init__-339"><a href="#ESSearch.__init__-339"><span class="linenos">339</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for input &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch.__init__-340"><a href="#ESSearch.__init__-340"><span class="linenos">340</span></a>
</span><span id="ESSearch.__init__-341"><a href="#ESSearch.__init__-341"><span class="linenos">341</span></a>        <span class="k">if</span> <span class="n">parameters</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addConditions</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="ESSearch.__init__-342"><a href="#ESSearch.__init__-342"><span class="linenos">342</span></a>        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>ESSearch constructor. Parameters can also be defined and updated using class methods.</p>

<p><em>Arguments</em></p>

<ul>
<li><strong>input</strong> : input on which the query is done. Must be one of or a list of these (can be nested):
<ul>
<li>pymongo.collection.Collection</li>
<li>pymongo.cursor.Cursor</li>
<li>pymongo.command_cursor.CommandCursor</li>
<li>Observation</li>
<li>str corresponding to a json Observation</li>
<li>dict corresponding to a json Observation</li>
</ul></li>
<li><strong>parameters</strong> :  dict, list (default None) - list of list or list of dictionnaries whose keys are arguments of <a href="#ESSearch.addCondition">ESSearch.addCondition</a> method
ex: parameters = [
{'name' : 'datation', 'operand' : datetime.datetime(2022, 9, 19, 1), 'comparator' : '>='},
{'name' : 'property', 'operand' : 'PM2'}
]</li>
<li><strong>hide</strong> : list (default []) - List of strings where strings correspond to paths to remove from the output</li>
<li><strong>heavy</strong> :  bool (default False) - Must be True when values are defined directly and inside dictionnaries simultaneously.</li>
<li><strong>sources</strong> : (default None) - Optional parameter indicating the sources of the data in case when a query is executed with parameter single = True.</li>
<li><strong>kwargs</strong> :  other parameters are used as arguments for <a href="#ESSearch.addCondition">ESSearch.addCondition</a> method.</li>
</ul>
</div>


                            </div>
                            <div id="ESSearch.addInput" class="classattr">
                                        <input id="ESSearch.addInput-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">addInput</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="nb">input</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.addInput-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.addInput"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.addInput-364"><a href="#ESSearch.addInput-364"><span class="linenos">364</span></a>    <span class="k">def</span> <span class="nf">addInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
</span><span id="ESSearch.addInput-365"><a href="#ESSearch.addInput-365"><span class="linenos">365</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ESSearch.addInput-366"><a href="#ESSearch.addInput-366"><span class="linenos">366</span></a><span class="sd">        Adds one or many inputs on which the query is to be executed given by argument input.</span>
</span><span id="ESSearch.addInput-367"><a href="#ESSearch.addInput-367"><span class="linenos">367</span></a><span class="sd">        Inputs can be:</span>
</span><span id="ESSearch.addInput-368"><a href="#ESSearch.addInput-368"><span class="linenos">368</span></a><span class="sd">            - pymongo.collection.Collection</span>
</span><span id="ESSearch.addInput-369"><a href="#ESSearch.addInput-369"><span class="linenos">369</span></a><span class="sd">            - pymongo.cursor.Cursor</span>
</span><span id="ESSearch.addInput-370"><a href="#ESSearch.addInput-370"><span class="linenos">370</span></a><span class="sd">            - pymongo.command_cursor.CommandCursor</span>
</span><span id="ESSearch.addInput-371"><a href="#ESSearch.addInput-371"><span class="linenos">371</span></a><span class="sd">            - Observation</span>
</span><span id="ESSearch.addInput-372"><a href="#ESSearch.addInput-372"><span class="linenos">372</span></a><span class="sd">            - str corresponding to a json Observation</span>
</span><span id="ESSearch.addInput-373"><a href="#ESSearch.addInput-373"><span class="linenos">373</span></a><span class="sd">            - dict corresponding to a json Observation</span>
</span><span id="ESSearch.addInput-374"><a href="#ESSearch.addInput-374"><span class="linenos">374</span></a><span class="sd">        or a list of any of these.</span>
</span><span id="ESSearch.addInput-375"><a href="#ESSearch.addInput-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ESSearch.addInput-376"><a href="#ESSearch.addInput-376"><span class="linenos">376</span></a>        <span class="n">added_input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
</span><span id="ESSearch.addInput-377"><a href="#ESSearch.addInput-377"><span class="linenos">377</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">pile</span> <span class="o">=</span> <span class="nb">input</span>
</span><span id="ESSearch.addInput-378"><a href="#ESSearch.addInput-378"><span class="linenos">378</span></a>        <span class="k">else</span><span class="p">:</span> <span class="n">pile</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="p">]</span>
</span><span id="ESSearch.addInput-379"><a href="#ESSearch.addInput-379"><span class="linenos">379</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># using a stack (LIFO) to allow easy treatment of nested data.</span>
</span><span id="ESSearch.addInput-380"><a href="#ESSearch.addInput-380"><span class="linenos">380</span></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">pile</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="ESSearch.addInput-381"><a href="#ESSearch.addInput-381"><span class="linenos">381</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ESSearch.addInput-382"><a href="#ESSearch.addInput-382"><span class="linenos">382</span></a>                <span class="n">pile</span> <span class="o">+=</span> <span class="n">obj</span>
</span><span id="ESSearch.addInput-383"><a href="#ESSearch.addInput-383"><span class="linenos">383</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">)):</span>
</span><span id="ESSearch.addInput-384"><a href="#ESSearch.addInput-384"><span class="linenos">384</span></a>                <span class="n">added_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch.addInput-385"><a href="#ESSearch.addInput-385"><span class="linenos">385</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>  <span class="n">Observation</span><span class="p">):</span>
</span><span id="ESSearch.addInput-386"><a href="#ESSearch.addInput-386"><span class="linenos">386</span></a>                <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ESSearch.addInput-387"><a href="#ESSearch.addInput-387"><span class="linenos">387</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
</span><span id="ESSearch.addInput-388"><a href="#ESSearch.addInput-388"><span class="linenos">388</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ESSearch.addInput-389"><a href="#ESSearch.addInput-389"><span class="linenos">389</span></a>                    <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch.addInput-390"><a href="#ESSearch.addInput-390"><span class="linenos">390</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="ESSearch.addInput-391"><a href="#ESSearch.addInput-391"><span class="linenos">391</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot convert &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to an Observation.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.addInput-392"><a href="#ESSearch.addInput-392"><span class="linenos">392</span></a>            <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch.addInput-393"><a href="#ESSearch.addInput-393"><span class="linenos">393</span></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported type for input &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="ESSearch.addInput-394"><a href="#ESSearch.addInput-394"><span class="linenos">394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">added_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># self.input is updated with the new inputs</span>
</span><span id="ESSearch.addInput-395"><a href="#ESSearch.addInput-395"><span class="linenos">395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">added_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Adds one or many inputs on which the query is to be executed given by argument input.
Inputs can be:
    - pymongo.collection.Collection
    - pymongo.cursor.Cursor
    - pymongo.command_cursor.CommandCursor
    - Observation
    - str corresponding to a json Observation
    - dict corresponding to a json Observation
or a list of any of these.</p>
</div>


                            </div>
                            <div id="ESSearch.removeInputs" class="classattr">
                                        <input id="ESSearch.removeInputs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">removeInputs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.removeInputs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.removeInputs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.removeInputs-397"><a href="#ESSearch.removeInputs-397"><span class="linenos">397</span></a>    <span class="k">def</span> <span class="nf">removeInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch.removeInputs-398"><a href="#ESSearch.removeInputs-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ESSearch.removeInputs-399"><a href="#ESSearch.removeInputs-399"><span class="linenos">399</span></a><span class="sd">        Removes all inputs from self.</span>
</span><span id="ESSearch.removeInputs-400"><a href="#ESSearch.removeInputs-400"><span class="linenos">400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ESSearch.removeInputs-401"><a href="#ESSearch.removeInputs-401"><span class="linenos">401</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
</span></pre></div>


            <div class="docstring"><p>Removes all inputs from self.</p>
</div>


                            </div>
                            <div id="ESSearch.setHide" class="classattr">
                                        <input id="ESSearch.setHide-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setHide</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">hide</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.setHide-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.setHide"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.setHide-403"><a href="#ESSearch.setHide-403"><span class="linenos">403</span></a>    <span class="k">def</span> <span class="nf">setHide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hide</span><span class="p">):</span>
</span><span id="ESSearch.setHide-404"><a href="#ESSearch.setHide-404"><span class="linenos">404</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.setHide-405"><a href="#ESSearch.setHide-405"><span class="linenos">405</span></a><span class="sd">        Sets self.hide to a value given by argument hide.</span>
</span><span id="ESSearch.setHide-406"><a href="#ESSearch.setHide-406"><span class="linenos">406</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.setHide-407"><a href="#ESSearch.setHide-407"><span class="linenos">407</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hide</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide</span> <span class="o">=</span> <span class="n">hide</span>
</span><span id="ESSearch.setHide-408"><a href="#ESSearch.setHide-408"><span class="linenos">408</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;hide must be a list.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sets self.hide to a value given by argument hide.</p>
</div>


                            </div>
                            <div id="ESSearch.setHeavy" class="classattr">
                                        <input id="ESSearch.setHeavy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setHeavy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">heavy</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.setHeavy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.setHeavy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.setHeavy-410"><a href="#ESSearch.setHeavy-410"><span class="linenos">410</span></a>    <span class="k">def</span> <span class="nf">setHeavy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heavy</span><span class="p">):</span>
</span><span id="ESSearch.setHeavy-411"><a href="#ESSearch.setHeavy-411"><span class="linenos">411</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.setHeavy-412"><a href="#ESSearch.setHeavy-412"><span class="linenos">412</span></a><span class="sd">        Sets self.heavy to a value given by argument heavy.</span>
</span><span id="ESSearch.setHeavy-413"><a href="#ESSearch.setHeavy-413"><span class="linenos">413</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.setHeavy-414"><a href="#ESSearch.setHeavy-414"><span class="linenos">414</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heavy</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span> <span class="o">=</span> <span class="n">heavy</span>
</span><span id="ESSearch.setHeavy-415"><a href="#ESSearch.setHeavy-415"><span class="linenos">415</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;heavy must be a bool.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sets self.heavy to a value given by argument heavy.</p>
</div>


                            </div>
                            <div id="ESSearch.setSources" class="classattr">
                                        <input id="ESSearch.setSources-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setSources</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">sources</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.setSources-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.setSources"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.setSources-417"><a href="#ESSearch.setSources-417"><span class="linenos">417</span></a>    <span class="k">def</span> <span class="nf">setSources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
</span><span id="ESSearch.setSources-418"><a href="#ESSearch.setSources-418"><span class="linenos">418</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.setSources-419"><a href="#ESSearch.setSources-419"><span class="linenos">419</span></a><span class="sd">        Sets self.sources to a value given by argument sources.</span>
</span><span id="ESSearch.setSources-420"><a href="#ESSearch.setSources-420"><span class="linenos">420</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.setSources-421"><a href="#ESSearch.setSources-421"><span class="linenos">421</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
</span></pre></div>


            <div class="docstring"><p>Sets self.sources to a value given by argument sources.</p>
</div>


                            </div>
                            <div id="ESSearch.addConditions" class="classattr">
                                        <input id="ESSearch.addConditions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">addConditions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">parameters</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.addConditions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.addConditions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.addConditions-423"><a href="#ESSearch.addConditions-423"><span class="linenos">423</span></a>    <span class="k">def</span> <span class="nf">addConditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
</span><span id="ESSearch.addConditions-424"><a href="#ESSearch.addConditions-424"><span class="linenos">424</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.addConditions-425"><a href="#ESSearch.addConditions-425"><span class="linenos">425</span></a><span class="sd">        Takes multiple parameters and applies self.addCondition() on each of them.</span>
</span><span id="ESSearch.addConditions-426"><a href="#ESSearch.addConditions-426"><span class="linenos">426</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.addConditions-427"><a href="#ESSearch.addConditions-427"><span class="linenos">427</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="c1"># case when one single condition is added</span>
</span><span id="ESSearch.addConditions-428"><a href="#ESSearch.addConditions-428"><span class="linenos">428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
</span><span id="ESSearch.addConditions-429"><a href="#ESSearch.addConditions-429"><span class="linenos">429</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="c1"># case when several conditions are added</span>
</span><span id="ESSearch.addConditions-430"><a href="#ESSearch.addConditions-430"><span class="linenos">430</span></a>            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
</span><span id="ESSearch.addConditions-431"><a href="#ESSearch.addConditions-431"><span class="linenos">431</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">**</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="ESSearch.addConditions-432"><a href="#ESSearch.addConditions-432"><span class="linenos">432</span></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="o">*</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="ESSearch.addConditions-433"><a href="#ESSearch.addConditions-433"><span class="linenos">433</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
</span><span id="ESSearch.addConditions-434"><a href="#ESSearch.addConditions-434"><span class="linenos">434</span></a>        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;parameters must be either a dict or a list of dict.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Takes multiple parameters and applies self.addCondition() on each of them.</p>
</div>


                            </div>
                            <div id="ESSearch.addCondition" class="classattr">
                                        <input id="ESSearch.addCondition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">addCondition</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path</span>, </span><span class="param"><span class="n">operand</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">comparator</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">or_position</span><span class="o">=-</span><span class="mi">1</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.addCondition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.addCondition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.addCondition-436"><a href="#ESSearch.addCondition-436"><span class="linenos">436</span></a>    <span class="k">def</span> <span class="nf">addCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">operand</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comparator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">or_position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ESSearch.addCondition-437"><a href="#ESSearch.addCondition-437"><span class="linenos">437</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.addCondition-438"><a href="#ESSearch.addCondition-438"><span class="linenos">438</span></a><span class="sd">        Takes parameters and inserts corresponding query condition in self.parameters.</span>
</span><span id="ESSearch.addCondition-439"><a href="#ESSearch.addCondition-439"><span class="linenos">439</span></a>
</span><span id="ESSearch.addCondition-440"><a href="#ESSearch.addCondition-440"><span class="linenos">440</span></a><span class="sd">        *Parameters*</span>
</span><span id="ESSearch.addCondition-441"><a href="#ESSearch.addCondition-441"><span class="linenos">441</span></a>
</span><span id="ESSearch.addCondition-442"><a href="#ESSearch.addCondition-442"><span class="linenos">442</span></a><span class="sd">        - **path** :  str (required argument) - name of an IIndex, which corresponds to an Ilist column name, or name of a metadata element.</span>
</span><span id="ESSearch.addCondition-443"><a href="#ESSearch.addCondition-443"><span class="linenos">443</span></a><span class="sd">                    (ex: &#39;datation&#39;, &#39;location&#39;, &#39;property&#39;)</span>
</span><span id="ESSearch.addCondition-444"><a href="#ESSearch.addCondition-444"><span class="linenos">444</span></a>
</span><span id="ESSearch.addCondition-445"><a href="#ESSearch.addCondition-445"><span class="linenos">445</span></a><span class="sd">        - **operand** :  - (default None) - Object used for the comparison.</span>
</span><span id="ESSearch.addCondition-446"><a href="#ESSearch.addCondition-446"><span class="linenos">446</span></a><span class="sd">                    (ex: if we search for observations made in Paris, operand is &#39;Paris&#39;)</span>
</span><span id="ESSearch.addCondition-447"><a href="#ESSearch.addCondition-447"><span class="linenos">447</span></a>
</span><span id="ESSearch.addCondition-448"><a href="#ESSearch.addCondition-448"><span class="linenos">448</span></a><span class="sd">        - **comparator**:  str (default None) - str giving the comparator to use. (ex: &#39;&gt;=&#39;, &#39;in&#39;)</span>
</span><span id="ESSearch.addCondition-449"><a href="#ESSearch.addCondition-449"><span class="linenos">449</span></a><span class="sd">        </span>
</span><span id="ESSearch.addCondition-450"><a href="#ESSearch.addCondition-450"><span class="linenos">450</span></a><span class="sd">        - **or_position** :  int (default -1) - position in self.parameters in which the condition is to be inserted.</span>
</span><span id="ESSearch.addCondition-451"><a href="#ESSearch.addCondition-451"><span class="linenos">451</span></a>
</span><span id="ESSearch.addCondition-452"><a href="#ESSearch.addCondition-452"><span class="linenos">452</span></a><span class="sd">        - **formatstring** :  str (default None) - str to use to automatically change str to datetime before applying condition.</span>
</span><span id="ESSearch.addCondition-453"><a href="#ESSearch.addCondition-453"><span class="linenos">453</span></a><span class="sd">                    Does not update the data base. If value is set to &#39;default&#39;, format is assumed to be Isoformat.</span>
</span><span id="ESSearch.addCondition-454"><a href="#ESSearch.addCondition-454"><span class="linenos">454</span></a><span class="sd">        </span>
</span><span id="ESSearch.addCondition-455"><a href="#ESSearch.addCondition-455"><span class="linenos">455</span></a><span class="sd">        - **inverted** :  bool (default None) - to add a &quot;not&quot; in the condition.</span>
</span><span id="ESSearch.addCondition-456"><a href="#ESSearch.addCondition-456"><span class="linenos">456</span></a><span class="sd">                    To use in case where every element of a MongoDB array (equivalent to python list) must verify the condition (by default, condition is verified when at least one element of the array verifies it).</span>
</span><span id="ESSearch.addCondition-457"><a href="#ESSearch.addCondition-457"><span class="linenos">457</span></a><span class="sd">        </span>
</span><span id="ESSearch.addCondition-458"><a href="#ESSearch.addCondition-458"><span class="linenos">458</span></a><span class="sd">        - **unwind** :  int (default None) - int corresponding to the number of additional {&quot;$unwind&quot; : &quot;$&quot; + path} to be added in the beginning of the query.</span>
</span><span id="ESSearch.addCondition-459"><a href="#ESSearch.addCondition-459"><span class="linenos">459</span></a><span class="sd">        </span>
</span><span id="ESSearch.addCondition-460"><a href="#ESSearch.addCondition-460"><span class="linenos">460</span></a><span class="sd">        - **regex_options** :  str (default None) - str associated to regex options (i, m, x and s). See [this link](https://www.mongodb.com/docs/manual/reference/operator/query/regex/) for more details.</span>
</span><span id="ESSearch.addCondition-461"><a href="#ESSearch.addCondition-461"><span class="linenos">461</span></a>
</span><span id="ESSearch.addCondition-462"><a href="#ESSearch.addCondition-462"><span class="linenos">462</span></a><span class="sd">        no comparator =&gt; default comparator associated with operand type in dico_alias_mongo is used (mainly equality)</span>
</span><span id="ESSearch.addCondition-463"><a href="#ESSearch.addCondition-463"><span class="linenos">463</span></a><span class="sd">        no operand =&gt; only the existence of something located at path is tested</span>
</span><span id="ESSearch.addCondition-464"><a href="#ESSearch.addCondition-464"><span class="linenos">464</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.addCondition-465"><a href="#ESSearch.addCondition-465"><span class="linenos">465</span></a>
</span><span id="ESSearch.addCondition-466"><a href="#ESSearch.addCondition-466"><span class="linenos">466</span></a>        <span class="c1">## 1. Check if arguments given are valid.</span>
</span><span id="ESSearch.addCondition-467"><a href="#ESSearch.addCondition-467"><span class="linenos">467</span></a>
</span><span id="ESSearch.addCondition-468"><a href="#ESSearch.addCondition-468"><span class="linenos">468</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name must be a str.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-469"><a href="#ESSearch.addCondition-469"><span class="linenos">469</span></a>        <span class="k">if</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;comparator must be a str.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-470"><a href="#ESSearch.addCondition-470"><span class="linenos">470</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">or_position</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;or_position must be an int.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-471"><a href="#ESSearch.addCondition-471"><span class="linenos">471</span></a>
</span><span id="ESSearch.addCondition-472"><a href="#ESSearch.addCondition-472"><span class="linenos">472</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="c1"># checking if parameters in kwarg do exist</span>
</span><span id="ESSearch.addCondition-473"><a href="#ESSearch.addCondition-473"><span class="linenos">473</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;formatstring&#39;</span><span class="p">,</span> <span class="s1">&#39;inverted&#39;</span><span class="p">,</span> <span class="s1">&#39;unwind&#39;</span><span class="p">,</span> <span class="s1">&#39;regex_options&#39;</span><span class="p">,</span> <span class="s1">&#39;distanceField&#39;</span><span class="p">,</span> <span class="s1">&#39;distanceMultiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;includeLocs&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;maxDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;minDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;near&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;spherical&#39;</span><span class="p">}:</span>
</span><span id="ESSearch.addCondition-474"><a href="#ESSearch.addCondition-474"><span class="linenos">474</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown parameter : &quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-475"><a href="#ESSearch.addCondition-475"><span class="linenos">475</span></a>
</span><span id="ESSearch.addCondition-476"><a href="#ESSearch.addCondition-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">operand</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ESSearch.addCondition-477"><a href="#ESSearch.addCondition-477"><span class="linenos">477</span></a>            <span class="n">operand</span> <span class="o">=</span> <span class="n">operand</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-478"><a href="#ESSearch.addCondition-478"><span class="linenos">478</span></a>
</span><span id="ESSearch.addCondition-479"><a href="#ESSearch.addCondition-479"><span class="linenos">479</span></a>        <span class="k">if</span> <span class="n">operand</span><span class="p">:</span> <span class="c1"># checking if comparator can be applied on the operand</span>
</span><span id="ESSearch.addCondition-480"><a href="#ESSearch.addCondition-480"><span class="linenos">480</span></a>            <span class="k">try</span><span class="p">:</span> <span class="n">comparator</span> <span class="o">=</span> <span class="n">dico_alias_mongo</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">operand</span><span class="p">)][</span><span class="n">comparator</span><span class="p">]</span>
</span><span id="ESSearch.addCondition-481"><a href="#ESSearch.addCondition-481"><span class="linenos">481</span></a>            <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incompatible values for comparator and operand. Ensure parameters are in the correct order.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-482"><a href="#ESSearch.addCondition-482"><span class="linenos">482</span></a>        <span class="k">elif</span> <span class="n">comparator</span><span class="p">:</span>
</span><span id="ESSearch.addCondition-483"><a href="#ESSearch.addCondition-483"><span class="linenos">483</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;operand must be defined when comparator is used.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.addCondition-484"><a href="#ESSearch.addCondition-484"><span class="linenos">484</span></a>        
</span><span id="ESSearch.addCondition-485"><a href="#ESSearch.addCondition-485"><span class="linenos">485</span></a>        <span class="c1">## 2. Add the condition to self.parameters</span>
</span><span id="ESSearch.addCondition-486"><a href="#ESSearch.addCondition-486"><span class="linenos">486</span></a>
</span><span id="ESSearch.addCondition-487"><a href="#ESSearch.addCondition-487"><span class="linenos">487</span></a>        <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;comparator&quot;</span> <span class="p">:</span> <span class="n">comparator</span><span class="p">,</span> <span class="s2">&quot;operand&quot;</span> <span class="p">:</span> <span class="n">operand</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span> <span class="p">:</span> <span class="n">path</span><span class="p">}</span> <span class="o">|</span> <span class="n">kwargs</span>
</span><span id="ESSearch.addCondition-488"><a href="#ESSearch.addCondition-488"><span class="linenos">488</span></a>
</span><span id="ESSearch.addCondition-489"><a href="#ESSearch.addCondition-489"><span class="linenos">489</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">):</span>
</span><span id="ESSearch.addCondition-490"><a href="#ESSearch.addCondition-490"><span class="linenos">490</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">condition</span><span class="p">])</span>
</span><span id="ESSearch.addCondition-491"><a href="#ESSearch.addCondition-491"><span class="linenos">491</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.addCondition-492"><a href="#ESSearch.addCondition-492"><span class="linenos">492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Takes parameters and inserts corresponding query condition in self.parameters.</p>

<p><em>Parameters</em></p>

<ul>
<li><p><strong>path</strong> :  str (required argument) - name of an IIndex, which corresponds to an Ilist column name, or name of a metadata element.
        (ex: 'datation', 'location', 'property')</p></li>
<li><p><strong>operand</strong> :  - (default None) - Object used for the comparison.
        (ex: if we search for observations made in Paris, operand is 'Paris')</p></li>
<li><p><strong>comparator</strong>:  str (default None) - str giving the comparator to use. (ex: '>=', 'in')</p></li>
<li><p><strong>or_position</strong> :  int (default -1) - position in self.parameters in which the condition is to be inserted.</p></li>
<li><p><strong>formatstring</strong> :  str (default None) - str to use to automatically change str to datetime before applying condition.
        Does not update the data base. If value is set to 'default', format is assumed to be Isoformat.</p></li>
<li><p><strong>inverted</strong> :  bool (default None) - to add a "not" in the condition.
        To use in case where every element of a MongoDB array (equivalent to python list) must verify the condition (by default, condition is verified when at least one element of the array verifies it).</p></li>
<li><p><strong>unwind</strong> :  int (default None) - int corresponding to the number of additional {"$unwind" : "$" + path} to be added in the beginning of the query.</p></li>
<li><p><strong>regex_options</strong> :  str (default None) - str associated to regex options (i, m, x and s). See <a href="https://www.mongodb.com/docs/manual/reference/operator/query/regex/">this link</a> for more details.</p></li>
</ul>

<p>no comparator =&gt; default comparator associated with operand type in dico_alias_mongo is used (mainly equality)
no operand =&gt; only the existence of something located at path is tested</p>
</div>


                            </div>
                            <div id="ESSearch.orCondition" class="classattr">
                                        <input id="ESSearch.orCondition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">orCondition</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.orCondition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.orCondition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.orCondition-494"><a href="#ESSearch.orCondition-494"><span class="linenos">494</span></a>    <span class="k">def</span> <span class="nf">orCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ESSearch.orCondition-495"><a href="#ESSearch.orCondition-495"><span class="linenos">495</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.orCondition-496"><a href="#ESSearch.orCondition-496"><span class="linenos">496</span></a><span class="sd">        Adds a condition in a new sublist in self.parameters. Separations in sublists correspond to &quot;or&quot; in the query.</span>
</span><span id="ESSearch.orCondition-497"><a href="#ESSearch.orCondition-497"><span class="linenos">497</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.orCondition-498"><a href="#ESSearch.orCondition-498"><span class="linenos">498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">addCondition</span><span class="p">(</span><span class="n">or_position</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Adds a condition in a new sublist in self.parameters. Separations in sublists correspond to "or" in the query.</p>
</div>


                            </div>
                            <div id="ESSearch.removeCondition" class="classattr">
                                        <input id="ESSearch.removeCondition-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">removeCondition</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">or_position</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">condnum</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.removeCondition-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.removeCondition"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.removeCondition-500"><a href="#ESSearch.removeCondition-500"><span class="linenos">500</span></a>    <span class="k">def</span> <span class="nf">removeCondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">or_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">condnum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ESSearch.removeCondition-501"><a href="#ESSearch.removeCondition-501"><span class="linenos">501</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.removeCondition-502"><a href="#ESSearch.removeCondition-502"><span class="linenos">502</span></a><span class="sd">        Removes a condition from self.parameters. By default, last element added is removed.</span>
</span><span id="ESSearch.removeCondition-503"><a href="#ESSearch.removeCondition-503"><span class="linenos">503</span></a><span class="sd">        Otherwise, the removed condition is the one at self.parameters[or_position][condnum].</span>
</span><span id="ESSearch.removeCondition-504"><a href="#ESSearch.removeCondition-504"><span class="linenos">504</span></a>
</span><span id="ESSearch.removeCondition-505"><a href="#ESSearch.removeCondition-505"><span class="linenos">505</span></a><span class="sd">        To remove all conditions, use ESSearch.clearConditions() method.</span>
</span><span id="ESSearch.removeCondition-506"><a href="#ESSearch.removeCondition-506"><span class="linenos">506</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.removeCondition-507"><a href="#ESSearch.removeCondition-507"><span class="linenos">507</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[[]]:</span> <span class="k">return</span>
</span><span id="ESSearch.removeCondition-508"><a href="#ESSearch.removeCondition-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="n">or_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch.removeCondition-509"><a href="#ESSearch.removeCondition-509"><span class="linenos">509</span></a>            <span class="k">if</span> <span class="n">condnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># by default : remove the very last added condition.</span>
</span><span id="ESSearch.removeCondition-510"><a href="#ESSearch.removeCondition-510"><span class="linenos">510</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ESSearch.removeCondition-511"><a href="#ESSearch.removeCondition-511"><span class="linenos">511</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ESSearch.removeCondition-512"><a href="#ESSearch.removeCondition-512"><span class="linenos">512</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.removeCondition-513"><a href="#ESSearch.removeCondition-513"><span class="linenos">513</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">condnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">condnum</span><span class="p">)</span>
</span><span id="ESSearch.removeCondition-514"><a href="#ESSearch.removeCondition-514"><span class="linenos">514</span></a>                <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ESSearch.removeCondition-515"><a href="#ESSearch.removeCondition-515"><span class="linenos">515</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.removeCondition-516"><a href="#ESSearch.removeCondition-516"><span class="linenos">516</span></a>            <span class="k">if</span> <span class="n">condnum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">condnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">or_position</span><span class="p">)</span> <span class="c1"># if or_position is not None and condnum is, the whole sublist at or_position is removed.</span>
</span><span id="ESSearch.removeCondition-517"><a href="#ESSearch.removeCondition-517"><span class="linenos">517</span></a>            <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">or_position</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">condnum</span><span class="p">)</span>
</span><span id="ESSearch.removeCondition-518"><a href="#ESSearch.removeCondition-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">==</span> <span class="p">[]:</span> <span class="c1"># ensure self.parameters returns to its default value after being emptied</span>
</span><span id="ESSearch.removeCondition-519"><a href="#ESSearch.removeCondition-519"><span class="linenos">519</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>
</span></pre></div>


            <div class="docstring"><p>Removes a condition from self.parameters. By default, last element added is removed.
Otherwise, the removed condition is the one at self.parameters[or_position][condnum].</p>

<p>To remove all conditions, use <a href="#ESSearch.clearConditions">ESSearch.clearConditions()</a> method.</p>
</div>


                            </div>
                            <div id="ESSearch.clearConditions" class="classattr">
                                        <input id="ESSearch.clearConditions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clearConditions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.clearConditions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.clearConditions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.clearConditions-521"><a href="#ESSearch.clearConditions-521"><span class="linenos">521</span></a>    <span class="k">def</span> <span class="nf">clearConditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch.clearConditions-522"><a href="#ESSearch.clearConditions-522"><span class="linenos">522</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.clearConditions-523"><a href="#ESSearch.clearConditions-523"><span class="linenos">523</span></a><span class="sd">        Removes all conditions from self.parameters.</span>
</span><span id="ESSearch.clearConditions-524"><a href="#ESSearch.clearConditions-524"><span class="linenos">524</span></a><span class="sd">        To remove all attributes, use ESSearch.clear() method.</span>
</span><span id="ESSearch.clearConditions-525"><a href="#ESSearch.clearConditions-525"><span class="linenos">525</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.clearConditions-526"><a href="#ESSearch.clearConditions-526"><span class="linenos">526</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[[]]</span>
</span></pre></div>


            <div class="docstring"><p>Removes all conditions from self.parameters.
To remove all attributes, use <a href="#ESSearch.clear">ESSearch.clear()</a> method.</p>
</div>


                            </div>
                            <div id="ESSearch.clear" class="classattr">
                                        <input id="ESSearch.clear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.clear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.clear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.clear-528"><a href="#ESSearch.clear-528"><span class="linenos">528</span></a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ESSearch.clear-529"><a href="#ESSearch.clear-529"><span class="linenos">529</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.clear-530"><a href="#ESSearch.clear-530"><span class="linenos">530</span></a><span class="sd">        Resets self.</span>
</span><span id="ESSearch.clear-531"><a href="#ESSearch.clear-531"><span class="linenos">531</span></a><span class="sd">        (Creating a new Observation would be smarter than using this function.)</span>
</span><span id="ESSearch.clear-532"><a href="#ESSearch.clear-532"><span class="linenos">532</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.clear-533"><a href="#ESSearch.clear-533"><span class="linenos">533</span></a>        <span class="bp">self</span> <span class="o">=</span> <span class="n">ESSearch</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Resets self.
(Creating a new Observation would be smarter than using this function.)</p>
</div>


                            </div>
                            <div id="ESSearch.request" class="classattr">
                                <div class="attr variable">
            <span class="name">request</span>

        
    </div>
    <a class="headerlink" href="#ESSearch.request"></a>
    
            <div class="docstring"><p>Getter returning the content of the query or aggregation query to be executed with <a href="#ESSearch.execute">ESSearch.execute()</a>.</p>
</div>


                            </div>
                            <div id="ESSearch.cursor" class="classattr">
                                <div class="attr variable">
            <span class="name">cursor</span>

        
    </div>
    <a class="headerlink" href="#ESSearch.cursor"></a>
    
            <div class="docstring"><p>Getter returning the cursors of the query or aggregation query result on all collections and cursors contained in self.input.</p>
</div>


                            </div>
                            <div id="ESSearch.execute" class="classattr">
                                        <input id="ESSearch.execute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">execute</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">returnmode</span><span class="o">=</span><span class="s1">&#39;observation&#39;</span>,</span><span class="param">	<span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">name</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">param</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ESSearch.execute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ESSearch.execute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ESSearch.execute-751"><a href="#ESSearch.execute-751"><span class="linenos">751</span></a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returnmode</span> <span class="o">=</span> <span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="n">fillvalue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="ESSearch.execute-752"><a href="#ESSearch.execute-752"><span class="linenos">752</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="ESSearch.execute-753"><a href="#ESSearch.execute-753"><span class="linenos">753</span></a><span class="sd">        Executes the request and returns its result, either in one or many Observations.</span>
</span><span id="ESSearch.execute-754"><a href="#ESSearch.execute-754"><span class="linenos">754</span></a>
</span><span id="ESSearch.execute-755"><a href="#ESSearch.execute-755"><span class="linenos">755</span></a><span class="sd">        *Parameter*</span>
</span><span id="ESSearch.execute-756"><a href="#ESSearch.execute-756"><span class="linenos">756</span></a>
</span><span id="ESSearch.execute-757"><a href="#ESSearch.execute-757"><span class="linenos">757</span></a><span class="sd">        - **returnmode** : str (default None) - Parameter giving the format of the output:</span>
</span><span id="ESSearch.execute-758"><a href="#ESSearch.execute-758"><span class="linenos">758</span></a><span class="sd">            - &#39;unchanged&#39; : output is returned as it is in the database, some operations like operations sepcific to TimeSlot object are not performed;</span>
</span><span id="ESSearch.execute-759"><a href="#ESSearch.execute-759"><span class="linenos">759</span></a><span class="sd">            - &#39;observation&#39;: Each element is returned as an observation, but original observations aren&#39;t recreated;</span>
</span><span id="ESSearch.execute-760"><a href="#ESSearch.execute-760"><span class="linenos">760</span></a><span class="sd">            - &#39;idfused&#39;: observations whose ids are the same are merged together; </span>
</span><span id="ESSearch.execute-761"><a href="#ESSearch.execute-761"><span class="linenos">761</span></a><span class="sd">            - &#39;single&#39;: return a single observation merging all observations together.</span>
</span><span id="ESSearch.execute-762"><a href="#ESSearch.execute-762"><span class="linenos">762</span></a><span class="sd">        - **fillvalue** :  (default None) - Value to use to fill gaps when observations are merged together.</span>
</span><span id="ESSearch.execute-763"><a href="#ESSearch.execute-763"><span class="linenos">763</span></a><span class="sd">        - **name** : str (default None) - name of the output observation when returnmode is &#39;single&#39;.</span>
</span><span id="ESSearch.execute-764"><a href="#ESSearch.execute-764"><span class="linenos">764</span></a><span class="sd">        - **param** : dict (default None) - param of the output observation when returnmode is &#39;single&#39;.</span>
</span><span id="ESSearch.execute-765"><a href="#ESSearch.execute-765"><span class="linenos">765</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="ESSearch.execute-766"><a href="#ESSearch.execute-766"><span class="linenos">766</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;unchanged&#39;</span><span class="p">,</span> <span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="s1">&#39;idfused&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">}:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;returnmode must have one of these values: &#39;unchanged&#39;, &#39;observation&#39;, &#39;idfused&#39;, &#39;single&#39;.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.execute-767"><a href="#ESSearch.execute-767"><span class="linenos">767</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch.execute-768"><a href="#ESSearch.execute-768"><span class="linenos">768</span></a>            <span class="k">if</span> <span class="n">name</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>  <span class="p">:</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;name should be a string.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.execute-769"><a href="#ESSearch.execute-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;param should be a dictionnary.&quot;</span><span class="p">)</span>
</span><span id="ESSearch.execute-770"><a href="#ESSearch.execute-770"><span class="linenos">770</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Boolean put to True inside of self._cond() if an additional filtering specific to TimeSlot and shapely geometries is necessary.</span>
</span><span id="ESSearch.execute-771"><a href="#ESSearch.execute-771"><span class="linenos">771</span></a>        
</span><span id="ESSearch.execute-772"><a href="#ESSearch.execute-772"><span class="linenos">772</span></a>        <span class="c1">## Construction of a result list where data are in the format given by returnmode</span>
</span><span id="ESSearch.execute-773"><a href="#ESSearch.execute-773"><span class="linenos">773</span></a>        
</span><span id="ESSearch.execute-774"><a href="#ESSearch.execute-774"><span class="linenos">774</span></a>        <span class="c1">## ESSearch.execute() 1: Query is executed on each Mongo Collection or Cursor of self.input</span>
</span><span id="ESSearch.execute-775"><a href="#ESSearch.execute-775"><span class="linenos">775</span></a>
</span><span id="ESSearch.execute-776"><a href="#ESSearch.execute-776"><span class="linenos">776</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch.execute-777"><a href="#ESSearch.execute-777"><span class="linenos">777</span></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="ESSearch.execute-778"><a href="#ESSearch.execute-778"><span class="linenos">778</span></a>            <span class="n">request_type</span><span class="p">,</span> <span class="n">request_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fullSearchMongo</span><span class="p">()</span>
</span><span id="ESSearch.execute-779"><a href="#ESSearch.execute-779"><span class="linenos">779</span></a>            <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s1">&#39;find&#39;</span><span class="p">:</span>
</span><span id="ESSearch.execute-780"><a href="#ESSearch.execute-780"><span class="linenos">780</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">request_content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">)</span>
</span><span id="ESSearch.execute-781"><a href="#ESSearch.execute-781"><span class="linenos">781</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-782"><a href="#ESSearch.execute-782"><span class="linenos">782</span></a>                <span class="n">cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">request_content</span><span class="p">)</span>
</span><span id="ESSearch.execute-783"><a href="#ESSearch.execute-783"><span class="linenos">783</span></a>
</span><span id="ESSearch.execute-784"><a href="#ESSearch.execute-784"><span class="linenos">784</span></a>            <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;observation&#39;</span><span class="p">:</span> <span class="c1"># Only in this case is an observation created directly.</span>
</span><span id="ESSearch.execute-785"><a href="#ESSearch.execute-785"><span class="linenos">785</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="ESSearch.execute-786"><a href="#ESSearch.execute-786"><span class="linenos">786</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="c1"># Additional filtering for objects like TimeSlot who need it</span>
</span><span id="ESSearch.execute-787"><a href="#ESSearch.execute-787"><span class="linenos">787</span></a>                        <span class="k">for</span> <span class="n">conds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
</span><span id="ESSearch.execute-788"><a href="#ESSearch.execute-788"><span class="linenos">788</span></a>                            <span class="n">checks_parameters</span><span class="p">,</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="ESSearch.execute-789"><a href="#ESSearch.execute-789"><span class="linenos">789</span></a>                            <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conds</span><span class="p">:</span>
</span><span id="ESSearch.execute-790"><a href="#ESSearch.execute-790"><span class="linenos">790</span></a>                                <span class="k">if</span> <span class="n">cond</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch.execute-791"><a href="#ESSearch.execute-791"><span class="linenos">791</span></a>                                    <span class="k">try</span><span class="p">:</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="n">checks_conds</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condcheck</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">cond</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]],</span> <span class="n">cond</span><span class="p">)</span> <span class="c1"># checking for each condition if it is satisfied</span>
</span><span id="ESSearch.execute-792"><a href="#ESSearch.execute-792"><span class="linenos">792</span></a>                                    <span class="k">except</span><span class="p">:</span> <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ESSearch.execute-793"><a href="#ESSearch.execute-793"><span class="linenos">793</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-794"><a href="#ESSearch.execute-794"><span class="linenos">794</span></a>                                    <span class="n">checks_conds</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ESSearch.execute-795"><a href="#ESSearch.execute-795"><span class="linenos">795</span></a>                            <span class="n">checks_parameters</span> <span class="o">=</span> <span class="n">checks_parameters</span> <span class="ow">or</span> <span class="n">checks_conds</span>
</span><span id="ESSearch.execute-796"><a href="#ESSearch.execute-796"><span class="linenos">796</span></a>                    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch.execute-797"><a href="#ESSearch.execute-797"><span class="linenos">797</span></a>                    <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch.execute-798"><a href="#ESSearch.execute-798"><span class="linenos">798</span></a>                        <span class="k">if</span> <span class="s1">&#39;name&#39;</span>  <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-799"><a href="#ESSearch.execute-799"><span class="linenos">799</span></a>                        <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-800"><a href="#ESSearch.execute-800"><span class="linenos">800</span></a>                        <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-801"><a href="#ESSearch.execute-801"><span class="linenos">801</span></a>                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
</span><span id="ESSearch.execute-802"><a href="#ESSearch.execute-802"><span class="linenos">802</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span> <span class="ow">and</span> <span class="n">checks_parameters</span><span class="p">):</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="o">**</span><span class="n">dic</span><span class="p">))</span>
</span><span id="ESSearch.execute-803"><a href="#ESSearch.execute-803"><span class="linenos">803</span></a>
</span><span id="ESSearch.execute-804"><a href="#ESSearch.execute-804"><span class="linenos">804</span></a>            <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch.execute-805"><a href="#ESSearch.execute-805"><span class="linenos">805</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="ESSearch.execute-806"><a href="#ESSearch.execute-806"><span class="linenos">806</span></a>                    <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="p">:</span> <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-807"><a href="#ESSearch.execute-807"><span class="linenos">807</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch.execute-808"><a href="#ESSearch.execute-808"><span class="linenos">808</span></a>
</span><span id="ESSearch.execute-809"><a href="#ESSearch.execute-809"><span class="linenos">809</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># returnmode == &#39;unchanged&#39; or returnmode == &#39;idfused&#39;</span>
</span><span id="ESSearch.execute-810"><a href="#ESSearch.execute-810"><span class="linenos">810</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
</span><span id="ESSearch.execute-811"><a href="#ESSearch.execute-811"><span class="linenos">811</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch.execute-812"><a href="#ESSearch.execute-812"><span class="linenos">812</span></a>                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch.execute-813"><a href="#ESSearch.execute-813"><span class="linenos">813</span></a>
</span><span id="ESSearch.execute-814"><a href="#ESSearch.execute-814"><span class="linenos">814</span></a>        <span class="c1">## ESSearch.execute() 2: Operations for cases &#39;idfused&#39; and &#39;single&#39; are performed on output objects.</span>
</span><span id="ESSearch.execute-815"><a href="#ESSearch.execute-815"><span class="linenos">815</span></a>        <span class="c1"># (more efficient to do it like this than after a conversion to Observation)</span>
</span><span id="ESSearch.execute-816"><a href="#ESSearch.execute-816"><span class="linenos">816</span></a>
</span><span id="ESSearch.execute-817"><a href="#ESSearch.execute-817"><span class="linenos">817</span></a>        <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch.execute-818"><a href="#ESSearch.execute-818"><span class="linenos">818</span></a>            <span class="n">arg</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># argument to be given to Observation.dic() merging all observations together</span>
</span><span id="ESSearch.execute-819"><a href="#ESSearch.execute-819"><span class="linenos">819</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
</span><span id="ESSearch.execute-820"><a href="#ESSearch.execute-820"><span class="linenos">820</span></a>                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span> <span class="c1"># for columns already in the new Observation</span>
</span><span id="ESSearch.execute-821"><a href="#ESSearch.execute-821"><span class="linenos">821</span></a>                    <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="ESSearch.execute-822"><a href="#ESSearch.execute-822"><span class="linenos">822</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch.execute-823"><a href="#ESSearch.execute-823"><span class="linenos">823</span></a>                <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="c1"># for columns missing in the new Observation</span>
</span><span id="ESSearch.execute-824"><a href="#ESSearch.execute-824"><span class="linenos">824</span></a>                    <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
</span><span id="ESSearch.execute-825"><a href="#ESSearch.execute-825"><span class="linenos">825</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">column_name</span><span class="p">]]</span> <span class="c1"># an empty column filled with fillvalue is added if a new column name is encountered</span>
</span><span id="ESSearch.execute-826"><a href="#ESSearch.execute-826"><span class="linenos">826</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-827"><a href="#ESSearch.execute-827"><span class="linenos">827</span></a>                        <span class="n">arg</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="ESSearch.execute-828"><a href="#ESSearch.execute-828"><span class="linenos">828</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="n">arg</span><span class="p">))]</span>
</span><span id="ESSearch.execute-829"><a href="#ESSearch.execute-829"><span class="linenos">829</span></a>            <span class="k">else</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
</span><span id="ESSearch.execute-830"><a href="#ESSearch.execute-830"><span class="linenos">830</span></a>
</span><span id="ESSearch.execute-831"><a href="#ESSearch.execute-831"><span class="linenos">831</span></a>        <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;idfused&#39;</span><span class="p">:</span>
</span><span id="ESSearch.execute-832"><a href="#ESSearch.execute-832"><span class="linenos">832</span></a>            <span class="n">hashs_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch.execute-833"><a href="#ESSearch.execute-833"><span class="linenos">833</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="ESSearch.execute-834"><a href="#ESSearch.execute-834"><span class="linenos">834</span></a>                <span class="nb">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="c1"># will throw an error if item has no id. Should items with no id be let as is or merged together?</span>
</span><span id="ESSearch.execute-835"><a href="#ESSearch.execute-835"><span class="linenos">835</span></a>                <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span> <span class="c1"># one line is added to hashs_dic[id] for each element of result having this id</span>
</span><span id="ESSearch.execute-836"><a href="#ESSearch.execute-836"><span class="linenos">836</span></a>                    <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span> <span class="c1"># Two items with the same id should have the same metadata.</span>
</span><span id="ESSearch.execute-837"><a href="#ESSearch.execute-837"><span class="linenos">837</span></a>                    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]:</span>
</span><span id="ESSearch.execute-838"><a href="#ESSearch.execute-838"><span class="linenos">838</span></a>                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch.execute-839"><a href="#ESSearch.execute-839"><span class="linenos">839</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch.execute-840"><a href="#ESSearch.execute-840"><span class="linenos">840</span></a>                    <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span><span id="ESSearch.execute-841"><a href="#ESSearch.execute-841"><span class="linenos">841</span></a>                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]:</span>
</span><span id="ESSearch.execute-842"><a href="#ESSearch.execute-842"><span class="linenos">842</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fillvalue</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">column_name</span><span class="p">]]</span> <span class="c1"># a filled column is added if a new column name is encountered</span>
</span><span id="ESSearch.execute-843"><a href="#ESSearch.execute-843"><span class="linenos">843</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-844"><a href="#ESSearch.execute-844"><span class="linenos">844</span></a>                            <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;idxdic&#39;</span><span class="p">][</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">column_name</span><span class="p">])</span>
</span><span id="ESSearch.execute-845"><a href="#ESSearch.execute-845"><span class="linenos">845</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-846"><a href="#ESSearch.execute-846"><span class="linenos">846</span></a>                    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ESSearch.execute-847"><a href="#ESSearch.execute-847"><span class="linenos">847</span></a>                    <span class="k">if</span> <span class="s1">&#39;name&#39;</span>  <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-848"><a href="#ESSearch.execute-848"><span class="linenos">848</span></a>                    <span class="k">if</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]:</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">][</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-849"><a href="#ESSearch.execute-849"><span class="linenos">849</span></a>                    <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
</span><span id="ESSearch.execute-850"><a href="#ESSearch.execute-850"><span class="linenos">850</span></a>                    <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;idxdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">}</span>
</span><span id="ESSearch.execute-851"><a href="#ESSearch.execute-851"><span class="linenos">851</span></a>                    <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dic</span>
</span><span id="ESSearch.execute-852"><a href="#ESSearch.execute-852"><span class="linenos">852</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch.execute-853"><a href="#ESSearch.execute-853"><span class="linenos">853</span></a>            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span> <span class="c1"># an Observation is added to result for each id</span>
</span><span id="ESSearch.execute-854"><a href="#ESSearch.execute-854"><span class="linenos">854</span></a>                <span class="n">obs_out</span> <span class="o">=</span> <span class="n">Observation</span><span class="o">.</span><span class="n">dic</span><span class="p">(</span><span class="o">**</span><span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
</span><span id="ESSearch.execute-855"><a href="#ESSearch.execute-855"><span class="linenos">855</span></a>                <span class="k">if</span> <span class="n">obs_out</span><span class="p">:</span>
</span><span id="ESSearch.execute-856"><a href="#ESSearch.execute-856"><span class="linenos">856</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filtered</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">obs_out</span><span class="p">))</span> <span class="c1"># finalement, semble plus pertinent de faire ce filtrage directemt sur la sortie Mongo, car mme si un  un les tests de condition sont faits  de nombreuses reprises, au global ce ne sont jamais les mmes combinaisons de test</span>
</span><span id="ESSearch.execute-857"><a href="#ESSearch.execute-857"><span class="linenos">857</span></a>                    <span class="k">else</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_out</span><span class="p">)</span>
</span><span id="ESSearch.execute-858"><a href="#ESSearch.execute-858"><span class="linenos">858</span></a>        <span class="c1"># At this point, result is a list of observations.</span>
</span><span id="ESSearch.execute-859"><a href="#ESSearch.execute-859"><span class="linenos">859</span></a>
</span><span id="ESSearch.execute-860"><a href="#ESSearch.execute-860"><span class="linenos">860</span></a>        <span class="c1">## ESSearch.execute() 3: Other inputs (pure observations) are treated purely in python with the self._filtered_observation() method</span>
</span><span id="ESSearch.execute-861"><a href="#ESSearch.execute-861"><span class="linenos">861</span></a>
</span><span id="ESSearch.execute-862"><a href="#ESSearch.execute-862"><span class="linenos">862</span></a>        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># data which are not taken from a Mongo database and already are observations are treated here.</span>
</span><span id="ESSearch.execute-863"><a href="#ESSearch.execute-863"><span class="linenos">863</span></a>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filtered_observation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</span><span id="ESSearch.execute-864"><a href="#ESSearch.execute-864"><span class="linenos">864</span></a>
</span><span id="ESSearch.execute-865"><a href="#ESSearch.execute-865"><span class="linenos">865</span></a>        <span class="c1">## ESSearch.execute() 4: Operations for cases &#39;idfused&#39; and &#39;single&#39; are performed again with the added observations</span>
</span><span id="ESSearch.execute-866"><a href="#ESSearch.execute-866"><span class="linenos">866</span></a>
</span><span id="ESSearch.execute-867"><a href="#ESSearch.execute-867"><span class="linenos">867</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch.execute-868"><a href="#ESSearch.execute-868"><span class="linenos">868</span></a>            <span class="k">if</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
</span><span id="ESSearch.execute-869"><a href="#ESSearch.execute-869"><span class="linenos">869</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fusion</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch.execute-870"><a href="#ESSearch.execute-870"><span class="linenos">870</span></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ESSearch query result on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="c1"># default value for name</span>
</span><span id="ESSearch.execute-871"><a href="#ESSearch.execute-871"><span class="linenos">871</span></a>                <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># default value for param</span>
</span><span id="ESSearch.execute-872"><a href="#ESSearch.execute-872"><span class="linenos">872</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch.execute-873"><a href="#ESSearch.execute-873"><span class="linenos">873</span></a>                        <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
</span><span id="ESSearch.execute-874"><a href="#ESSearch.execute-874"><span class="linenos">874</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-875"><a href="#ESSearch.execute-875"><span class="linenos">875</span></a>                        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch.execute-876"><a href="#ESSearch.execute-876"><span class="linenos">876</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">:</span> <span class="c1"># informations about the inputs are added to param</span>
</span><span id="ESSearch.execute-877"><a href="#ESSearch.execute-877"><span class="linenos">877</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Observation</span><span class="p">):</span>
</span><span id="ESSearch.execute-878"><a href="#ESSearch.execute-878"><span class="linenos">878</span></a>                                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ESSearch.execute-879"><a href="#ESSearch.execute-879"><span class="linenos">879</span></a>                                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Observation: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch.execute-880"><a href="#ESSearch.execute-880"><span class="linenos">880</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-881"><a href="#ESSearch.execute-881"><span class="linenos">881</span></a>                                    <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</span><span id="ESSearch.execute-882"><a href="#ESSearch.execute-882"><span class="linenos">882</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
</span><span id="ESSearch.execute-883"><a href="#ESSearch.execute-883"><span class="linenos">883</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MongoDB collection: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch.execute-884"><a href="#ESSearch.execute-884"><span class="linenos">884</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">):</span>
</span><span id="ESSearch.execute-885"><a href="#ESSearch.execute-885"><span class="linenos">885</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pymongo cursor: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">+</span> <span class="s1">&#39; from collection &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> 
</span><span id="ESSearch.execute-886"><a href="#ESSearch.execute-886"><span class="linenos">886</span></a>                                                <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch.execute-887"><a href="#ESSearch.execute-887"><span class="linenos">887</span></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">CommandCursor</span><span class="p">):</span>
</span><span id="ESSearch.execute-888"><a href="#ESSearch.execute-888"><span class="linenos">888</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Pymongo commandcursor: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">cursor_id</span> <span class="o">+</span> <span class="s1">&#39; from collection &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> 
</span><span id="ESSearch.execute-889"><a href="#ESSearch.execute-889"><span class="linenos">889</span></a>                                                <span class="s1">&#39; from database: &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="ESSearch.execute-890"><a href="#ESSearch.execute-890"><span class="linenos">890</span></a>                            <span class="k">else</span><span class="p">:</span> <span class="c1"># should not happen</span>
</span><span id="ESSearch.execute-891"><a href="#ESSearch.execute-891"><span class="linenos">891</span></a>                                <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
</span><span id="ESSearch.execute-892"><a href="#ESSearch.execute-892"><span class="linenos">892</span></a>                    <span class="n">param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span> <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="s1">&#39;essearch&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dim3&#39;</span><span class="p">,</span> 
</span><span id="ESSearch.execute-893"><a href="#ESSearch.execute-893"><span class="linenos">893</span></a>                            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;ESSearch query&#39;</span><span class="p">,</span> <span class="s1">&#39;sources &#39;</span><span class="p">:</span> <span class="n">sources</span><span class="p">,</span> 
</span><span id="ESSearch.execute-894"><a href="#ESSearch.execute-894"><span class="linenos">894</span></a>                            <span class="s1">&#39;ESSearch_parameters&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)}}</span>
</span><span id="ESSearch.execute-895"><a href="#ESSearch.execute-895"><span class="linenos">895</span></a>                <span class="n">result</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
</span><span id="ESSearch.execute-896"><a href="#ESSearch.execute-896"><span class="linenos">896</span></a>
</span><span id="ESSearch.execute-897"><a href="#ESSearch.execute-897"><span class="linenos">897</span></a>            <span class="k">elif</span> <span class="n">returnmode</span> <span class="o">==</span> <span class="s1">&#39;idfused&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ESSearch.execute-898"><a href="#ESSearch.execute-898"><span class="linenos">898</span></a>                <span class="n">hashs_dic</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># This dictionnary is in the format {id: [observations]}</span>
</span><span id="ESSearch.execute-899"><a href="#ESSearch.execute-899"><span class="linenos">899</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="ESSearch.execute-900"><a href="#ESSearch.execute-900"><span class="linenos">900</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span>
</span><span id="ESSearch.execute-901"><a href="#ESSearch.execute-901"><span class="linenos">901</span></a>                        <span class="n">hashs_dic</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="ESSearch.execute-902"><a href="#ESSearch.execute-902"><span class="linenos">902</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="ESSearch.execute-903"><a href="#ESSearch.execute-903"><span class="linenos">903</span></a>                        <span class="n">hashs_dic</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="ESSearch.execute-904"><a href="#ESSearch.execute-904"><span class="linenos">904</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ESSearch.execute-905"><a href="#ESSearch.execute-905"><span class="linenos">905</span></a>                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">hashs_dic</span><span class="p">:</span>
</span><span id="ESSearch.execute-906"><a href="#ESSearch.execute-906"><span class="linenos">906</span></a>                    <span class="n">obs_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fusion</span><span class="p">(</span><span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">fillvalue</span><span class="p">)</span>
</span><span id="ESSearch.execute-907"><a href="#ESSearch.execute-907"><span class="linenos">907</span></a>                    <span class="k">if</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="n">obs_out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="c1"># name and param associated to the id are put back</span>
</span><span id="ESSearch.execute-908"><a href="#ESSearch.execute-908"><span class="linenos">908</span></a>                    <span class="k">if</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param</span><span class="p">:</span> <span class="n">obs_out</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">hashs_dic</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">param</span>
</span><span id="ESSearch.execute-909"><a href="#ESSearch.execute-909"><span class="linenos">909</span></a>                    <span class="k">if</span> <span class="n">obs_out</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_out</span><span class="p">)</span>
</span><span id="ESSearch.execute-910"><a href="#ESSearch.execute-910"><span class="linenos">910</span></a>
</span><span id="ESSearch.execute-911"><a href="#ESSearch.execute-911"><span class="linenos">911</span></a>        <span class="c1">## ESSearch.execute() 5: Return result</span>
</span><span id="ESSearch.execute-912"><a href="#ESSearch.execute-912"><span class="linenos">912</span></a>
</span><span id="ESSearch.execute-913"><a href="#ESSearch.execute-913"><span class="linenos">913</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Executes the request and returns its result, either in one or many Observations.</p>

<p><em>Parameter</em></p>

<ul>
<li><strong>returnmode</strong> : str (default None) - Parameter giving the format of the output:
<ul>
<li>'unchanged' : output is returned as it is in the database, some operations like operations sepcific to TimeSlot object are not performed;</li>
<li>'observation': Each element is returned as an observation, but original observations aren't recreated;</li>
<li>'idfused': observations whose ids are the same are merged together; </li>
<li>'single': return a single observation merging all observations together.</li>
</ul></li>
<li><strong>fillvalue</strong> :  (default None) - Value to use to fill gaps when observations are merged together.</li>
<li><strong>name</strong> : str (default None) - name of the output observation when returnmode is 'single'.</li>
<li><strong>param</strong> : dict (default None) - param of the output observation when returnmode is 'single'.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>